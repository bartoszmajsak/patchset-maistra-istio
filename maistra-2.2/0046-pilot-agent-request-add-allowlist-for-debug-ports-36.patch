From 44832a4834e1b90169b9c7aacb81a93a20727524 Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Fri, 12 Nov 2021 10:48:22 -0800
Subject: pilot-agent request: add allowlist for debug ports (#36031)

Co-authored-by: John Howard <howardjohn@google.com>
---
 pilot/cmd/pilot-agent/request.go | 27 ++++++++++++++++++++++++++-
 1 file changed, 26 insertions(+), 1 deletion(-)

diff --git a/pilot/cmd/pilot-agent/request.go b/pilot/cmd/pilot-agent/request.go
index baf99a8beb..f42b61e816 100644
--- a/pilot/cmd/pilot-agent/request.go
+++ b/pilot/cmd/pilot-agent/request.go
@@ -17,6 +17,8 @@
 import (
 	"fmt"
 	"net/http"
+	"sort"
+	"strings"
 	"time"
 
 	"github.com/spf13/cobra"
@@ -24,7 +26,24 @@
 	"istio.io/istio/pilot/pkg/request"
 )
 
-var debugRequestPort int32 = 15000
+var (
+	debugRequestPort int32 = 15000
+	allowedPorts           = map[int32]struct{}{
+		15000: {},
+		15021: {},
+		15020: {},
+		15004: {},
+	}
+)
+
+var allowedPortsString = func() string {
+	s := []string{}
+	for k := range allowedPorts {
+		s = append(s, fmt.Sprint(k))
+	}
+	sort.Strings(s)
+	return strings.Join(s, ", ")
+}()
 
 // NB: extra standard output in addition to what's returned from envoy
 // must not be added in this command. Otherwise, it'd break istioctl proxy-config,
@@ -34,6 +53,12 @@
 		Use:   "request <method> <path> [<body>]",
 		Short: "Makes an HTTP request to the Envoy admin API",
 		Args:  cobra.MinimumNArgs(2),
+		PreRunE: func(cmd *cobra.Command, args []string) error {
+			if _, f := allowedPorts[debugRequestPort]; !f {
+				return fmt.Errorf("debug port %d is not in allowed list %v", debugRequestPort, allowedPortsString)
+			}
+			return nil
+		},
 		RunE: func(c *cobra.Command, args []string) error {
 			command := &request.Command{
 				Address: fmt.Sprintf("localhost:%d", debugRequestPort),
-- 
2.35.3

