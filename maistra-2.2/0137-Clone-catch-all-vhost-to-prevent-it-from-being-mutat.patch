From 7452fa8ec7a2ec716fcaa08a67d5dad1c7699ec0 Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Tue, 1 Mar 2022 05:31:39 -0800
Subject: Clone catch all vhost to prevent it from being mutated (#37613)

Co-authored-by: Zhonghu Xu <xuzhonghu@huawei.com>
---
 pilot/pkg/networking/core/v1alpha3/httproute.go | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/pilot/pkg/networking/core/v1alpha3/httproute.go b/pilot/pkg/networking/core/v1alpha3/httproute.go
index 9a9f2f38cb..01952b1f80 100644
--- a/pilot/pkg/networking/core/v1alpha3/httproute.go
+++ b/pilot/pkg/networking/core/v1alpha3/httproute.go
@@ -22,6 +22,7 @@
 
 	route "github.com/envoyproxy/go-control-plane/envoy/config/route/v3"
 	discovery "github.com/envoyproxy/go-control-plane/envoy/service/discovery/v3"
+	protobuf "google.golang.org/protobuf/proto"
 
 	networking "istio.io/api/networking/v1alpha3"
 	"istio.io/istio/pilot/pkg/features"
@@ -174,7 +175,7 @@ func (configgen *ConfigGeneratorImpl) buildSidecarOutboundHTTPRouteConfig(
 		if resource != nil {
 			return resource, true
 		}
-		if listenerPort > 0 {
+		if useSniffing && listenerPort > 0 {
 			// only cache for tcp ports and not for uds
 			vHostCache[listenerPort] = virtualHosts
 		}
@@ -190,7 +191,9 @@ func (configgen *ConfigGeneratorImpl) buildSidecarOutboundHTTPRouteConfig(
 	util.SortVirtualHosts(virtualHosts)
 
 	if !useSniffing {
-		virtualHosts = append(virtualHosts, node.CatchAllVirtualHost)
+		// virtualhost envoyfilter can mutate this sharing config.
+		catchAll := protobuf.Clone(node.CatchAllVirtualHost).(*route.VirtualHost)
+		virtualHosts = append(virtualHosts, catchAll)
 	}
 
 	out := &route.RouteConfiguration{
-- 
2.35.3

