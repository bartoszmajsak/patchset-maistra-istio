From 6c8058db528fe0182e7641827e3511879a1e6b91 Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Wed, 16 Feb 2022 09:30:14 -0800
Subject: Add warning when setting certs with PASSTHROUGH mode (#37359)

Co-authored-by: John Howard <howardjohn@google.com>
---
 pkg/config/validation/validation.go      | 8 +++++++-
 pkg/config/validation/validation_test.go | 2 +-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/pkg/config/validation/validation.go b/pkg/config/validation/validation.go
index f79d3c4285..f1295241f0 100644
--- a/pkg/config/validation/validation.go
+++ b/pkg/config/validation/validation.go
@@ -602,10 +602,16 @@ func validateTLSOptions(tls *networking.ServerTLSSettings) (v Validation) {
 				v = appendValidation(v, fmt.Errorf("ISTIO_MUTUAL TLS cannot have associated credentialName"))
 			}
 		}
-
 		return
 	}
 
+	if tls.Mode == networking.ServerTLSSettings_PASSTHROUGH || tls.Mode == networking.ServerTLSSettings_AUTO_PASSTHROUGH {
+		if tls.ServerCertificate != "" || tls.PrivateKey != "" || tls.CaCertificates != "" || tls.CredentialName != "" {
+			// Warn for backwards compatibility
+			v = appendWarningf(v, "%v mode does not use certificates, they will be ignored", tls.Mode)
+		}
+	}
+
 	if (tls.Mode == networking.ServerTLSSettings_SIMPLE || tls.Mode == networking.ServerTLSSettings_MUTUAL) && tls.CredentialName != "" {
 		// If tls mode is SIMPLE or MUTUAL, and CredentialName is specified, credentials are fetched
 		// remotely. ServerCertificate and CaCertificates fields are not required.
diff --git a/pkg/config/validation/validation_test.go b/pkg/config/validation/validation_test.go
index 43e7c53c0b..d82fb6b5a9 100644
--- a/pkg/config/validation/validation_test.go
+++ b/pkg/config/validation/validation_test.go
@@ -1327,7 +1327,7 @@ func TestValidateTlsOptions(t *testing.T) {
 				CaCertificates:    "",
 				CredentialName:    "sds-name",
 			},
-			"", "",
+			"", "PASSTHROUGH mode does not use certificates",
 		},
 		{
 			"istio_mutual no certs",
-- 
2.35.3

