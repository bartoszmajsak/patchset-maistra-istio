From 0000f4bfab59c582f3e093b4b650dad214170896 Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Mon, 29 Nov 2021 08:31:09 -0800
Subject: Make istiod deployment respect nodeSelector (#36227)

Co-authored-by: Kebe <kebe.liu@daocloud.io>
---
 .../istio-discovery/templates/deployment.yaml             | 4 ++++
 .../manifest-generate/input/pilot_override_values.yaml    | 2 ++
 .../output/pilot_override_values.golden.yaml              | 2 ++
 releasenotes/notes/36110.yaml                             | 8 ++++++++
 4 files changed, 16 insertions(+)
 create mode 100644 releasenotes/notes/36110.yaml

diff --git a/manifests/charts/istio-control/istio-discovery/templates/deployment.yaml b/manifests/charts/istio-control/istio-discovery/templates/deployment.yaml
index c64660cac5..434d102b42 100644
--- a/manifests/charts/istio-control/istio-discovery/templates/deployment.yaml
+++ b/manifests/charts/istio-control/istio-discovery/templates/deployment.yaml
@@ -57,6 +57,10 @@ spec:
 {{ toYaml .Values.pilot.podAnnotations | indent 8 }}
         {{- end }}
     spec:
+{{- if .Values.pilot.nodeSelector }}
+      nodeSelector:
+{{ toYaml .Values.pilot.nodeSelector | indent 8 }}
+{{- end }}
       serviceAccountName: istiod{{- if not (eq .Values.revision "") }}-{{ .Values.revision }}{{- end }}
 {{- if .Values.global.priorityClassName }}
       priorityClassName: "{{ .Values.global.priorityClassName }}"
diff --git a/operator/cmd/mesh/testdata/manifest-generate/input/pilot_override_values.yaml b/operator/cmd/mesh/testdata/manifest-generate/input/pilot_override_values.yaml
index 2c11de54b6..4c9397e59e 100644
--- a/operator/cmd/mesh/testdata/manifest-generate/input/pilot_override_values.yaml
+++ b/operator/cmd/mesh/testdata/manifest-generate/input/pilot_override_values.yaml
@@ -19,5 +19,7 @@ spec:
       autoscaleMax: 8
       autoscaleMin: 2
       rollingMaxUnavailable: 30%
+      nodeSelector:
+        node-name: test
   unvalidatedValues:
       myCustomKey: someValue
diff --git a/operator/cmd/mesh/testdata/manifest-generate/output/pilot_override_values.golden.yaml b/operator/cmd/mesh/testdata/manifest-generate/output/pilot_override_values.golden.yaml
index 785e1bd936..31c64f18ad 100644
--- a/operator/cmd/mesh/testdata/manifest-generate/output/pilot_override_values.golden.yaml
+++ b/operator/cmd/mesh/testdata/manifest-generate/output/pilot_override_values.golden.yaml
@@ -116,6 +116,8 @@ spec:
         - mountPath: /var/run/secrets/remote
           name: istio-kubeconfig
           readOnly: true
+      nodeSelector:
+        node-name: test
       securityContext:
         fsGroup: 1337
       serviceAccountName: istiod
diff --git a/releasenotes/notes/36110.yaml b/releasenotes/notes/36110.yaml
new file mode 100644
index 0000000000..ba234aa28b
--- /dev/null
+++ b/releasenotes/notes/36110.yaml
@@ -0,0 +1,8 @@
+apiVersion: release-notes/v2
+kind: feature
+area: installation
+issue:
+  - 36110
+releaseNotes:
+  - |
+    **Added** istiod deployment respect `values.pilot.nodeSelector`.
-- 
2.35.3

