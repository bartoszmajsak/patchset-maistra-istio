From 843aec4a754104315cb8e410f620a62ed2cc266b Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Thu, 27 Jan 2022 10:10:32 -0800
Subject: [release-1.12] Fix: correct error format after json marshal (#37029)

* Fix: correct error format after json marshal

* add releasenotes

Co-authored-by: whalecold <zls1129@gmail.com>
---
 istioctl/cmd/workload.go                      | 17 +++++++++----
 istioctl/cmd/workload_test.go                 | 25 +++++++++++++++++++
 .../correct-virtualmachine-config-format.yaml | 15 +++++++++++
 3 files changed, 52 insertions(+), 5 deletions(-)
 create mode 100644 releasenotes/notes/correct-virtualmachine-config-format.yaml

diff --git a/istioctl/cmd/workload.go b/istioctl/cmd/workload.go
index 4c75d43d40..47b3ce35c3 100644
--- a/istioctl/cmd/workload.go
+++ b/istioctl/cmd/workload.go
@@ -501,8 +501,8 @@ func createMeshConfig(kubeClient kube.ExtendedClient, wg *clientv1alpha3.Workloa
 	md["ISTIO_META_CLUSTER_ID"] = clusterID
 	md["ISTIO_META_MESH_ID"] = meshConfig.DefaultConfig.MeshId
 	md["ISTIO_META_NETWORK"] = we.Network
-	if portsJSON, err := json.Marshal(workloadEntryToPodPortsMeta(we.Ports)); err == nil {
-		md["ISTIO_META_POD_PORTS"] = string(portsJSON)
+	if portsStr := marshalWorkloadEntryPodPorts(we.Ports); portsStr != "" {
+		md["ISTIO_META_POD_PORTS"] = portsStr
 	}
 	md["ISTIO_META_WORKLOAD_NAME"] = wg.Name
 	labels[label.ServiceCanonicalName.Name] = md["CANONICAL_SERVICE"]
@@ -532,12 +532,19 @@ func createMeshConfig(kubeClient kube.ExtendedClient, wg *clientv1alpha3.Workloa
 	return meshConfig.DefaultConfig, os.WriteFile(filepath.Join(dir, "mesh.yaml"), proxyYAML, filePerms)
 }
 
-func workloadEntryToPodPortsMeta(p map[string]uint32) model.PodPortList {
-	var out model.PodPortList
+func marshalWorkloadEntryPodPorts(p map[string]uint32) string {
+	var out []model.PodPort
 	for name, port := range p {
 		out = append(out, model.PodPort{Name: name, ContainerPort: int(port)})
 	}
-	return out
+	if len(out) == 0 {
+		return ""
+	}
+	str, err := json.Marshal(out)
+	if err != nil {
+		return ""
+	}
+	return string(str)
 }
 
 // Retrieves the external IP of the ingress-gateway for the hosts file additions
diff --git a/istioctl/cmd/workload_test.go b/istioctl/cmd/workload_test.go
index b1ab7f39e7..e275f8dc89 100644
--- a/istioctl/cmd/workload_test.go
+++ b/istioctl/cmd/workload_test.go
@@ -231,6 +231,31 @@ func TestWorkloadEntryConfigure(t *testing.T) {
 	}
 }
 
+func TestWorkloadEntryToPodPortsMeta(t *testing.T) {
+	cases := []struct {
+		description string
+		ports       map[string]uint32
+		want        string
+	}{
+		{
+			description: "test json marshal",
+			ports: map[string]uint32{
+				"HTTP":  80,
+				"HTTPS": 443,
+			},
+			want: `[{"name":"HTTP","containerPort":80,"protocol":""},{"name":"HTTPS","containerPort":443,"protocol":""}]`,
+		},
+	}
+	for i, c := range cases {
+		t.Run(fmt.Sprintf("case %d %s", i, c.description), func(t *testing.T) {
+			str := marshalWorkloadEntryPodPorts(c.ports)
+			if c.want != str {
+				t.Errorf("want %s, got %s", c.want, str)
+			}
+		})
+	}
+}
+
 // TestWorkloadEntryConfigureNilProxyMetadata tests a particular use case when the
 // proxyMetadata is nil, no metadata would be generated at all.
 func TestWorkloadEntryConfigureNilProxyMetadata(t *testing.T) {
diff --git a/releasenotes/notes/correct-virtualmachine-config-format.yaml b/releasenotes/notes/correct-virtualmachine-config-format.yaml
new file mode 100644
index 0000000000..b5367af3f4
--- /dev/null
+++ b/releasenotes/notes/correct-virtualmachine-config-format.yaml
@@ -0,0 +1,15 @@
+apiVersion: release-notes/v2
+
+kind: bug-fix
+
+area: istioctl
+
+issue:
+
+- https://github.com/istio/istio/issues/36358
+
+releaseNotes:
+
+- |
+
+  **Fixed** correct error format after json marshal in virtual machine config
-- 
2.35.3

