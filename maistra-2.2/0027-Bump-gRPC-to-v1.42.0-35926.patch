From 024204ee8889788baac782300039b0f32a29825c Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Mon, 8 Nov 2021 10:42:44 -0800
Subject: Bump gRPC to v1.42.0 (#35926)

Co-authored-by: John Howard <howardjohn@google.com>
---
 go.mod                                        |  3 +--
 go.sum                                        |  4 ++--
 pilot/pkg/networking/grpcgen/grpcecho_test.go |  7 +------
 pilot/pkg/networking/grpcgen/lds.go           | 16 ++++++++++++++++
 4 files changed, 20 insertions(+), 10 deletions(-)

diff --git a/go.mod b/go.mod
index 8f795ea67a..da3c9a5cd8 100644
--- a/go.mod
+++ b/go.mod
@@ -25,7 +25,6 @@ require (
 	github.com/cenkalti/backoff/v4 v4.1.1
 	github.com/census-instrumentation/opencensus-proto v0.3.0
 	github.com/cheggaaa/pb/v3 v3.0.8
-	github.com/cncf/udpa/go v0.0.0-20210930031921-04548b0d99d4 // indirect
 	github.com/cncf/xds/go v0.0.0-20211011173535-cb28da3451f1
 	github.com/containernetworking/cni v1.0.1
 	github.com/containernetworking/plugins v1.0.1
@@ -85,7 +84,7 @@ require (
 	gomodules.xyz/jsonpatch/v3 v3.0.1
 	google.golang.org/api v0.59.0
 	google.golang.org/genproto v0.0.0-20211020151524-b7c3a969101a
-	google.golang.org/grpc v1.42.0-dev.0.20211015201449-4757d0249e2d
+	google.golang.org/grpc v1.42.0
 	google.golang.org/protobuf v1.27.1
 	gopkg.in/square/go-jose.v2 v2.6.0
 	gopkg.in/yaml.v2 v2.4.0
diff --git a/go.sum b/go.sum
index 9a20f80330..6204eb8701 100644
--- a/go.sum
+++ b/go.sum
@@ -1831,8 +1831,8 @@ google.golang.org/grpc v1.38.0/go.mod h1:NREThFqKR1f3iQ6oBuvc5LadQuXVGo9rkm5ZGrQ
 google.golang.org/grpc v1.39.0/go.mod h1:PImNr+rS9TWYb2O4/emRugxiyHZ5JyHW5F+RPnDzfrE=
 google.golang.org/grpc v1.39.1/go.mod h1:PImNr+rS9TWYb2O4/emRugxiyHZ5JyHW5F+RPnDzfrE=
 google.golang.org/grpc v1.40.0/go.mod h1:ogyxbiOoUXAkP+4+xa6PZSE9DZgIHtSpzjDTB9KAK34=
-google.golang.org/grpc v1.42.0-dev.0.20211015201449-4757d0249e2d h1:feg9d8XiqCDr+lhZly4rL5mxFotDEar0C5ZngpoS75k=
-google.golang.org/grpc v1.42.0-dev.0.20211015201449-4757d0249e2d/go.mod h1:sn+iQXCsAt+4abOFPwaqlptD9wTLjn4HDXw+aU/Qfpk=
+google.golang.org/grpc v1.42.0 h1:XT2/MFpuPFsEX2fWh3YQtHkZ+WYZFQRfaUgLZYj/p6A=
+google.golang.org/grpc v1.42.0/go.mod h1:k+4IHHFw41K8+bbowsex27ge2rCb65oeWqe4jJ590SU=
 google.golang.org/grpc/cmd/protoc-gen-go-grpc v1.1.0/go.mod h1:6Kw0yEErY5E/yWrBtf03jp27GLLJujG4z/JK95pnjjw=
 google.golang.org/protobuf v0.0.0-20200109180630-ec00e32a8dfd/go.mod h1:DFci5gLYBciE7Vtevhsrf46CRTquxDuWsQurQQe4oz8=
 google.golang.org/protobuf v0.0.0-20200221191635-4d8936d0db64/go.mod h1:kwYJMbMJ01Woi6D6+Kah6886xMZcty6N08ah7+eCXa0=
diff --git a/pilot/pkg/networking/grpcgen/grpcecho_test.go b/pilot/pkg/networking/grpcgen/grpcecho_test.go
index 28aae60002..4f5ef0f243 100644
--- a/pilot/pkg/networking/grpcgen/grpcecho_test.go
+++ b/pilot/pkg/networking/grpcgen/grpcecho_test.go
@@ -19,9 +19,7 @@
 	"fmt"
 	"math"
 	"net"
-	"os"
 	"runtime"
-	"strings"
 	"sync"
 	"testing"
 	"time"
@@ -235,10 +233,7 @@ func TestTrafficShifting(t *testing.T) {
 }
 
 func TestMtls(t *testing.T) {
-	// TODO this is eagerly resolved in gRPC making it difficult to force with os.Setenv
-	if !strings.EqualFold(os.Getenv("GRPC_XDS_EXPERIMENTAL_SECURITY_SUPPORT"), "true") {
-		t.Skip("Must set GRPC_XDS_EXPERIMENTAL_SECURITY_SUPPORT outside the test")
-	}
+	t.Skip("https://github.com/istio/istio/issues/35843")
 	tt := newConfigGenTest(t, xds.FakeOptions{
 		KubernetesObjectString: `
 apiVersion: v1
diff --git a/pilot/pkg/networking/grpcgen/lds.go b/pilot/pkg/networking/grpcgen/lds.go
index 86bce2e7a6..e9a7e39bd7 100644
--- a/pilot/pkg/networking/grpcgen/lds.go
+++ b/pilot/pkg/networking/grpcgen/lds.go
@@ -22,6 +22,7 @@
 
 	core "github.com/envoyproxy/go-control-plane/envoy/config/core/v3"
 	listener "github.com/envoyproxy/go-control-plane/envoy/config/listener/v3"
+	route "github.com/envoyproxy/go-control-plane/envoy/config/route/v3"
 	hcm "github.com/envoyproxy/go-control-plane/envoy/extensions/filters/network/http_connection_manager/v3"
 	tls "github.com/envoyproxy/go-control-plane/envoy/extensions/transport_sockets/tls/v3"
 	discovery "github.com/envoyproxy/go-control-plane/envoy/service/discovery/v3"
@@ -153,6 +154,21 @@ func buildFilterChain(nameSuffix string, tlsContext *tls.DownstreamTlsContext) *
 			Name: "inbound-hcm" + nameSuffix,
 			ConfigType: &listener.Filter_TypedConfig{
 				TypedConfig: util.MessageToAny(&hcm.HttpConnectionManager{
+					RouteSpecifier: &hcm.HttpConnectionManager_RouteConfig{
+						// https://github.com/grpc/grpc-go/issues/4924
+						RouteConfig: &route.RouteConfiguration{
+							Name: "inbound",
+							VirtualHosts: []*route.VirtualHost{{
+								Domains: []string{"*"},
+								Routes: []*route.Route{{
+									Match: &route.RouteMatch{
+										PathSpecifier: &route.RouteMatch_Prefix{Prefix: "/"},
+									},
+									Action: &route.Route_NonForwardingAction{},
+								}},
+							}},
+						},
+					},
 					HttpFilters: []*hcm.HttpFilter{xdsfilters.Router},
 				}),
 			},
-- 
2.35.3

