From 58cf0a843060c90e08661a6bf7348a2b1740a32b Mon Sep 17 00:00:00 2001
From: jacob-delgado <jacob.delgado@volunteers.acasi.info>
Date: Wed, 8 Dec 2021 16:22:11 -0700
Subject: Run update_deps; migrate to use crane (#36436)

Remove istio.io/pkg/probe reference
Get rid of ProbeCheckInterval
Fix linting issue
---
 bin/update_deps.sh           |  6 ++++--
 docker/Dockerfile.distroless |  2 +-
 go.mod                       |  4 ++--
 go.sum                       | 11 ++++-------
 prow/release-commit.sh       |  2 +-
 security/pkg/pki/ca/ca.go    |  7 -------
 6 files changed, 12 insertions(+), 20 deletions(-)

diff --git a/bin/update_deps.sh b/bin/update_deps.sh
index b32317e035..8fd355b1e9 100755
--- a/bin/update_deps.sh
+++ b/bin/update_deps.sh
@@ -47,8 +47,10 @@ go mod tidy
 sed -i "s/^BUILDER_SHA=.*\$/BUILDER_SHA=$(getSha release-builder)/" prow/release-commit.sh
 sed -i '/PROXY_REPO_SHA/,/lastStableSHA/ { s/"lastStableSHA":.*/"lastStableSHA": "'"$(getSha proxy)"'"/  }' istio.deps
 
-LATEST_DEB11_DISTROLESS_SHA256=$(docker image pull gcr.io/distroless/static-debian11 | grep Digest | awk -F\\: '{print $3}')
+# shellcheck disable=SC1001
+LATEST_DEB11_DISTROLESS_SHA256=$(crane digest gcr.io/distroless/static-debian11 | awk -F\: '{print $2}')
 sed -i -E "s/sha256:[a-z0-9]+/sha256:${LATEST_DEB11_DISTROLESS_SHA256}/g" docker/Dockerfile.distroless
 
-LATEST_IPTABLES_DISTROLESS_SHA256=$(docker image pull gcr.io/istio-release/iptables | grep Digest | awk -F\\: '{print $3}')
+# shellcheck disable=SC1001
+LATEST_IPTABLES_DISTROLESS_SHA256=$(crane digest gcr.io/istio-release/iptables | awk -F\: '{print $2}')
 sed -i -E "s/sha256:[a-z0-9]+/sha256:${LATEST_IPTABLES_DISTROLESS_SHA256}/g" pilot/docker/Dockerfile.proxyv2
diff --git a/docker/Dockerfile.distroless b/docker/Dockerfile.distroless
index 008da4604b..5325db37c3 100644
--- a/docker/Dockerfile.distroless
+++ b/docker/Dockerfile.distroless
@@ -1,5 +1,5 @@
 # prepare a distroless source context to copy files from
-FROM gcr.io/distroless/static-debian11@sha256:1061399c202961ab567994c1bd42327bccd6380a345dcf88bf9ad7d5c8e29571 as distroless_source
+FROM gcr.io/distroless/static-debian11@sha256:1cc74da80bbf80d89c94e0c7fe22830aa617f47643f2db73f66c8bd5bf510b25 as distroless_source
 
 # prepare a base dev to modify file contents
 FROM ubuntu:focal as ubuntu_source
diff --git a/go.mod b/go.mod
index d1c047bcd9..4ed048d242 100644
--- a/go.mod
+++ b/go.mod
@@ -91,8 +91,8 @@ require (
 	gopkg.in/yaml.v3 v3.0.0-20210107192922-496545a6307b
 	helm.sh/helm/v3 v3.7.1
 	istio.io/api v0.0.0-20211208194311-3a1ff8c5e8b0
-	istio.io/client-go v1.12.0-alpha.5.0.20211208181448-4a75f8907e8e
-	istio.io/pkg v0.0.0-20211123161558-1e5d0c4ee827
+	istio.io/client-go v1.12.0-alpha.5.0.20211208194816-5819817ac555
+	istio.io/pkg v0.0.0-20211208181334-1db9fc84b3bc
 	k8s.io/api v0.22.4
 	k8s.io/apiextensions-apiserver v0.22.4
 	k8s.io/apimachinery v0.22.4
diff --git a/go.sum b/go.sum
index 629c237f7d..7b6a4a114d 100644
--- a/go.sum
+++ b/go.sum
@@ -567,7 +567,6 @@ github.com/gogo/protobuf v1.3.2/go.mod h1:P1XiOD3dCwIKUDQYPy72D8LYyHL2YPYrpS2s69
 github.com/golang-jwt/jwt/v4 v4.0.0 h1:RAqyYixv1p7uEnocuy8P1nru5wprCh/MH2BIlW5z5/o=
 github.com/golang-jwt/jwt/v4 v4.0.0/go.mod h1:/xlHOz8bRuivTWchD4jCa+NbatV+wEUSzwAxVc6locg=
 github.com/golang-sql/civil v0.0.0-20190719163853-cb61b32ac6fe/go.mod h1:8vg3r2VgvsThLBIFL93Qb5yWzgyZWhEmBwUJWevAkK0=
-github.com/golang/glog v0.0.0-20160126235308-23def4e6c14b h1:VKtxabqXZkF25pY9ekfRL6a582T4P37/31XEstQ5p58=
 github.com/golang/glog v0.0.0-20160126235308-23def4e6c14b/go.mod h1:SBH7ygxi8pfUlaOkMMuAQtPIUF8ecWP5IEl/CR7VP2Q=
 github.com/golang/groupcache v0.0.0-20160516000752-02826c3e7903/go.mod h1:cIg4eruTrX1D+g88fzRXU5OdNfaM+9IcxsU14FzY7Hc=
 github.com/golang/groupcache v0.0.0-20190129154638-5b532d6fd5ef/go.mod h1:cIg4eruTrX1D+g88fzRXU5OdNfaM+9IcxsU14FzY7Hc=
@@ -967,7 +966,6 @@ github.com/onsi/gomega v1.10.3/go.mod h1:V9xEwhxec5O8UDM77eCW8vLymOMltsqPVYWrpDs
 github.com/onsi/gomega v1.13.0/go.mod h1:lRk9szgn8TxENtWd0Tp4c3wjlRfMTMH27I+3Je41yGY=
 github.com/onsi/gomega v1.14.0/go.mod h1:cIuvLEne0aoVhAgh/O6ac0Op8WWw9H6eYCriF+tEHG0=
 github.com/onsi/gomega v1.15.0/go.mod h1:cIuvLEne0aoVhAgh/O6ac0Op8WWw9H6eYCriF+tEHG0=
-github.com/onsi/gomega v1.16.0/go.mod h1:HnhC7FXeEQY45zxNK3PPoIUhzk/80Xly9PcubAlGdZY=
 github.com/onsi/gomega v1.17.0 h1:9Luw4uT5HTjHTN8+aNcSThgH1vdXnmdJ8xIfZ4wyTRE=
 github.com/onsi/gomega v1.17.0/go.mod h1:HnhC7FXeEQY45zxNK3PPoIUhzk/80Xly9PcubAlGdZY=
 github.com/opencontainers/go-digest v0.0.0-20170106003457-a6d0ee40d420/go.mod h1:cMLVZDEM3+U2I4VmLI6N8jQYUd2OVphdqWwCJHrFt2s=
@@ -1911,16 +1909,15 @@ honnef.co/go/tools v0.0.0-20190523083050-ea95bdfd59fc/go.mod h1:rf3lG4BRIbNafJWh
 honnef.co/go/tools v0.0.1-2019.2.3/go.mod h1:a3bituU0lyd329TUQxRnasdCoJDkEUEAqEt0JzvZhAg=
 honnef.co/go/tools v0.0.1-2020.1.3/go.mod h1:X/FiERA/W4tHapMX5mGpAtMSVEeEUOyHaw9vFzvIQ3k=
 honnef.co/go/tools v0.0.1-2020.1.4/go.mod h1:X/FiERA/W4tHapMX5mGpAtMSVEeEUOyHaw9vFzvIQ3k=
-istio.io/api v0.0.0-20211208180900-e9422d138292/go.mod h1:lavaUNsnT7RGyMFNOGgV5XvOgP3fkTSZkxP/0H/ISt4=
 istio.io/api v0.0.0-20211208194311-3a1ff8c5e8b0 h1:5K08WgbqwRDs6Fcp88Ddo7jz36FEnmZCWz2mJw3XBX8=
 istio.io/api v0.0.0-20211208194311-3a1ff8c5e8b0/go.mod h1:lavaUNsnT7RGyMFNOGgV5XvOgP3fkTSZkxP/0H/ISt4=
-istio.io/client-go v1.12.0-alpha.5.0.20211208181448-4a75f8907e8e h1:n+eyMsX9dRRtFZzgUHCUMpQ9xqBdOoch1nebK1Y+zwU=
-istio.io/client-go v1.12.0-alpha.5.0.20211208181448-4a75f8907e8e/go.mod h1:h8MYjLUBZxgrLA8yfDzBt4Xim514cWH+IO8Bl7t5noY=
+istio.io/client-go v1.12.0-alpha.5.0.20211208194816-5819817ac555 h1:xL7mhBdOq2OgNSSrWVpHsEWwar3IRzeMpLHUrqAOdw8=
+istio.io/client-go v1.12.0-alpha.5.0.20211208194816-5819817ac555/go.mod h1:9VOWFmW3RugAYlsuQiZdr5Jw+kvhYGcg5RGTAXVmcmw=
 istio.io/gogo-genproto v0.0.0-20210113155706-4daf5697332f/go.mod h1:6BwTZRNbWS570wHX/uR1Wqk5e0157TofTAUMzT7N4+s=
 istio.io/gogo-genproto v0.0.0-20211208193508-5ab4acc9eb1e h1:z2WI3y55w0K3c6hmarcp5EcOiP4vVpTBXA8nYstP+cE=
 istio.io/gogo-genproto v0.0.0-20211208193508-5ab4acc9eb1e/go.mod h1:vJDAniIqryf/z///fgZqVPKJ7N2lBk7Gg8DCTB7oCfU=
-istio.io/pkg v0.0.0-20211123161558-1e5d0c4ee827 h1:vXnu0NaOFBdLpdHWa1FMw4DXhv0YSoSG3Pns3Nrn3ws=
-istio.io/pkg v0.0.0-20211123161558-1e5d0c4ee827/go.mod h1:5KixWnjXFzQxC6Zr1WbdNl8QY4h3NNGQXhUOI9z9F/A=
+istio.io/pkg v0.0.0-20211208181334-1db9fc84b3bc h1:Gc0251sYOhGIIupu/wwjWAo09dOmLaI3T7sLK+fcy7w=
+istio.io/pkg v0.0.0-20211208181334-1db9fc84b3bc/go.mod h1:7r1G5ivNr72J94vULyw/dIF6ZfXBQzqbwXHHL31vats=
 k8s.io/api v0.18.2/go.mod h1:SJCWI7OLzhZSvbY7U8zwNl9UA4o1fizoug34OV/2r78=
 k8s.io/api v0.18.3/go.mod h1:UOaMwERbqJMfeeeHc8XJKawj4P9TgDRnViIqqBeH2QA=
 k8s.io/api v0.18.4/go.mod h1:lOIQAKYgai1+vz9J7YcDZwC26Z0zQewYOGWdyIPUUQ4=
diff --git a/prow/release-commit.sh b/prow/release-commit.sh
index 84140b9c3b..e91821f61d 100755
--- a/prow/release-commit.sh
+++ b/prow/release-commit.sh
@@ -32,7 +32,7 @@ DOCKER_HUB=${DOCKER_HUB:-gcr.io/istio-testing}
 GCS_BUCKET=${GCS_BUCKET:-istio-build/dev}
 
 # Use a pinned version in case breaking changes are needed
-BUILDER_SHA=539e04c9e92eff48635e24609c26ff3ab0363c51
+BUILDER_SHA=5c13ba8b2b7c5507cd3bd6fa60856dc5c0381694
 
 # Reference to the next minor version of Istio
 # This will create a version like 1.4-alpha.sha
diff --git a/security/pkg/pki/ca/ca.go b/security/pkg/pki/ca/ca.go
index 6bac2d48d3..7a312c1db3 100644
--- a/security/pkg/pki/ca/ca.go
+++ b/security/pkg/pki/ca/ca.go
@@ -31,7 +31,6 @@
 	"istio.io/istio/security/pkg/pki/util"
 	certutil "istio.io/istio/security/pkg/util"
 	"istio.io/pkg/log"
-	"istio.io/pkg/probe"
 )
 
 const (
@@ -93,9 +92,6 @@ type IstioCAOptions struct {
 
 	KeyCertBundle *util.KeyCertBundle
 
-	LivenessProbeOptions *probe.Options
-	ProbeCheckInterval   time.Duration
-
 	// Config for creating self-signed root cert rotator.
 	RotatorConfig *SelfSignedCARootCertRotatorConfig
 }
@@ -273,8 +269,6 @@ type IstioCA struct {
 
 	keyCertBundle *util.KeyCertBundle
 
-	livenessProbe *probe.Probe
-
 	// rootCertRotator periodically rotates self-signed root cert for CA. It is nil
 	// if CA is not self-signed CA.
 	rootCertRotator *SelfSignedCARootCertRotator
@@ -285,7 +279,6 @@ func NewIstioCA(opts *IstioCAOptions) (*IstioCA, error) {
 	ca := &IstioCA{
 		maxCertTTL:    opts.MaxCertTTL,
 		keyCertBundle: opts.KeyCertBundle,
-		livenessProbe: probe.NewProbe(),
 		caRSAKeySize:  opts.CARSAKeySize,
 	}
 
-- 
2.35.3

