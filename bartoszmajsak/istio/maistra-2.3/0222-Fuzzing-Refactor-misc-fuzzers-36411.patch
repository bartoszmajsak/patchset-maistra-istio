From 569832b798f2911677d64d62d73653c5ac999491 Mon Sep 17 00:00:00 2001
From: AdamKorcz <44787359+AdamKorcz@users.noreply.github.com>
Date: Tue, 7 Dec 2021 20:06:37 +0000
Subject: Fuzzing: Refactor misc fuzzers (#36411)

---
 tests/fuzz/misc_fuzzers.go    | 33 +++++++++++++++++++--------------
 tests/fuzz/oss_fuzz_build.sh  |  1 -
 tests/fuzz/regression_test.go |  1 -
 3 files changed, 19 insertions(+), 16 deletions(-)

diff --git a/tests/fuzz/misc_fuzzers.go b/tests/fuzz/misc_fuzzers.go
index a01681e30a..348570a13c 100644
--- a/tests/fuzz/misc_fuzzers.go
+++ b/tests/fuzz/misc_fuzzers.go
@@ -25,10 +25,10 @@
 	fuzz "github.com/AdaLogics/go-fuzz-headers"
 
 	"istio.io/api/operator/v1alpha1"
-	"istio.io/istio/istioctl/pkg/verifier"
 	"istio.io/istio/operator/pkg/apis/istio"
 	"istio.io/istio/operator/pkg/apis/istio/v1alpha1/validation"
 	"istio.io/istio/operator/pkg/controlplane"
+	"istio.io/istio/operator/pkg/name"
 	"istio.io/istio/operator/pkg/object"
 	"istio.io/istio/operator/pkg/patch"
 	"istio.io/istio/operator/pkg/translate"
@@ -80,19 +80,6 @@ func FuzzUnmarshalAndValidateIOPS(data []byte) int {
 	return 1
 }
 
-func FuzzVerify(data []byte) int {
-	f := fuzz.NewConsumer(data)
-	f.AllowUnexportedFields()
-
-	statusVerifier := &verifier.StatusVerifier{}
-	err := f.GenerateStruct(statusVerifier)
-	if err != nil {
-		return 0
-	}
-	_ = statusVerifier.Verify()
-	return 1
-}
-
 func FuzzRenderManifests(data []byte) int {
 	f := fuzz.NewConsumer(data)
 	f.AllowUnexportedFields()
@@ -135,6 +122,24 @@ func FuzzNewControlplane(data []byte) int {
 	if err != nil {
 		return 0
 	}
+	if inTranslator.APIMapping == nil {
+		return 0
+	}
+	if inTranslator.KubernetesMapping == nil {
+		return 0
+	}
+	if inTranslator.GlobalNamespaces == nil {
+		return 0
+	}
+	if inTranslator.ComponentMaps == nil {
+		return 0
+	}
+	cm := &translate.ComponentMaps{}
+	err = f.GenerateStruct(cm)
+	if err != nil {
+		return 0
+	}
+	inTranslator.ComponentMaps[name.PilotComponentName] = cm
 	_, _ = controlplane.NewIstioControlPlane(inInstallSpec, inTranslator)
 	return 1
 }
diff --git a/tests/fuzz/oss_fuzz_build.sh b/tests/fuzz/oss_fuzz_build.sh
index 1fd238ef62..d67ca1a29e 100755
--- a/tests/fuzz/oss_fuzz_build.sh
+++ b/tests/fuzz/oss_fuzz_build.sh
@@ -93,7 +93,6 @@ compile_go_fuzzer istio.io/istio/tests/fuzz FuzzCheckIstioOperatorSpec fuzz_chec
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzV1Alpha1ValidateConfig fuzz_v1alpha1_validate_config
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzGetEnabledComponents fuzz_get_enabled_components
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzUnmarshalAndValidateIOPS fuzz_unmarshal_and_validate_iops
-compile_go_fuzzer istio.io/istio/tests/fuzz FuzzVerify fuzz_verify
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzRenderManifests fuzz_render_manifests
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzOverlayIOP fuzz_overlay_iop
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzNewControlplane fuzz_new_control_plane
diff --git a/tests/fuzz/regression_test.go b/tests/fuzz/regression_test.go
index 61ee676d62..8a6698fbd3 100644
--- a/tests/fuzz/regression_test.go
+++ b/tests/fuzz/regression_test.go
@@ -130,7 +130,6 @@ func TestFuzzers(t *testing.T) {
 		{"FuzzV1Alpha1ValidateConfig", FuzzV1Alpha1ValidateConfig},
 		{"FuzzGetEnabledComponents", FuzzGetEnabledComponents},
 		{"FuzzUnmarshalAndValidateIOPS", FuzzUnmarshalAndValidateIOPS},
-		{"FuzzVerify", FuzzVerify},
 		{"FuzzRenderManifests", FuzzRenderManifests},
 		{"FuzzOverlayIOP", FuzzOverlayIOP},
 		{"FuzzNewControlplane", FuzzNewControlplane},
-- 
2.35.3

