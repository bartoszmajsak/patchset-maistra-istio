From 08d023960852acc69f0159786aaf8be17170aae0 Mon Sep 17 00:00:00 2001
From: Xiaopeng Han <hanxiaop8@outlook.com>
Date: Mon, 20 Dec 2021 17:23:15 +0800
Subject: operator init `--dry-run` should not create ns (#36570)

* fix

* add releasenotes

* revise based on comments
---
 operator/cmd/mesh/operator-init.go        |  4 ++--
 operator/cmd/mesh/shared.go               |  4 ++--
 operator/pkg/helmreconciler/reconciler.go | 10 +++++-----
 releasenotes/notes/36570.yaml             |  6 ++++++
 4 files changed, 15 insertions(+), 9 deletions(-)
 create mode 100644 releasenotes/notes/36570.yaml

diff --git a/operator/cmd/mesh/operator-init.go b/operator/cmd/mesh/operator-init.go
index b37a8be4a2..205141ad28 100644
--- a/operator/cmd/mesh/operator-init.go
+++ b/operator/cmd/mesh/operator-init.go
@@ -127,7 +127,7 @@ func operatorInit(args *rootArgs, oiArgs *operatorInitArgs, l clog.Logger) {
 		}
 	}
 
-	if err := createNamespace(kubeClient, oiArgs.common.operatorNamespace, ""); err != nil {
+	if err := createNamespace(kubeClient, oiArgs.common.operatorNamespace, "", opts.DryRun); err != nil {
 		l.LogAndFatal(err)
 	}
 
@@ -138,7 +138,7 @@ func operatorInit(args *rootArgs, oiArgs *operatorInitArgs, l clog.Logger) {
 		namespaces = append(namespaces, istioNamespace)
 	}
 	for _, ns := range namespaces {
-		if err := createNamespace(kubeClient, ns, ""); err != nil {
+		if err := createNamespace(kubeClient, ns, "", opts.DryRun); err != nil {
 			l.LogAndFatal(err)
 		}
 	}
diff --git a/operator/cmd/mesh/shared.go b/operator/cmd/mesh/shared.go
index 85fcec9571..1f8c941fc4 100644
--- a/operator/cmd/mesh/shared.go
+++ b/operator/cmd/mesh/shared.go
@@ -181,8 +181,8 @@ func getCRAndNamespaceFromFile(filePath string, l clog.Logger) (customResource s
 }
 
 // createNamespace creates a namespace using the given k8s interface.
-func createNamespace(cs kubernetes.Interface, namespace string, network string) error {
-	return helmreconciler.CreateNamespace(cs, namespace, network)
+func createNamespace(cs kubernetes.Interface, namespace string, network string, dryRun bool) error {
+	return helmreconciler.CreateNamespace(cs, namespace, network, dryRun)
 }
 
 // saveIOPToCluster saves the state in an IOP CR in the cluster.
diff --git a/operator/pkg/helmreconciler/reconciler.go b/operator/pkg/helmreconciler/reconciler.go
index a58d499595..30416077e8 100644
--- a/operator/pkg/helmreconciler/reconciler.go
+++ b/operator/pkg/helmreconciler/reconciler.go
@@ -515,7 +515,10 @@ func (h *HelmReconciler) reportPrunedObjectKind() {
 }
 
 // CreateNamespace creates a namespace using the given k8s interface.
-func CreateNamespace(cs kubernetes.Interface, namespace string, network string) error {
+func CreateNamespace(cs kubernetes.Interface, namespace string, network string, dryRun bool) error {
+	if dryRun {
+		return nil
+	}
 	if namespace == "" {
 		// Setup default namespace
 		namespace = name.IstioDefaultNamespace
@@ -597,10 +600,7 @@ func (h *HelmReconciler) analyzeWebhooks(whs []string) error {
 
 // createNamespace creates a namespace using the given k8s client.
 func (h *HelmReconciler) createNamespace(namespace string, network string) error {
-	if h.opts.DryRun {
-		return nil
-	}
-	return CreateNamespace(h.kubeClient, namespace, network)
+	return CreateNamespace(h.kubeClient, namespace, network, h.opts.DryRun)
 }
 
 func (h *HelmReconciler) networkName() string {
diff --git a/releasenotes/notes/36570.yaml b/releasenotes/notes/36570.yaml
new file mode 100644
index 0000000000..721ec7ee15
--- /dev/null
+++ b/releasenotes/notes/36570.yaml
@@ -0,0 +1,6 @@
+apiVersion: release-notes/v2
+kind: bug-fix
+area: istioctl
+releaseNotes:
+  - |
+    **Fixed** `operator init --dry-run` creates unexpected namespaces.
-- 
2.35.3

