From ac5ae313be27941e6a2eb59f24cf68db2b9a5813 Mon Sep 17 00:00:00 2001
From: dwq <41563853+dddddai@users.noreply.github.com>
Date: Thu, 28 Apr 2022 19:52:33 +0800
Subject: correct service matching logic of sidecar egress listeners (#38638)

---
 pilot/pkg/model/sidecar.go      | 4 +++-
 pilot/pkg/model/sidecar_test.go | 7 +++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/pilot/pkg/model/sidecar.go b/pilot/pkg/model/sidecar.go
index 65d2aaae63..811e938e95 100644
--- a/pilot/pkg/model/sidecar.go
+++ b/pilot/pkg/model/sidecar.go
@@ -605,8 +605,10 @@ func (ilw *IstioEgressListenerWrapper) selectServices(services []*Service, confi
 		if importedHosts, nsFound := hosts[configNamespace]; nsFound {
 			if svc := matchingService(importedHosts, s, ilw); svc != nil {
 				importedServices = append(importedServices, svc)
+				continue
 			}
-		} else if wnsFound { // Check if there is an import of form */host or */*
+		}
+		if wnsFound { // Check if there is an import of form */host or */*
 			if svc := matchingService(wildcardHosts, s, ilw); svc != nil {
 				importedServices = append(importedServices, svc)
 			}
diff --git a/pilot/pkg/model/sidecar_test.go b/pilot/pkg/model/sidecar_test.go
index 50a0c88d4f..fa44b287b9 100644
--- a/pilot/pkg/model/sidecar_test.go
+++ b/pilot/pkg/model/sidecar_test.go
@@ -1808,6 +1808,13 @@ func TestIstioEgressListenerWrapper(t *testing.T) {
 			expected:      []*Service{serviceA8000},
 			namespace:     "a",
 		},
+		{
+			name:          "fall back to wildcard namespace",
+			listenerHosts: map[string][]host.Name{wildcardNamespace: {"host"}, "a": {"alt"}},
+			services:      allServices,
+			expected:      []*Service{serviceA8000, serviceA9000, serviceAalt},
+			namespace:     "a",
+		},
 	}
 
 	for _, tt := range tests {
-- 
2.35.3

