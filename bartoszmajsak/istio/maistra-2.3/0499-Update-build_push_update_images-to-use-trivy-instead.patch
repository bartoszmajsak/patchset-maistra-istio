From 43f1361b2415e4b0608bd97d2d8db267fe611dc1 Mon Sep 17 00:00:00 2001
From: Eric Van Norman <ericvn@us.ibm.com>
Date: Mon, 7 Feb 2022 09:09:08 -0700
Subject: Update build_push_update_images to use trivy instead of imagescanner
 (#37173)

---
 samples/bookinfo/build_push_update_images.sh | 25 +++++++-------------
 1 file changed, 8 insertions(+), 17 deletions(-)

diff --git a/samples/bookinfo/build_push_update_images.sh b/samples/bookinfo/build_push_update_images.sh
index 470b2e5a63..1d4fdcf95b 100755
--- a/samples/bookinfo/build_push_update_images.sh
+++ b/samples/bookinfo/build_push_update_images.sh
@@ -75,25 +75,16 @@ fi
 
 #
 # Run security vulnerability scanning on bookinfo sample app images using
-# the ImageScanner tool. If the reuqest is handled successfully, it gives
-# the output in JSON format which has the following format:
-#   {
-#	"Progress": "Scan completed: OK",
-#	"Results": {
-#		"ID": "94be3d24-cd0b-402c-837c-99d453ec8797",
-#		"Scan_Time": 1559143715,
-#		"Status": "OK",
-#		"Vulnerabilities": [],
-#		"Configuration_Issues": []
-#	}
-#    }
-#
+# trivy. If the image has vulnerabilities, the file will have a .failed
+# suffix. A successult scan will have a .passed suffix.
 function run_vulnerability_scanning() {
   RESULT_DIR="vulnerability_scan_results"
-  CURL_RESPONSE=$(curl -s --create-dirs -o "$RESULT_DIR/$1_$VERSION"  -w "%{http_code}" http://imagescanner.cloud.ibm.com/scan?image="$2")
-  if [ "$CURL_RESPONSE" -eq 200 ]; then
-     mv "$RESULT_DIR/$1_$VERSION" "$RESULT_DIR/$1_$VERSION.json"
-  fi
+  mkdir -p "$RESULT_DIR"
+  # skip-dir added to prevent timeout of review images
+  set +e
+  trivy image --ignore-unfixed --no-progress --exit-code 2 --skip-dirs /opt/ibm/wlp --output "$RESULT_DIR/$1_$VERSION.failed" "$2"
+  test $? -ne 0 || mv "$RESULT_DIR/$1_$VERSION.failed" "$RESULT_DIR/$1_$VERSION.passed"
+  set -e
 }
 
 # Push images. Scan images if ENABLE_IMAGE_SCAN is true.
-- 
2.35.3

