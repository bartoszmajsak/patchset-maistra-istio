From cd004f1ba7f9bab3951824912af4119074ec9a00 Mon Sep 17 00:00:00 2001
From: nielsole <github@niels-ole.com>
Date: Wed, 19 Jan 2022 13:04:35 +0100
Subject: JWKS: No longer print entire response body on error (#36869)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* Limiting number of bytes to be read from untrusted source; only printing body until newline character

* Renaming variables

* Using strings instead of buffers

* Switching to const

* Using camelCase

* Incorporating feedback, adding docs and release notes

* Fix Release notes

* Trying CI fix

* Removing limiting response body.

* Updating release notes

* Changing area to one of the allowed areas.

Co-authored-by: Niels-Ole KÃ¼hl <nkuehl@wayfair.com>
---
 pilot/pkg/model/jwks_resolver.go | 8 +++++++-
 releasenotes/notes/35723.yaml    | 8 ++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)
 create mode 100644 releasenotes/notes/35723.yaml

diff --git a/pilot/pkg/model/jwks_resolver.go b/pilot/pkg/model/jwks_resolver.go
index 7a3ad19c8d..b99b69a94f 100644
--- a/pilot/pkg/model/jwks_resolver.go
+++ b/pilot/pkg/model/jwks_resolver.go
@@ -27,6 +27,7 @@
 	"os"
 	"reflect"
 	"sort"
+	"strconv"
 	"strings"
 	"sync"
 	"sync/atomic"
@@ -351,7 +352,12 @@ func (r *JwksResolver) getRemoteContentWithRetry(uri string, retry int) ([]byte,
 		}
 
 		if resp.StatusCode < 200 || resp.StatusCode >= 300 {
-			return nil, fmt.Errorf("status %d, %s", resp.StatusCode, string(body))
+			message := strconv.Quote(string(body))
+			if len(message) > 100 {
+				message = message[:100]
+				return nil, fmt.Errorf("status %d, message %s(truncated)", resp.StatusCode, message)
+			}
+			return nil, fmt.Errorf("status %d, message %s", resp.StatusCode, message)
 		}
 
 		return body, nil
diff --git a/releasenotes/notes/35723.yaml b/releasenotes/notes/35723.yaml
new file mode 100644
index 0000000000..017b2e06c9
--- /dev/null
+++ b/releasenotes/notes/35723.yaml
@@ -0,0 +1,8 @@
+apiVersion: release-notes/v2
+kind: bug-fix
+area: telemetry
+issue:
+  - 35663
+releaseNotes:
+- |
+  **Improved** Istiod JWTRule: Failed JWKS requests are now logged with truncation to 100 characters
-- 
2.35.3

