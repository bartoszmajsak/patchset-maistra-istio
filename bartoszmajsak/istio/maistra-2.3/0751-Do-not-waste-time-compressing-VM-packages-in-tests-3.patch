From cd9bb513dfffdd5050f5c48c8d599a10d3315188 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Tue, 8 Mar 2022 11:40:42 -0800
Subject: Do not waste time compressing VM packages in tests (#37811)

---
 prow/integ-suite-kind.sh     |  2 ++
 tools/packaging/packaging.mk | 11 +++++++++++
 2 files changed, 13 insertions(+)

diff --git a/prow/integ-suite-kind.sh b/prow/integ-suite-kind.sh
index 63b3e6f10b..8e5e28144f 100755
--- a/prow/integ-suite-kind.sh
+++ b/prow/integ-suite-kind.sh
@@ -41,6 +41,8 @@ NODE_IMAGE="gcr.io/istio-testing/kind-node:v1.23.0"
 KIND_CONFIG=""
 CLUSTER_TOPOLOGY_CONFIG_FILE="${ROOT}/prow/config/topology/multicluster.json"
 
+export FAST_VM_BUILDS=true
+
 PARAMS=()
 
 while (( "$#" )); do
diff --git a/tools/packaging/packaging.mk b/tools/packaging/packaging.mk
index 380132ec3c..618ef8ffd0 100644
--- a/tools/packaging/packaging.mk
+++ b/tools/packaging/packaging.mk
@@ -9,6 +9,14 @@ PACKAGE_VERSION ?= $(shell echo $(VERSION) | sed 's/^[a-z]*-//' | sed 's/-//')
 
 deb: ${ISTIO_OUT_LINUX}/release/istio-sidecar.deb ${ISTIO_OUT_LINUX}/release/istio.deb
 
+# fpm likes to add extremely high levels of compression. This is fine for release, but for local runs
+# where we are just pushing to a local registry (compressed again!), it adds ~1min to builds.
+ifneq ($(FAST_VM_BUILDS),)
+# TODO(debian): https://github.com/jordansissel/fpm/pull/1879
+DEB_COMPRESSION=
+RPM_COMPRESSION=--rpm-compression=none
+endif
+
 # Base directory for istio binaries. Likely to change !
 ISTIO_DEB_BIN=/usr/local/bin
 
@@ -82,6 +90,7 @@ rpm/fpm:
 		--depends iproute \
 		--depends iptables \
 		--depends sudo \
+		$(RPM_COMPRESSION) \
 		$(SIDECAR_FILES)
 
 # Centos 7 compatible RPM
@@ -99,6 +108,7 @@ rpm-7/fpm:
 		--depends iproute \
 		--depends iptables \
 		--depends sudo \
+		$(RPM_COMPRESSION) \
 		$(SIDECAR_CENTOS_7_FILES)
 
 # Package the sidecar deb file.
@@ -116,6 +126,7 @@ deb/fpm:
 		--depends iproute2 \
 		--depends iptables \
 		--depends sudo \
+		$(DEB_COMPRESSION) \
 		$(SIDECAR_FILES)
 
 ${ISTIO_OUT_LINUX}/release/istio.deb:
-- 
2.35.3

