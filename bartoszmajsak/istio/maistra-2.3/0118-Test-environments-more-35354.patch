From 9d628bb53524643abe102dd11cfbe77b8656fc95 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Thu, 18 Nov 2021 07:01:24 -0800
Subject: Test environments more (#35354)

* just makefile

* Switch to non-default
---
 tests/integration/tests.mk | 30 ++++++++++++++++++++++++++++--
 1 file changed, 28 insertions(+), 2 deletions(-)

diff --git a/tests/integration/tests.mk b/tests/integration/tests.mk
index 25922fe5b5..fd4167728f 100644
--- a/tests/integration/tests.mk
+++ b/tests/integration/tests.mk
@@ -33,8 +33,18 @@ ifneq ($(TAG),)
 endif
 
 _INTEGRATION_TEST_SELECT_FLAGS ?= --istio.test.select=$(TEST_SELECT)
-ifeq ($(TEST_SELECT),)
-    _INTEGRATION_TEST_SELECT_FLAGS = --istio.test.select=-postsubmit,-flaky
+ifneq ($(JOB_TYPE),postsubmit)
+	_INTEGRATION_TEST_SELECT_FLAGS:="$(_INTEGRATION_TEST_SELECT_FLAGS),-postsubmit"
+endif
+ifeq ($(IP_FAMILY),ipv6)
+	_INTEGRATION_TEST_SELECT_FLAGS:="$(_INTEGRATION_TEST_SELECT_FLAGS),-ipv4"
+	# Fundamentally, VMs should support IPv6. However, our test framework uses a contrived setup to test VMs
+	# such that they run in the cluster. In particular, they configure DNS to a public DNS server.
+	# For CI, our nodes do not have IPv6 external connectivity. This means the cluster *cannot* reach these external
+	# DNS servers.
+	# Extensive work was done to try to hack around this, but ultimately nothing was able to cover all
+	# of the edge cases. This work was captured in https://github.com/howardjohn/istio/tree/tf/vm-ipv6.
+	_INTEGRATION_TEST_FLAGS += --istio.test.skipVM
 endif
 
 # $(INTEGRATION_TEST_KUBECONFIG) overrides all kube config settings.
@@ -95,9 +105,25 @@ test.integration.kube.presubmit: | $(JUNIT_REPORT) check-go-tag
 	2>&1 | tee >($(JUNIT_REPORT) > $(JUNIT_OUT))
 
 # Defines a target to run a minimal reachability testing basic traffic
+# This test suite should be avoided in favor test.integration.kube.environment
 .PHONY: test.integration.kube.reachability
 test.integration.kube.reachability: | $(JUNIT_REPORT) check-go-tag
 	$(GO) test -p 1 ${T} -tags=integ ./tests/integration/security/ -timeout 30m \
 	${_INTEGRATION_TEST_FLAGS} \
 	--test.run=TestReachability \
 	2>&1 | tee >($(JUNIT_REPORT) > $(JUNIT_OUT))
+
+# Defines a target to run a standard set of tests in various different environments (IPv6, distroless, ARM, etc)
+# In presubmit, this target runs a minimal set. In postsubmit, all tests are run
+.PHONY: test.integration.kube.environment
+test.integration.kube.environment: | $(JUNIT_REPORT) check-go-tag
+ifeq (${JOB_TYPE},postsubmit)
+	PATH=${PATH}:${ISTIO_OUT} $(GO) test -p 1 ${T} -tags=integ ./tests/integration/... -timeout 30m \
+	${_INTEGRATION_TEST_FLAGS} \
+	2>&1 | tee >($(JUNIT_REPORT) > $(JUNIT_OUT))
+else
+	PATH=${PATH}:${ISTIO_OUT} $(GO) test -p 1 ${T} -tags=integ ./tests/integration/security/ ./tests/integration/pilot -timeout 30m \
+	${_INTEGRATION_TEST_FLAGS} \
+	--test.run=TestReachability|TestTraffic \
+	2>&1 | tee >($(JUNIT_REPORT) > $(JUNIT_OUT))
+endif
-- 
2.35.3

