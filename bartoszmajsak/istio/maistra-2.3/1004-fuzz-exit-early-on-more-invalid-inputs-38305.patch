From 0455887e85f9f60ade394be42ecd03da0d7f5a96 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Mon, 11 Apr 2022 13:15:16 -0700
Subject: fuzz: exit early on more invalid inputs (#38305)

* fuzz: exit early on more invalid inputs

* lint
---
 tests/fuzz/fuzz.go                                        | 5 +++++
 tests/fuzz/networking_core_v1alpha3_envoyfilter_fuzzer.go | 3 +++
 tests/fuzz/pilot_networking_fuzzer.go                     | 3 +++
 tests/fuzz/workloadentry_controller_fuzzer.go             | 3 +++
 4 files changed, 14 insertions(+)

diff --git a/tests/fuzz/fuzz.go b/tests/fuzz/fuzz.go
index f703e39611..0827923aef 100644
--- a/tests/fuzz/fuzz.go
+++ b/tests/fuzz/fuzz.go
@@ -17,6 +17,7 @@
 
 import (
 	"istio.io/istio/pilot/pkg/config/kube/crd"
+	"istio.io/istio/pilot/pkg/model"
 )
 
 func FuzzParseInputs(data []byte) int {
@@ -26,3 +27,7 @@ func FuzzParseInputs(data []byte) int {
 	}
 	return 1
 }
+
+func proxyValid(p *model.Proxy) bool {
+	return len(p.IPAddresses) != 0
+}
diff --git a/tests/fuzz/networking_core_v1alpha3_envoyfilter_fuzzer.go b/tests/fuzz/networking_core_v1alpha3_envoyfilter_fuzzer.go
index 05815048f6..5437b8b111 100644
--- a/tests/fuzz/networking_core_v1alpha3_envoyfilter_fuzzer.go
+++ b/tests/fuzz/networking_core_v1alpha3_envoyfilter_fuzzer.go
@@ -54,6 +54,9 @@ func InternalFuzzApplyClusterMerge(data []byte) int {
 	if err != nil {
 		return 0
 	}
+	if !proxyValid(proxy) {
+		return 0
+	}
 
 	// crete mesh config
 	testMesh := &meshconfig.MeshConfig{}
diff --git a/tests/fuzz/pilot_networking_fuzzer.go b/tests/fuzz/pilot_networking_fuzzer.go
index ab41762660..e6eaf06c33 100644
--- a/tests/fuzz/pilot_networking_fuzzer.go
+++ b/tests/fuzz/pilot_networking_fuzzer.go
@@ -30,6 +30,9 @@ func FuzzGrpcGenGenerate(data []byte) int {
 	if err != nil {
 		return 0
 	}
+	if !proxyValid(proxy) {
+		return 0
+	}
 
 	w := &model.WatchedResource{}
 	err = f.GenerateStruct(w)
diff --git a/tests/fuzz/workloadentry_controller_fuzzer.go b/tests/fuzz/workloadentry_controller_fuzzer.go
index 9b80c1583e..bccc95c29a 100644
--- a/tests/fuzz/workloadentry_controller_fuzzer.go
+++ b/tests/fuzz/workloadentry_controller_fuzzer.go
@@ -77,6 +77,9 @@ func FuzzWE(data []byte) int {
 	if err != nil {
 		return 0
 	}
+	if !proxyValid(proxy) {
+		return 0
+	}
 
 	store := memory.NewController(memory.Make(collections.All))
 	c := workloadentry.NewController(store, "", keepalive.Infinity)
-- 
2.35.3

