From f0ac17cd8da247e5791de1568822e2f269f2207b Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Tue, 12 Apr 2022 16:41:04 -0700
Subject: Fix concurrent map write (#38359)

---
 tools/docker-builder/builder/crane.go | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/tools/docker-builder/builder/crane.go b/tools/docker-builder/builder/crane.go
index 0fcac9022d..44b020c489 100644
--- a/tools/docker-builder/builder/crane.go
+++ b/tools/docker-builder/builder/crane.go
@@ -64,14 +64,18 @@ func WarmBase(baseImages ...string) {
 	basesMu.Lock()
 	wg := sync.WaitGroup{}
 	wg.Add(len(baseImages))
+	resolvedBaseImages := make([]v1.Image, len(baseImages))
 	go func() {
 		wg.Wait()
+		for i, rbi := range resolvedBaseImages {
+			bases[baseImages[i]] = rbi
+		}
 		basesMu.Unlock()
 	}()
 
 	t0 := time.Now()
-	for _, b := range baseImages {
-		b := b
+	for i, b := range baseImages {
+		b, i := b, i
 		go func() {
 			ref, err := name.ParseReference(b)
 			if err != nil {
@@ -84,7 +88,7 @@ func WarmBase(baseImages ...string) {
 				return
 			}
 			log.WithLabels("image", b, "step", time.Since(t0)).Infof("base loaded")
-			bases[b] = bi
+			resolvedBaseImages[i] = bi
 			wg.Done()
 		}()
 	}
-- 
2.35.3

