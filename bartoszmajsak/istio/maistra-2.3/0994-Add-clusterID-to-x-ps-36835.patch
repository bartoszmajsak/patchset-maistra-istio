From a177d8b8e28c0bd4e72f3e7274e6f66d0c303345 Mon Sep 17 00:00:00 2001
From: Xiaopeng Han <hanxiaop8@outlook.com>
Date: Fri, 8 Apr 2022 22:30:57 +0800
Subject: Add clusterID to x ps (#36835)

* add cluster to x ps

* releasenotes
---
 istioctl/pkg/writer/pilot/status.go              | 15 +++++++++++----
 istioctl/pkg/writer/pilot/status_test.go         | 16 ++++++++++++++--
 .../pilot/testdata/multiXdsStatusMultiPilot.txt  |  8 ++++----
 .../pilot/testdata/multiXdsStatusSinglePilot.txt |  6 +++---
 pilot/pkg/xds/statusgen.go                       |  3 ++-
 releasenotes/notes/36835.yaml                    |  8 ++++++++
 6 files changed, 42 insertions(+), 14 deletions(-)
 create mode 100644 releasenotes/notes/36835.yaml

diff --git a/istioctl/pkg/writer/pilot/status.go b/istioctl/pkg/writer/pilot/status.go
index f76b7ae3f3..d3750b91de 100644
--- a/istioctl/pkg/writer/pilot/status.go
+++ b/istioctl/pkg/writer/pilot/status.go
@@ -26,6 +26,7 @@
 	xdsstatus "github.com/envoyproxy/go-control-plane/envoy/service/status/v3"
 
 	"istio.io/istio/istioctl/pkg/multixds"
+	"istio.io/istio/pilot/pkg/model"
 	"istio.io/istio/pilot/pkg/xds"
 	xdsresource "istio.io/istio/pilot/pkg/xds/v3"
 	"istio.io/pkg/log"
@@ -49,6 +50,7 @@ type XdsStatusWriter struct {
 
 type xdsWriterStatus struct {
 	proxyID              string
+	clusterID            string
 	istiodID             string
 	istiodVersion        string
 	clusterStatus        string
@@ -180,8 +182,13 @@ func (s *XdsStatusWriter) setupStatusPrint(drs map[string]*xdsapi.DiscoveryRespo
 				}
 				cds, lds, eds, rds, ecds := getSyncStatus(&clientConfig)
 				cp := multixds.CpInfo(dr)
+				meta, err := model.ParseMetadata(clientConfig.GetNode().GetMetadata())
+				if err != nil {
+					return nil, nil, fmt.Errorf("could not parse node metadata: %w", err)
+				}
 				fullStatus = append(fullStatus, &xdsWriterStatus{
 					proxyID:              clientConfig.GetNode().GetId(),
+					clusterID:            meta.ClusterID.String(),
 					istiodID:             cp.ID,
 					istiodVersion:        cp.Info.Version,
 					clusterStatus:        cds,
@@ -194,8 +201,8 @@ func (s *XdsStatusWriter) setupStatusPrint(drs map[string]*xdsapi.DiscoveryRespo
 					return nil, nil, fmt.Errorf("no proxies found (checked %d istiods)", len(drs))
 				}
 
-				w = new(tabwriter.Writer).Init(s.Writer, 0, 9, 5, ' ', 0)
-				_, _ = fmt.Fprintln(w, "NAME\tCDS\tLDS\tEDS\tRDS\tECDS\tISTIOD\tVERSION")
+				w = new(tabwriter.Writer).Init(s.Writer, 0, 8, 5, ' ', 0)
+				_, _ = fmt.Fprintln(w, "NAME\tCLUSTER\tCDS\tLDS\tEDS\tRDS\tECDS\tISTIOD\tVERSION")
 
 				sort.Slice(fullStatus, func(i, j int) bool {
 					return fullStatus[i].proxyID < fullStatus[j].proxyID
@@ -226,8 +233,8 @@ func (s *XdsStatusWriter) setupStatusPrint(drs map[string]*xdsapi.DiscoveryRespo
 }
 
 func xdsStatusPrintln(w io.Writer, status *xdsWriterStatus) error {
-	_, err := fmt.Fprintf(w, "%v\t%v\t%v\t%v\t%v\t%v\t%v\t%v\n",
-		status.proxyID,
+	_, err := fmt.Fprintf(w, "%v\t%v\t%v\t%v\t%v\t%v\t%v\t%v\t%v\n",
+		status.proxyID, status.clusterID,
 		status.clusterStatus, status.listenerStatus, status.endpointStatus, status.routeStatus,
 		status.extensionconfigStaus,
 		status.istiodID, status.istiodVersion)
diff --git a/istioctl/pkg/writer/pilot/status_test.go b/istioctl/pkg/writer/pilot/status_test.go
index b971caf29b..1752e5cfdc 100644
--- a/istioctl/pkg/writer/pilot/status_test.go
+++ b/istioctl/pkg/writer/pilot/status_test.go
@@ -26,9 +26,11 @@
 	"github.com/google/uuid"
 	any "google.golang.org/protobuf/types/known/anypb"
 
+	"istio.io/istio/pilot/pkg/model"
 	networkingutil "istio.io/istio/pilot/pkg/networking/util"
 	"istio.io/istio/pilot/pkg/xds"
 	v3 "istio.io/istio/pilot/pkg/xds/v3"
+	"istio.io/istio/pkg/cluster"
 	"istio.io/istio/pkg/test/util/assert"
 	"istio.io/istio/tests/util"
 	istioversion "istio.io/pkg/version"
@@ -250,6 +252,7 @@ func TestXdsStatusWriter_PrintAll(t *testing.T) {
 				"istiod1": xdsResponseInput("istiod1", []clientConfigInput{
 					{
 						proxyID:        "proxy1",
+						clusterID:      "cluster1",
 						cdsSyncStatus:  status.ConfigStatus_STALE,
 						ldsSyncStatus:  status.ConfigStatus_SYNCED,
 						rdsSyncStatus:  status.ConfigStatus_NOT_SENT,
@@ -260,6 +263,7 @@ func TestXdsStatusWriter_PrintAll(t *testing.T) {
 				"istiod2": xdsResponseInput("istiod2", []clientConfigInput{
 					{
 						proxyID:        "proxy2",
+						clusterID:      "cluster2",
 						cdsSyncStatus:  status.ConfigStatus_STALE,
 						ldsSyncStatus:  status.ConfigStatus_SYNCED,
 						rdsSyncStatus:  status.ConfigStatus_SYNCED,
@@ -270,6 +274,7 @@ func TestXdsStatusWriter_PrintAll(t *testing.T) {
 				"istiod3": xdsResponseInput("istiod3", []clientConfigInput{
 					{
 						proxyID:        "proxy3",
+						clusterID:      "cluster3",
 						cdsSyncStatus:  status.ConfigStatus_UNKNOWN,
 						ldsSyncStatus:  status.ConfigStatus_ERROR,
 						rdsSyncStatus:  status.ConfigStatus_NOT_SENT,
@@ -286,6 +291,7 @@ func TestXdsStatusWriter_PrintAll(t *testing.T) {
 				"istiod1": xdsResponseInput("istiod1", []clientConfigInput{
 					{
 						proxyID:        "proxy1",
+						clusterID:      "cluster1",
 						cdsSyncStatus:  status.ConfigStatus_STALE,
 						ldsSyncStatus:  status.ConfigStatus_SYNCED,
 						rdsSyncStatus:  status.ConfigStatus_NOT_SENT,
@@ -294,6 +300,7 @@ func TestXdsStatusWriter_PrintAll(t *testing.T) {
 					},
 					{
 						proxyID:        "proxy2",
+						clusterID:      "cluster2",
 						cdsSyncStatus:  status.ConfigStatus_STALE,
 						ldsSyncStatus:  status.ConfigStatus_SYNCED,
 						rdsSyncStatus:  status.ConfigStatus_SYNCED,
@@ -331,7 +338,8 @@ func TestXdsStatusWriter_PrintAll(t *testing.T) {
 const clientConfigType = "type.googleapis.com/envoy.service.status.v3.ClientConfig"
 
 type clientConfigInput struct {
-	proxyID string
+	proxyID   string
+	clusterID string
 
 	cdsSyncStatus  status.ConfigStatus
 	ldsSyncStatus  status.ConfigStatus
@@ -341,9 +349,13 @@ type clientConfigInput struct {
 }
 
 func newXdsClientConfig(config clientConfigInput) *status.ClientConfig {
+	meta := model.NodeMetadata{
+		ClusterID: cluster.ID(config.clusterID),
+	}
 	return &status.ClientConfig{
 		Node: &envoycorev3.Node{
-			Id: config.proxyID,
+			Id:       config.proxyID,
+			Metadata: meta.ToStruct(),
 		},
 		GenericXdsConfigs: []*status.ClientConfig_GenericXdsConfig{
 			{
diff --git a/istioctl/pkg/writer/pilot/testdata/multiXdsStatusMultiPilot.txt b/istioctl/pkg/writer/pilot/testdata/multiXdsStatusMultiPilot.txt
index 3e7c93607a..8dea2b9a32 100644
--- a/istioctl/pkg/writer/pilot/testdata/multiXdsStatusMultiPilot.txt
+++ b/istioctl/pkg/writer/pilot/testdata/multiXdsStatusMultiPilot.txt
@@ -1,4 +1,4 @@
-NAME       CDS         LDS        EDS        RDS          ECDS         ISTIOD      VERSION
-proxy1     STALE       SYNCED     SYNCED     NOT_SENT     SYNCED       istiod1     1.1
-proxy2     STALE       SYNCED     STALE      SYNCED       STALE        istiod2     1.1
-proxy3     UNKNOWN     ERROR      STALE      NOT_SENT     NOT_SENT     istiod3     1.1
+NAME       CLUSTER      CDS         LDS        EDS        RDS          ECDS         ISTIOD      VERSION
+proxy1     cluster1     STALE       SYNCED     SYNCED     NOT_SENT     SYNCED       istiod1     1.1
+proxy2     cluster2     STALE       SYNCED     STALE      SYNCED       STALE        istiod2     1.1
+proxy3     cluster3     UNKNOWN     ERROR      STALE      NOT_SENT     NOT_SENT     istiod3     1.1
diff --git a/istioctl/pkg/writer/pilot/testdata/multiXdsStatusSinglePilot.txt b/istioctl/pkg/writer/pilot/testdata/multiXdsStatusSinglePilot.txt
index 9b58c0e17b..c358a342b5 100644
--- a/istioctl/pkg/writer/pilot/testdata/multiXdsStatusSinglePilot.txt
+++ b/istioctl/pkg/writer/pilot/testdata/multiXdsStatusSinglePilot.txt
@@ -1,3 +1,3 @@
-NAME       CDS       LDS        EDS        RDS          ECDS         ISTIOD      VERSION
-proxy1     STALE     SYNCED     SYNCED     NOT_SENT     NOT_SENT     istiod1     1.1
-proxy2     STALE     SYNCED     STALE      SYNCED       NOT_SENT     istiod1     1.1
+NAME       CLUSTER      CDS       LDS        EDS        RDS          ECDS         ISTIOD      VERSION
+proxy1     cluster1     STALE     SYNCED     SYNCED     NOT_SENT     NOT_SENT     istiod1     1.1
+proxy2     cluster2     STALE     SYNCED     STALE      SYNCED       NOT_SENT     istiod1     1.1
diff --git a/pilot/pkg/xds/statusgen.go b/pilot/pkg/xds/statusgen.go
index 0363beb8b9..6a8a69465a 100644
--- a/pilot/pkg/xds/statusgen.go
+++ b/pilot/pkg/xds/statusgen.go
@@ -134,7 +134,8 @@ func (sg *StatusGen) debugSyncz() model.Resources {
 			}
 			clientConfig := &status.ClientConfig{
 				Node: &core.Node{
-					Id: con.proxy.ID,
+					Id:       con.proxy.ID,
+					Metadata: con.proxy.Metadata.ToStruct(),
 				},
 				GenericXdsConfigs: xdsConfigs,
 			}
diff --git a/releasenotes/notes/36835.yaml b/releasenotes/notes/36835.yaml
new file mode 100644
index 0000000000..8b8fa734b4
--- /dev/null
+++ b/releasenotes/notes/36835.yaml
@@ -0,0 +1,8 @@
+apiVersion: release-notes/v2
+kind: feature
+area: istioctl
+issue:
+  - https://github.com/istio/istio/issues/36290
+releaseNotes:
+  - |
+    **Added** the cluster id to `experimental ps`.
-- 
2.35.3

