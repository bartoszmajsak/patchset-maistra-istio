From 57dbdeeda1f48cbcbd1a1c0f7bd36335fc6b2774 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Tue, 3 May 2022 10:20:36 -0700
Subject: do not persist temporary test files to output (#38695)

* do not persist temporary test files to output

* lint
---
 pilot/pkg/xds/eds_test.go | 3 ---
 pilot/pkg/xds/lds_test.go | 6 +++---
 2 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/pilot/pkg/xds/eds_test.go b/pilot/pkg/xds/eds_test.go
index 83863eae24..4d6af0641b 100644
--- a/pilot/pkg/xds/eds_test.go
+++ b/pilot/pkg/xds/eds_test.go
@@ -14,7 +14,6 @@
 package xds_test
 
 import (
-	"encoding/json"
 	"errors"
 	"fmt"
 	"io"
@@ -185,8 +184,6 @@ func TestEds(t *testing.T) {
 		if len(clusters) == 0 {
 			t.Error("No clusters in ADS response")
 		}
-		strResponse, _ := json.MarshalIndent(clusters, " ", " ")
-		_ = os.WriteFile(env.IstioOut+"/cdsv2_sidecar.json", strResponse, 0o644)
 	})
 }
 
diff --git a/pilot/pkg/xds/lds_test.go b/pilot/pkg/xds/lds_test.go
index 411fa32008..110ddfbccc 100644
--- a/pilot/pkg/xds/lds_test.go
+++ b/pilot/pkg/xds/lds_test.go
@@ -30,7 +30,6 @@
 	"istio.io/istio/pilot/test/xdstest"
 	"istio.io/istio/pkg/config/labels"
 	"istio.io/istio/pkg/config/mesh"
-	"istio.io/istio/pkg/test/env"
 	"istio.io/istio/tests/util"
 )
 
@@ -40,6 +39,7 @@ func TestLDSIsolated(t *testing.T) {
 
 	// Sidecar in 'none' mode
 	t.Run("sidecar_none", func(t *testing.T) {
+		wd := t.TempDir()
 		adscon := s.Connect(&model.Proxy{
 			Metadata: &model.NodeMetadata{
 				InterceptionMode: model.InterceptionNone,
@@ -49,7 +49,7 @@ func TestLDSIsolated(t *testing.T) {
 			ConfigNamespace: "none",
 		}, nil, watchAll)
 
-		err := adscon.Save(env.IstioOut + "/none")
+		err := adscon.Save(wd + "/none")
 		if err != nil {
 			t.Fatal(err)
 		}
@@ -69,7 +69,7 @@ func TestLDSIsolated(t *testing.T) {
 		}
 
 		for _, s := range []string{"lds_tcp", "lds_http", "rds", "cds", "ecds"} {
-			want, err := os.ReadFile(env.IstioOut + "/none_" + s + ".json")
+			want, err := os.ReadFile(wd + "/none_" + s + ".json")
 			if err != nil {
 				t.Fatal(err)
 			}
-- 
2.35.3

