From 68f6471fb2b043a9f12ad9b6bf8ca147d9e95041 Mon Sep 17 00:00:00 2001
From: Greg Hanson <gregory.hanson@solo.io>
Date: Thu, 21 Apr 2022 16:12:15 -0400
Subject: run update deps and make gen (#38506)

* run update deps and make gen

* update go-controlplane

* fix renames in test

* more make gen updates
---
 docker/Dockerfile.distroless                  |  2 +-
 go.mod                                        |  8 +--
 go.sum                                        | 16 ++---
 manifests/charts/base/crds/crd-all.gen.yaml   | 60 +++++++++++++++++++
 .../charts/base/files/gen-istio-cluster.yaml  | 60 +++++++++++++++++++
 .../istiod-remote/templates/crd-all.gen.yaml  | 60 +++++++++++++++++++
 pilot/docker/Dockerfile.proxyv2               |  2 +-
 pilot/pkg/config/kube/gateway/conversion.go   |  3 +-
 .../kube/controller/network.go                |  5 +-
 pilot/pkg/xds/mesh_network_test.go            |  3 +-
 pkg/config/xds/filter_types.gen.go            |  1 +
 prow/release-commit.sh                        |  2 +-
 12 files changed, 200 insertions(+), 22 deletions(-)

diff --git a/docker/Dockerfile.distroless b/docker/Dockerfile.distroless
index d705b98959..8c5f3e4c13 100644
--- a/docker/Dockerfile.distroless
+++ b/docker/Dockerfile.distroless
@@ -1,3 +1,3 @@
 # istio-static image is prebuilt with 1337:1337.
 # https://github.com/istio/distroless/tree/iptables/istio
-FROM gcr.io/istio-release/distroless/istio-static@sha256:6330bd7b07d70fe4277af99c6bba96236ae3f415417b13a4563f29bcf6208062 as distroless_source
\ No newline at end of file
+FROM gcr.io/istio-release/distroless/istio-static@sha256:d6fa9db9548b5772860fecddb11d84f9ebd7e0321c0cb3c02870402680cc315f as distroless_source
\ No newline at end of file
diff --git a/go.mod b/go.mod
index c42dfea8af..13a1968e1c 100644
--- a/go.mod
+++ b/go.mod
@@ -23,7 +23,7 @@ require (
 	github.com/coreos/go-oidc/v3 v3.1.0
 	github.com/davecgh/go-spew v1.1.1
 	github.com/docker/cli v20.10.14+incompatible
-	github.com/envoyproxy/go-control-plane v0.10.2-0.20220413133113-27659a1a988e
+	github.com/envoyproxy/go-control-plane v0.10.2-0.20220420171917-689c2bccf0ec
 	github.com/evanphx/json-patch/v5 v5.6.0
 	github.com/fatih/color v1.13.0
 	github.com/felixge/fgprof v0.9.2
@@ -84,9 +84,9 @@ require (
 	gopkg.in/yaml.v2 v2.4.0
 	gopkg.in/yaml.v3 v3.0.0-20210107192922-496545a6307b
 	helm.sh/helm/v3 v3.8.2
-	istio.io/api v0.0.0-20220418200313-202d5d40987b
-	istio.io/client-go v1.12.0-alpha.5.0.20220418200715-cbfcc8c2be75
-	istio.io/pkg v0.0.0-20220412163443-dc80e140671f
+	istio.io/api v0.0.0-20220420164308-b6a03a9e477e
+	istio.io/client-go v1.12.0-alpha.5.0.20220420164809-3baeb1b66473
+	istio.io/pkg v0.0.0-20220418200614-813ce651e422
 	k8s.io/api v0.23.5
 	k8s.io/apiextensions-apiserver v0.23.5
 	k8s.io/apimachinery v0.23.5
diff --git a/go.sum b/go.sum
index f30e9db250..8d822d883a 100644
--- a/go.sum
+++ b/go.sum
@@ -631,8 +631,8 @@ github.com/envoyproxy/go-control-plane v0.9.9-0.20210217033140-668b12f5399d/go.m
 github.com/envoyproxy/go-control-plane v0.9.9-0.20210512163311-63b5d3c536b0/go.mod h1:hliV/p42l8fGbc6Y9bQ70uLwIvmJyVE5k4iMKlh8wCQ=
 github.com/envoyproxy/go-control-plane v0.9.10-0.20210907150352-cf90f659a021/go.mod h1:AFq3mo9L8Lqqiid3OhADV3RfLJnjiw63cSpi+fDTRC0=
 github.com/envoyproxy/go-control-plane v0.10.1/go.mod h1:AY7fTTXNdv/aJ2O5jwpxAPOWUZ7hQAEvzN5Pf27BkQQ=
-github.com/envoyproxy/go-control-plane v0.10.2-0.20220413133113-27659a1a988e h1:c/zqqQmO937rp44iyAxYFP+oDYB5UxSxO3c0nqfYR/Y=
-github.com/envoyproxy/go-control-plane v0.10.2-0.20220413133113-27659a1a988e/go.mod h1:fJJn/j26vwOu972OllsvAgJJM//w9BV6Fxbg2LuVd34=
+github.com/envoyproxy/go-control-plane v0.10.2-0.20220420171917-689c2bccf0ec h1:np2MDgE07uAw/Z/0N5bPLVRzlPd8aAHng6cNKQUhxu0=
+github.com/envoyproxy/go-control-plane v0.10.2-0.20220420171917-689c2bccf0ec/go.mod h1:fJJn/j26vwOu972OllsvAgJJM//w9BV6Fxbg2LuVd34=
 github.com/envoyproxy/protoc-gen-validate v0.0.14/go.mod h1:iSmxcyjqTsJpI2R4NaDN7+kN2VEUnK/pcBlmesArF7c=
 github.com/envoyproxy/protoc-gen-validate v0.1.0/go.mod h1:iSmxcyjqTsJpI2R4NaDN7+kN2VEUnK/pcBlmesArF7c=
 github.com/envoyproxy/protoc-gen-validate v0.6.2/go.mod h1:2t7qjJNvHPx8IjnBOzl9E9/baC+qXE/TeeyBRzgJDws=
@@ -2924,12 +2924,12 @@ honnef.co/go/tools v0.0.1-2020.1.3/go.mod h1:X/FiERA/W4tHapMX5mGpAtMSVEeEUOyHaw9
 honnef.co/go/tools v0.0.1-2020.1.4/go.mod h1:X/FiERA/W4tHapMX5mGpAtMSVEeEUOyHaw9vFzvIQ3k=
 honnef.co/go/tools v0.0.1-2020.1.5/go.mod h1:X/FiERA/W4tHapMX5mGpAtMSVEeEUOyHaw9vFzvIQ3k=
 honnef.co/go/tools v0.2.1/go.mod h1:lPVVZ2BS5TfnjLyizF7o7hv7j9/L+8cZY2hLyjP9cGY=
-istio.io/api v0.0.0-20220418200313-202d5d40987b h1:BhtfE4YIp8w1sepvzUvn8xMMyfnR17G5l1CiZ9kJMDM=
-istio.io/api v0.0.0-20220418200313-202d5d40987b/go.mod h1:qGm6l1okCpLqVKyXSfYjB+UXXgpE/LCggALuK25cSFY=
-istio.io/client-go v1.12.0-alpha.5.0.20220418200715-cbfcc8c2be75 h1:wnvL4yisoSB0ID5ySg6rtdBbnCQbCdBUAD2iakWlbxs=
-istio.io/client-go v1.12.0-alpha.5.0.20220418200715-cbfcc8c2be75/go.mod h1:KFKYJzsHAQ4YjRsqi+eiUxCOtLL7QK0VGU8HI8gda1Y=
-istio.io/pkg v0.0.0-20220412163443-dc80e140671f h1:OoXO/LuJ8FwwoCzkutgIsSbSSStcKi2279clFN7h0SI=
-istio.io/pkg v0.0.0-20220412163443-dc80e140671f/go.mod h1:kcBYN5TiyGFM2bs4b7K81j+YeDZ4JrINP+brV9ehZe0=
+istio.io/api v0.0.0-20220420164308-b6a03a9e477e h1:PiNQiNIgEpioHeslnETLn8yjVccRrYwg+Z56bVk7psE=
+istio.io/api v0.0.0-20220420164308-b6a03a9e477e/go.mod h1:qGm6l1okCpLqVKyXSfYjB+UXXgpE/LCggALuK25cSFY=
+istio.io/client-go v1.12.0-alpha.5.0.20220420164809-3baeb1b66473 h1:tGhrthCcYszGL3b5gJnYd4O/xGGtEMEjEg4eyaJVrzM=
+istio.io/client-go v1.12.0-alpha.5.0.20220420164809-3baeb1b66473/go.mod h1:61ugKcsnjNIB6dVhMAYxWADXX45s3f1xJ1DMZy8ePYU=
+istio.io/pkg v0.0.0-20220418200614-813ce651e422 h1:c5+z0k91ZUnPMR+akvTNRo9AnccsTRk50z4MJndXPto=
+istio.io/pkg v0.0.0-20220418200614-813ce651e422/go.mod h1:kcBYN5TiyGFM2bs4b7K81j+YeDZ4JrINP+brV9ehZe0=
 k8s.io/api v0.0.0-20180904230853-4e7be11eab3f/go.mod h1:iuAfoD4hCxJ8Onx9kaTIt30j7jUFS00AXQi6QMi99vA=
 k8s.io/api v0.17.4/go.mod h1:5qxx6vjmwUVG2nHQTKGlLts8Tbok8PzHl4vHtVFuZCA=
 k8s.io/api v0.18.2/go.mod h1:SJCWI7OLzhZSvbY7U8zwNl9UA4o1fizoug34OV/2r78=
diff --git a/manifests/charts/base/crds/crd-all.gen.yaml b/manifests/charts/base/crds/crd-all.gen.yaml
index a683a9e221..043bdb6280 100644
--- a/manifests/charts/base/crds/crd-all.gen.yaml
+++ b/manifests/charts/base/crds/crd-all.gen.yaml
@@ -755,6 +755,21 @@ spec:
                                 type: string
                               type: array
                           type: object
+                        tunnel:
+                          properties:
+                            protocol:
+                              description: Specifies which protocol to use for tunneling
+                                the downstream connection.
+                              type: string
+                            targetHost:
+                              description: Specifies a host to which the downstream
+                                connection is tunneled.
+                              type: string
+                            targetPort:
+                              description: Specifies a port to which the downstream
+                                connection is tunneled.
+                              type: integer
+                          type: object
                       type: object
                   type: object
                 type: array
@@ -1320,6 +1335,21 @@ spec:
                           type: string
                         type: array
                     type: object
+                  tunnel:
+                    properties:
+                      protocol:
+                        description: Specifies which protocol to use for tunneling
+                          the downstream connection.
+                        type: string
+                      targetHost:
+                        description: Specifies a host to which the downstream connection
+                          is tunneled.
+                        type: string
+                      targetPort:
+                        description: Specifies a port to which the downstream connection
+                          is tunneled.
+                        type: integer
+                    type: object
                 type: object
               workloadSelector:
                 properties:
@@ -1950,6 +1980,21 @@ spec:
                                 type: string
                               type: array
                           type: object
+                        tunnel:
+                          properties:
+                            protocol:
+                              description: Specifies which protocol to use for tunneling
+                                the downstream connection.
+                              type: string
+                            targetHost:
+                              description: Specifies a host to which the downstream
+                                connection is tunneled.
+                              type: string
+                            targetPort:
+                              description: Specifies a port to which the downstream
+                                connection is tunneled.
+                              type: integer
+                          type: object
                       type: object
                   type: object
                 type: array
@@ -2515,6 +2560,21 @@ spec:
                           type: string
                         type: array
                     type: object
+                  tunnel:
+                    properties:
+                      protocol:
+                        description: Specifies which protocol to use for tunneling
+                          the downstream connection.
+                        type: string
+                      targetHost:
+                        description: Specifies a host to which the downstream connection
+                          is tunneled.
+                        type: string
+                      targetPort:
+                        description: Specifies a port to which the downstream connection
+                          is tunneled.
+                        type: integer
+                    type: object
                 type: object
               workloadSelector:
                 properties:
diff --git a/manifests/charts/base/files/gen-istio-cluster.yaml b/manifests/charts/base/files/gen-istio-cluster.yaml
index 5c08e32099..b1513695c1 100644
--- a/manifests/charts/base/files/gen-istio-cluster.yaml
+++ b/manifests/charts/base/files/gen-istio-cluster.yaml
@@ -757,6 +757,21 @@ spec:
                                 type: string
                               type: array
                           type: object
+                        tunnel:
+                          properties:
+                            protocol:
+                              description: Specifies which protocol to use for tunneling
+                                the downstream connection.
+                              type: string
+                            targetHost:
+                              description: Specifies a host to which the downstream
+                                connection is tunneled.
+                              type: string
+                            targetPort:
+                              description: Specifies a port to which the downstream
+                                connection is tunneled.
+                              type: integer
+                          type: object
                       type: object
                   type: object
                 type: array
@@ -1322,6 +1337,21 @@ spec:
                           type: string
                         type: array
                     type: object
+                  tunnel:
+                    properties:
+                      protocol:
+                        description: Specifies which protocol to use for tunneling
+                          the downstream connection.
+                        type: string
+                      targetHost:
+                        description: Specifies a host to which the downstream connection
+                          is tunneled.
+                        type: string
+                      targetPort:
+                        description: Specifies a port to which the downstream connection
+                          is tunneled.
+                        type: integer
+                    type: object
                 type: object
               workloadSelector:
                 properties:
@@ -1952,6 +1982,21 @@ spec:
                                 type: string
                               type: array
                           type: object
+                        tunnel:
+                          properties:
+                            protocol:
+                              description: Specifies which protocol to use for tunneling
+                                the downstream connection.
+                              type: string
+                            targetHost:
+                              description: Specifies a host to which the downstream
+                                connection is tunneled.
+                              type: string
+                            targetPort:
+                              description: Specifies a port to which the downstream
+                                connection is tunneled.
+                              type: integer
+                          type: object
                       type: object
                   type: object
                 type: array
@@ -2517,6 +2562,21 @@ spec:
                           type: string
                         type: array
                     type: object
+                  tunnel:
+                    properties:
+                      protocol:
+                        description: Specifies which protocol to use for tunneling
+                          the downstream connection.
+                        type: string
+                      targetHost:
+                        description: Specifies a host to which the downstream connection
+                          is tunneled.
+                        type: string
+                      targetPort:
+                        description: Specifies a port to which the downstream connection
+                          is tunneled.
+                        type: integer
+                    type: object
                 type: object
               workloadSelector:
                 properties:
diff --git a/manifests/charts/istiod-remote/templates/crd-all.gen.yaml b/manifests/charts/istiod-remote/templates/crd-all.gen.yaml
index d1350ed68b..775e53a794 100644
--- a/manifests/charts/istiod-remote/templates/crd-all.gen.yaml
+++ b/manifests/charts/istiod-remote/templates/crd-all.gen.yaml
@@ -756,6 +756,21 @@ spec:
                                 type: string
                               type: array
                           type: object
+                        tunnel:
+                          properties:
+                            protocol:
+                              description: Specifies which protocol to use for tunneling
+                                the downstream connection.
+                              type: string
+                            targetHost:
+                              description: Specifies a host to which the downstream
+                                connection is tunneled.
+                              type: string
+                            targetPort:
+                              description: Specifies a port to which the downstream
+                                connection is tunneled.
+                              type: integer
+                          type: object
                       type: object
                   type: object
                 type: array
@@ -1321,6 +1336,21 @@ spec:
                           type: string
                         type: array
                     type: object
+                  tunnel:
+                    properties:
+                      protocol:
+                        description: Specifies which protocol to use for tunneling
+                          the downstream connection.
+                        type: string
+                      targetHost:
+                        description: Specifies a host to which the downstream connection
+                          is tunneled.
+                        type: string
+                      targetPort:
+                        description: Specifies a port to which the downstream connection
+                          is tunneled.
+                        type: integer
+                    type: object
                 type: object
               workloadSelector:
                 properties:
@@ -1951,6 +1981,21 @@ spec:
                                 type: string
                               type: array
                           type: object
+                        tunnel:
+                          properties:
+                            protocol:
+                              description: Specifies which protocol to use for tunneling
+                                the downstream connection.
+                              type: string
+                            targetHost:
+                              description: Specifies a host to which the downstream
+                                connection is tunneled.
+                              type: string
+                            targetPort:
+                              description: Specifies a port to which the downstream
+                                connection is tunneled.
+                              type: integer
+                          type: object
                       type: object
                   type: object
                 type: array
@@ -2516,6 +2561,21 @@ spec:
                           type: string
                         type: array
                     type: object
+                  tunnel:
+                    properties:
+                      protocol:
+                        description: Specifies which protocol to use for tunneling
+                          the downstream connection.
+                        type: string
+                      targetHost:
+                        description: Specifies a host to which the downstream connection
+                          is tunneled.
+                        type: string
+                      targetPort:
+                        description: Specifies a port to which the downstream connection
+                          is tunneled.
+                        type: integer
+                    type: object
                 type: object
               workloadSelector:
                 properties:
diff --git a/pilot/docker/Dockerfile.proxyv2 b/pilot/docker/Dockerfile.proxyv2
index 2c65cdce21..7b45774882 100644
--- a/pilot/docker/Dockerfile.proxyv2
+++ b/pilot/docker/Dockerfile.proxyv2
@@ -12,7 +12,7 @@ FROM gcr.io/istio-release/base:${BASE_VERSION} as debug
 # It is built on the base distroless image, with iptables binary and libraries added
 # The source can be found at https://github.com/istio/distroless/tree/iptables
 # This version is from commit 6faf2f9348d382c6a95bbc3171b89406103cb0ad.
-FROM gcr.io/istio-release/iptables@sha256:a5d55f7cd308eeb1c0f58271bfbfec260c922d16a56ad34e3a6b5f1bf8ef80a2 as distroless
+FROM gcr.io/istio-release/iptables@sha256:64ba191166d2c3f87815148cc1a9f530b770e0dfe81acb164ab79cbb31da582c as distroless
 
 # This will build the final image based on either debug or distroless from above
 # hadolint ignore=DL3006
diff --git a/pilot/pkg/config/kube/gateway/conversion.go b/pilot/pkg/config/kube/gateway/conversion.go
index f968dcbd59..79430eccb7 100644
--- a/pilot/pkg/config/kube/gateway/conversion.go
+++ b/pilot/pkg/config/kube/gateway/conversion.go
@@ -24,7 +24,6 @@
 	klabels "k8s.io/apimachinery/pkg/labels"
 	k8s "sigs.k8s.io/gateway-api/apis/v1alpha2"
 
-	annotation "istio.io/api/annotation"
 	"istio.io/api/label"
 	istio "istio.io/api/networking/v1alpha3"
 	"istio.io/istio/pilot/pkg/features"
@@ -1436,7 +1435,7 @@ func isAutoPassthrough(obj config.Config, l k8s.Listener) bool {
 	}
 	expectedPort := "15443"
 
-	if port, f := obj.Labels[annotation.NetworkingGatewayPort.Name]; f {
+	if port, f := obj.Labels[label.NetworkingGatewayPort.Name]; f {
 		expectedPort = port
 	}
 	return fmt.Sprint(l.Port) == expectedPort
diff --git a/pilot/pkg/serviceregistry/kube/controller/network.go b/pilot/pkg/serviceregistry/kube/controller/network.go
index a0196f8271..6980ca134e 100644
--- a/pilot/pkg/serviceregistry/kube/controller/network.go
+++ b/pilot/pkg/serviceregistry/kube/controller/network.go
@@ -20,7 +20,6 @@
 
 	"github.com/yl2chen/cidranger"
 
-	"istio.io/api/annotation"
 	"istio.io/api/label"
 	"istio.io/istio/pilot/pkg/model"
 	"istio.io/istio/pkg/cluster"
@@ -246,12 +245,12 @@ func (c *Controller) getGatewayDetails(svc *model.Service) []model.NetworkGatewa
 	// label based gateways
 	// TODO label based gateways could support being the gateway for multiple networks
 	if nw := svc.Attributes.Labels[label.TopologyNetwork.Name]; nw != "" {
-		if gwPortStr := svc.Attributes.Labels[annotation.NetworkingGatewayPort.Name]; gwPortStr != "" {
+		if gwPortStr := svc.Attributes.Labels[label.NetworkingGatewayPort.Name]; gwPortStr != "" {
 			if gwPort, err := strconv.Atoi(gwPortStr); err == nil {
 				return []model.NetworkGateway{{Port: uint32(gwPort), Network: network.ID(nw)}}
 			}
 			log.Warnf("could not parse %q for %s on %s/%s; defaulting to %d",
-				gwPortStr, annotation.NetworkingGatewayPort.Name, svc.Attributes.Namespace, svc.Attributes.Name, DefaultNetworkGatewayPort)
+				gwPortStr, label.NetworkingGatewayPort.Name, svc.Attributes.Namespace, svc.Attributes.Name, DefaultNetworkGatewayPort)
 		}
 		return []model.NetworkGateway{{Port: DefaultNetworkGatewayPort, Network: network.ID(nw)}}
 	}
diff --git a/pilot/pkg/xds/mesh_network_test.go b/pilot/pkg/xds/mesh_network_test.go
index 723c8c2a32..abf21bc759 100644
--- a/pilot/pkg/xds/mesh_network_test.go
+++ b/pilot/pkg/xds/mesh_network_test.go
@@ -26,7 +26,6 @@
 	"k8s.io/apimachinery/pkg/runtime"
 	"k8s.io/apimachinery/pkg/util/rand"
 
-	"istio.io/api/annotation"
 	"istio.io/api/label"
 	meshconfig "istio.io/api/mesh/v1alpha1"
 	networking "istio.io/api/networking/v1alpha3"
@@ -227,7 +226,7 @@ func TestMeshNetworking(t *testing.T) {
 						Labels: map[string]string{
 							label.TopologyNetwork.Name: "network-2",
 							// set the label here to test it = expectation doesn't change since we map back to that via NodePort
-							annotation.NetworkingGatewayPort.Name: "443",
+							label.NetworkingGatewayPort.Name: "443",
 						},
 					},
 					Spec: corev1.ServiceSpec{Type: corev1.ServiceTypeNodePort, Ports: []corev1.ServicePort{{Port: 443, NodePort: 25443}}},
diff --git a/pkg/config/xds/filter_types.gen.go b/pkg/config/xds/filter_types.gen.go
index ff54501eff..2fd87a1446 100644
--- a/pkg/config/xds/filter_types.gen.go
+++ b/pkg/config/xds/filter_types.gen.go
@@ -161,6 +161,7 @@
 	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/clusters/aggregate/v3"
 	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/clusters/dynamic_forward_proxy/v3"
 	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/clusters/redis/v3"
+	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/common/async_files/v3"
 	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/common/dynamic_forward_proxy/v3"
 	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/common/matching/v3"
 	_ "github.com/envoyproxy/go-control-plane/envoy/extensions/common/ratelimit/v3"
diff --git a/prow/release-commit.sh b/prow/release-commit.sh
index b7cf109e55..2a2a308d69 100755
--- a/prow/release-commit.sh
+++ b/prow/release-commit.sh
@@ -32,7 +32,7 @@ DOCKER_HUB=${DOCKER_HUB:-gcr.io/istio-testing}
 GCS_BUCKET=${GCS_BUCKET:-istio-build/dev}
 
 # Use a pinned version in case breaking changes are needed
-BUILDER_SHA=5a7ecb6dc03df10bbb2919d31bfa566017a21a9d
+BUILDER_SHA=7f1056aa6c4e5a892242a605eebb890ffa1f4d59
 
 # Reference to the next minor version of Istio
 # This will create a version like 1.4-alpha.sha
-- 
2.35.3

