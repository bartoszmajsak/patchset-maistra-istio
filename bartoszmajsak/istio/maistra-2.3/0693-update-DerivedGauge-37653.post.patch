From 55a38c19e261f3199102fff910e05854113261b9 Mon Sep 17 00:00:00 2001
From: zirain <hejianpeng2@huawei.com>
Date: Wed, 2 Mar 2022 23:31:58 +0800
Subject: update DerivedGauge (#37653)

* update DerivedGauge

* fix gen & lint
---
 go.mod                            | 2 +-
 go.sum                            | 4 ++--
 pilot/pkg/bootstrap/monitoring.go | 9 ++++++---
 3 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/go.mod b/go.mod
index 7aa3256760..48769fad17 100644
--- a/go.mod
+++ b/go.mod
@@ -83,7 +83,7 @@ require (
 	helm.sh/helm/v3 v3.8.0
 	istio.io/api v0.0.0-20220228212249-7aeedc009f6c
 	istio.io/client-go v1.12.0-alpha.5.0.20220228214528-dedb8df55644
-	istio.io/pkg v0.0.0-20220218005410-1d45ba8be719
+	istio.io/pkg v0.0.0-20220302032005-ee89d7ebd601
 	k8s.io/api v0.23.4
 	k8s.io/apiextensions-apiserver v0.23.1
 	k8s.io/apimachinery v0.23.4
diff --git a/go.sum b/go.sum
index d4b600f1e7..92d73d6b7f 100644
--- a/go.sum
+++ b/go.sum
@@ -2155,8 +2155,8 @@ istio.io/client-go v1.12.0-alpha.5.0.20220228214528-dedb8df55644/go.mod h1:mO5Bb
 istio.io/gogo-genproto v0.0.0-20211208193508-5ab4acc9eb1e/go.mod h1:vJDAniIqryf/z///fgZqVPKJ7N2lBk7Gg8DCTB7oCfU=
 istio.io/gogo-genproto v0.0.0-20220203154911-542602f9bf4f h1:Qz/sQH9I2u8XfasvCNWmdMdjRendJc1gKi5NkLCpS5g=
 istio.io/gogo-genproto v0.0.0-20220203154911-542602f9bf4f/go.mod h1:vJDAniIqryf/z///fgZqVPKJ7N2lBk7Gg8DCTB7oCfU=
-istio.io/pkg v0.0.0-20220218005410-1d45ba8be719 h1:OkRFI0pIPhnUrV1ACV0HgxnetJDEUTZJP8C0/dZMYB0=
-istio.io/pkg v0.0.0-20220218005410-1d45ba8be719/go.mod h1:i95AmfHLCp5JThoiCGCyzZ6bOHJk5fD+BicBvGDr9Xg=
+istio.io/pkg v0.0.0-20220302032005-ee89d7ebd601 h1:WYLBXxA/UJkqgtnow81YEYdDvTx1kGFP0ddHcyv7rfU=
+istio.io/pkg v0.0.0-20220302032005-ee89d7ebd601/go.mod h1:i95AmfHLCp5JThoiCGCyzZ6bOHJk5fD+BicBvGDr9Xg=
 k8s.io/api v0.18.2/go.mod h1:SJCWI7OLzhZSvbY7U8zwNl9UA4o1fizoug34OV/2r78=
 k8s.io/api v0.18.3/go.mod h1:UOaMwERbqJMfeeeHc8XJKawj4P9TgDRnViIqqBeH2QA=
 k8s.io/api v0.18.4/go.mod h1:lOIQAKYgai1+vz9J7YcDZwC26Z0zQewYOGWdyIPUUQ4=
diff --git a/pilot/pkg/bootstrap/monitoring.go b/pilot/pkg/bootstrap/monitoring.go
index d5f825c17f..5b483762e1 100644
--- a/pilot/pkg/bootstrap/monitoring.go
+++ b/pilot/pkg/bootstrap/monitoring.go
@@ -44,12 +44,15 @@ type monitor struct {
 	uptime = monitoring.NewDerivedGauge( // nolint: deadcode, varcheck
 		"istiod_uptime_seconds",
 		"Current istiod server uptime in seconds",
-		func() float64 {
-			return time.Since(serverStart).Seconds()
-		},
 	)
 )
 
+func init() {
+	uptime.ValueFrom(func() float64 {
+		return time.Since(serverStart).Seconds()
+	})
+}
+
 func addMonitor(mux *http.ServeMux) error {
 	exporter, err := ocprom.NewExporter(ocprom.Options{Registry: prometheus.DefaultRegisterer.(*prometheus.Registry)})
 	if err != nil {
-- 
2.35.3

