From 50ac75ad1dd2d892640802492b410bb1c75dfc9e Mon Sep 17 00:00:00 2001
From: zirain <hejianpeng2@huawei.com>
Date: Wed, 9 Mar 2022 16:58:08 +0800
Subject: add otel provider in demo profile (#37819)

* add otel provider in demo profile

* update script
---
 manifests/profiles/demo.yaml     |  5 ++++
 samples/open-telemetry/README.md | 47 +++++++++++---------------------
 2 files changed, 21 insertions(+), 31 deletions(-)

diff --git a/manifests/profiles/demo.yaml b/manifests/profiles/demo.yaml
index 0dd56210d5..2494bd2d2d 100644
--- a/manifests/profiles/demo.yaml
+++ b/manifests/profiles/demo.yaml
@@ -3,6 +3,11 @@ kind: IstioOperator
 spec:
   meshConfig:
     accessLogFile: /dev/stdout
+    extensionProviders:
+    - name: otel
+      envoyOtelAls:
+        service: otel-collector.istio-system.svc.cluster.local
+        port: 4317
   components:
     egressGateways:
     - name: istio-egressgateway
diff --git a/samples/open-telemetry/README.md b/samples/open-telemetry/README.md
index 714814c953..363a042086 100644
--- a/samples/open-telemetry/README.md
+++ b/samples/open-telemetry/README.md
@@ -31,43 +31,27 @@ service:
       exporters: [logging]
 ```
 
-## Modiy istio configmap
+## Update istio configmap
 
-Run the following script to edit the istio MeshConfig, update the YAML files in one step.
+Run the following script to update the `istio` with demo profile:
+
+```bash
+istioctl install --profile demo -y
+```
+
+Next, add a Telemetry resource that tells Istio to send access logs to the OpenTelemetry collector.
 
 ```bash
 cat <<EOF | kubectl apply -n istio-system -f -
-apiVersion: v1
-kind: ConfigMap
+apiVersion: telemetry.istio.io/v1alpha1
+kind: Telemetry
 metadata:
-  name: istio
+  name: mesh-default
   namespace: istio-system
-data:
-  mesh: |-
-    accessLogFile: /dev/stdout
-    defaultConfig:
-      discoveryAddress: istiod.istio-system.svc:15012
-      proxyMetadata: {}
-      tracing:
-        zipkin:
-          address: zipkin.istio-system:9411
-    enablePrometheusMerge: true
-    extensionProviders:
-    - name: otel
-      envoyOtelAls:
-        service: otel-collector.istio-system.svc.cluster.local
-        port: 4317
-        logFormat:
-          labels:
-            "protocol": "%PROTOCOL%"
-            "attempt": "%REQ(X-ENVOY-ATTEMPT-COUNT)%"
-    defaultProviders:
-      accessLogging:
-      - envoy
-      - otel
-    rootNamespace: istio-system
-    trustDomain: cluster.local
-  meshNetworks: 'networks: {}'
+spec:
+  accessLogging:
+    - providers:
+      - name: otel
 EOF
 ```
 
@@ -91,4 +75,5 @@ kubectl logs $(kubectl get po -n istio-system | grep otel | awk '{print $1}') -n
 
 ```bash
 kubectl delete -f otel.yaml
+kubectl delete telemetry mesh-default -nistio-system
 ```
\ No newline at end of file
-- 
2.35.3

