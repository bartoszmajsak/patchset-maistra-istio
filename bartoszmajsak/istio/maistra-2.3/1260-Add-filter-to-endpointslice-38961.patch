From d613b416c9036a5d89f61d17e751bf1e61de1e65 Mon Sep 17 00:00:00 2001
From: Zhonghu Xu <xuzhonghu@huawei.com>
Date: Tue, 17 May 2022 19:38:08 +0800
Subject: Add filter to endpointslice (#38961)

---
 .../pkg/serviceregistry/kube/controller/endpointslice.go | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/pilot/pkg/serviceregistry/kube/controller/endpointslice.go b/pilot/pkg/serviceregistry/kube/controller/endpointslice.go
index ce52bb2295..94f24bb3a6 100644
--- a/pilot/pkg/serviceregistry/kube/controller/endpointslice.go
+++ b/pilot/pkg/serviceregistry/kube/controller/endpointslice.go
@@ -62,15 +62,20 @@ func newEndpointSliceController(c *Controller) *endpointSliceController {
 	} else {
 		informer = c.client.KubeInformer().Discovery().V1beta1().EndpointSlices().Informer()
 	}
+
+	filteredInformer := filter.NewFilteredSharedIndexInformer(
+		c.opts.DiscoveryNamespacesFilter.Filter,
+		informer,
+	)
 	out := &endpointSliceController{
 		kubeEndpoints: kubeEndpoints{
 			c:        c,
-			informer: informer,
+			informer: filteredInformer,
 		},
 		useV1Resource: useV1Resource,
 		endpointCache: newEndpointSliceCache(),
 	}
-	c.registerHandlers(informer, "EndpointSlice", out.onEvent, nil)
+	c.registerHandlers(filteredInformer, "EndpointSlice", out.onEvent, nil)
 	return out
 }
 
-- 
2.35.3

