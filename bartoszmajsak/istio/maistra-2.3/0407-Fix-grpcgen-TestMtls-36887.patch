From c35fa572b02a22dea855539788142073503ca263 Mon Sep 17 00:00:00 2001
From: Zhonghu Xu <xuzhonghu@huawei.com>
Date: Thu, 20 Jan 2022 11:29:01 +0800
Subject: Fix grpcgen TestMtls (#36887)

---
 pilot/pkg/networking/core/v1alpha3/fake.go | 3 +--
 pilot/pkg/xds/fake.go                      | 2 +-
 2 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/pilot/pkg/networking/core/v1alpha3/fake.go b/pilot/pkg/networking/core/v1alpha3/fake.go
index c45fc638f5..cb5257e0aa 100644
--- a/pilot/pkg/networking/core/v1alpha3/fake.go
+++ b/pilot/pkg/networking/core/v1alpha3/fake.go
@@ -141,7 +141,7 @@ func NewConfigGenTest(t test.Failer, opts TestOptions) *ConfigGenTest {
 		serviceDiscovery.AddRegistry(reg)
 	}
 
-	env := &model.Environment{}
+	env := &model.Environment{PushContext: model.NewPushContext()}
 	env.Watcher = mesh.NewFixedWatcher(m)
 	if opts.NetworksWatcher == nil {
 		opts.NetworksWatcher = mesh.NewFixedNetworksWatcher(nil)
@@ -172,7 +172,6 @@ func NewConfigGenTest(t test.Failer, opts TestOptions) *ConfigGenTest {
 		if err := env.InitNetworksManager(&FakeXdsUpdater{}); err != nil {
 			t.Fatal(err)
 		}
-		env.PushContext = model.NewPushContext()
 		if err := env.PushContext.InitContext(env, nil, nil); err != nil {
 			t.Fatalf("Failed to initialize push context: %v", err)
 		}
diff --git a/pilot/pkg/xds/fake.go b/pilot/pkg/xds/fake.go
index dd5dc74cd7..999fb7d6fe 100644
--- a/pilot/pkg/xds/fake.go
+++ b/pilot/pkg/xds/fake.go
@@ -128,7 +128,7 @@ func NewFakeDiscoveryServer(t test.Failer, opts FakeOptions) *FakeDiscoveryServe
 	// Init with a dummy environment, since we have a circular dependency with the env creation.
 	s := NewDiscoveryServer(&model.Environment{PushContext: model.NewPushContext()}, []string{plugin.AuthzCustom, plugin.Authn, plugin.Authz},
 		"pilot-123", "istio-system", map[string]string{})
-	s.InitGenerators(&model.Environment{PushContext: model.NewPushContext()}, "istio-system")
+	s.InitGenerators(s.Env, "istio-system")
 	t.Cleanup(func() {
 		s.JwtKeyResolver.Close()
 		s.pushQueue.ShutDown()
-- 
2.35.3

