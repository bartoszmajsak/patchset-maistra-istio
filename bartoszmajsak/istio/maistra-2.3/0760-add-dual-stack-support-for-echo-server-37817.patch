From 9659be59084957c6264d2a31f071a5b590d757f3 Mon Sep 17 00:00:00 2001
From: ycai-aspen <61984701+ycai-aspen@users.noreply.github.com>
Date: Wed, 9 Mar 2022 12:41:35 -0700
Subject: add dual stack support for echo server (#37817)

---
 pkg/test/echo/server/endpoint/util.go | 23 ++++++++++++++++++++---
 pkg/test/echo/server/instance.go      | 14 +++++++++++---
 2 files changed, 31 insertions(+), 6 deletions(-)

diff --git a/pkg/test/echo/server/endpoint/util.go b/pkg/test/echo/server/endpoint/util.go
index bb008a148c..205cdb1e6b 100644
--- a/pkg/test/echo/server/endpoint/util.go
+++ b/pkg/test/echo/server/endpoint/util.go
@@ -28,7 +28,16 @@
 var epLog = log.RegisterScope("endpoint", "echo serverside", 0)
 
 func listenOnAddress(ip string, port int) (net.Listener, int, error) {
-	ln, err := net.Listen("tcp", net.JoinHostPort(ip, strconv.Itoa(port)))
+	parsedIP := net.ParseIP(ip)
+	ipBind := "tcp"
+	if parsedIP != nil {
+		if parsedIP.To4() == nil && parsedIP.To16() != nil {
+			ipBind = "tcp6"
+		} else if parsedIP.To4() != nil {
+			ipBind = "tcp4"
+		}
+	}
+	ln, err := net.Listen(ipBind, net.JoinHostPort(ip, strconv.Itoa(port)))
 	if err != nil {
 		return nil, 0, err
 	}
@@ -38,11 +47,19 @@ func listenOnAddress(ip string, port int) (net.Listener, int, error) {
 }
 
 func listenOnAddressTLS(ip string, port int, cfg *tls.Config) (net.Listener, int, error) {
-	ln, err := tls.Listen("tcp", net.JoinHostPort(ip, strconv.Itoa(port)), cfg)
+	ipBind := "tcp"
+	parsedIP := net.ParseIP(ip)
+	if parsedIP != nil {
+		if parsedIP.To4() == nil && parsedIP.To16() != nil {
+			ipBind = "tcp6"
+		} else if parsedIP.To4() != nil {
+			ipBind = "tcp4"
+		}
+	}
+	ln, err := tls.Listen(ipBind, net.JoinHostPort(ip, strconv.Itoa(port)), cfg)
 	if err != nil {
 		return nil, 0, err
 	}
-
 	port = ln.Addr().(*net.TCPAddr).Port
 	return ln, port, nil
 }
diff --git a/pkg/test/echo/server/instance.go b/pkg/test/echo/server/instance.go
index b6d496c7bd..fe60e431c9 100644
--- a/pkg/test/echo/server/instance.go
+++ b/pkg/test/echo/server/instance.go
@@ -133,7 +133,7 @@ func (s *Instance) Start() (err error) {
 }
 
 func getBindAddresses(ip string) []string {
-	if ip != "localhost" {
+	if ip != "" && ip != "localhost" {
 		return []string{ip}
 	}
 	// Binding to "localhost" will only bind to a single address (v4 or v6). We want both, so we need
@@ -158,10 +158,18 @@ func getBindAddresses(ip string) []string {
 	}
 	addrs := []string{}
 	if v4 {
-		addrs = append(addrs, "127.0.0.1")
+		if ip == "localhost" {
+			addrs = append(addrs, "127.0.0.1")
+		} else {
+			addrs = append(addrs, "0.0.0.0")
+		}
 	}
 	if v6 {
-		addrs = append(addrs, "::1")
+		if ip == "localhost" {
+			addrs = append(addrs, "::1")
+		} else {
+			addrs = append(addrs, "::")
+		}
 	}
 	return addrs
 }
-- 
2.35.3

