From a960fd7d178c7b33ffc0c73346a2996987cd039d Mon Sep 17 00:00:00 2001
From: Yaroslav Skopets <yaroslav@tetrate.io>
Date: Thu, 10 Mar 2022 21:49:50 +0100
Subject: bootstrap: make file path `/var/run/secrets/tokens/istio-token`
 relative (#37869)

Signed-off-by: Yaroslav Skopets <yaroslav@tetrate.io>
---
 pilot/pkg/networking/core/v1alpha3/tracing.go          | 3 ++-
 pkg/bootstrap/instance_test.go                         | 2 +-
 pkg/bootstrap/testdata/tracing_stackdriver_golden.json | 2 +-
 tools/packaging/common/envoy_bootstrap.json            | 2 +-
 tools/packaging/common/gcp_envoy_bootstrap.json        | 6 +++---
 5 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/pilot/pkg/networking/core/v1alpha3/tracing.go b/pilot/pkg/networking/core/v1alpha3/tracing.go
index 02aef4117d..98cb842105 100644
--- a/pilot/pkg/networking/core/v1alpha3/tracing.go
+++ b/pilot/pkg/networking/core/v1alpha3/tracing.go
@@ -39,6 +39,7 @@
 	xdsfilters "istio.io/istio/pilot/pkg/xds/filters"
 	"istio.io/istio/pilot/pkg/xds/requestidextension"
 	"istio.io/istio/pkg/bootstrap/platform"
+	"istio.io/istio/pkg/config/constants"
 	"istio.io/pkg/log"
 )
 
@@ -210,7 +211,7 @@ func(clusterName string) (*anypb.Any, error) {
 									CredentialSpecifier: &envoy_config_core_v3.GrpcService_GoogleGrpc_CallCredentials_StsService_{
 										StsService: &envoy_config_core_v3.GrpcService_GoogleGrpc_CallCredentials_StsService{
 											TokenExchangeServiceUri: fmt.Sprintf("http://localhost:%d/token", stsPort),
-											SubjectTokenPath:        "/var/run/secrets/tokens/istio-token",
+											SubjectTokenPath:        constants.TrustworthyJWTPath,
 											SubjectTokenType:        "urn:ietf:params:oauth:token-type:jwt",
 											Scope:                   "https://www.googleapis.com/auth/cloud-platform",
 										},
diff --git a/pkg/bootstrap/instance_test.go b/pkg/bootstrap/instance_test.go
index f894685846..045b36d95e 100644
--- a/pkg/bootstrap/instance_test.go
+++ b/pkg/bootstrap/instance_test.go
@@ -212,7 +212,7 @@ func TestGolden(t *testing.T) {
 										CredentialSpecifier: &core.GrpcService_GoogleGrpc_CallCredentials_StsService_{
 											StsService: &core.GrpcService_GoogleGrpc_CallCredentials_StsService{
 												TokenExchangeServiceUri: "http://localhost:15463/token",
-												SubjectTokenPath:        "/var/run/secrets/tokens/istio-token",
+												SubjectTokenPath:        "./var/run/secrets/tokens/istio-token",
 												SubjectTokenType:        "urn:ietf:params:oauth:token-type:jwt",
 												Scope:                   "https://www.googleapis.com/auth/cloud-platform",
 											},
diff --git a/pkg/bootstrap/testdata/tracing_stackdriver_golden.json b/pkg/bootstrap/testdata/tracing_stackdriver_golden.json
index 57d0eae294..0d4cb81ff8 100644
--- a/pkg/bootstrap/testdata/tracing_stackdriver_golden.json
+++ b/pkg/bootstrap/testdata/tracing_stackdriver_golden.json
@@ -519,7 +519,7 @@
           "call_credentials": [{
             "sts_service": {
               "token_exchange_service_uri": "http://localhost:15463/token",
-              "subject_token_path": "/var/run/secrets/tokens/istio-token",
+              "subject_token_path": "./var/run/secrets/tokens/istio-token",
               "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
               "scope": "https://www.googleapis.com/auth/cloud-platform"
             }
diff --git a/tools/packaging/common/envoy_bootstrap.json b/tools/packaging/common/envoy_bootstrap.json
index 78a550911d..a8bd59e40a 100644
--- a/tools/packaging/common/envoy_bootstrap.json
+++ b/tools/packaging/common/envoy_bootstrap.json
@@ -632,7 +632,7 @@
           "call_credentials": [{
             "sts_service": {
               "token_exchange_service_uri": "http://localhost:{{ .sts_port }}/token",
-              "subject_token_path": "/var/run/secrets/tokens/istio-token",
+              "subject_token_path": "./var/run/secrets/tokens/istio-token",
               "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
               "scope": "https://www.googleapis.com/auth/cloud-platform"
             }
diff --git a/tools/packaging/common/gcp_envoy_bootstrap.json b/tools/packaging/common/gcp_envoy_bootstrap.json
index 4db4e5afbc..ca057e28f2 100644
--- a/tools/packaging/common/gcp_envoy_bootstrap.json
+++ b/tools/packaging/common/gcp_envoy_bootstrap.json
@@ -43,7 +43,7 @@
             {{ if .sts }}
               "sts_service": {
                 "token_exchange_service_uri": "http://localhost:{{ .sts_port }}/token",
-                "subject_token_path": "/var/run/secrets/tokens/istio-token",
+                "subject_token_path": "./var/run/secrets/tokens/istio-token",
                 "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
                 "scope": "https://www.googleapis.com/auth/cloud-platform"
               }
@@ -95,7 +95,7 @@
             {{ if .sts }}
               "sts_service": {
                 "token_exchange_service_uri": "http://localhost:{{ .sts_port }}/token",
-                "subject_token_path": "/var/run/secrets/tokens/istio-token",
+                "subject_token_path": "./var/run/secrets/tokens/istio-token",
                 "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
                 "scope": "https://www.googleapis.com/auth/cloud-platform"
               }
@@ -160,7 +160,7 @@
           "call_credentials": [{
             "sts_service": {
               "token_exchange_service_uri": "http://localhost:{{ .sts_port }}/token",
-              "subject_token_path": "/var/run/secrets/tokens/istio-token",
+              "subject_token_path": "./var/run/secrets/tokens/istio-token",
               "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
               "scope": "https://www.googleapis.com/auth/cloud-platform"
             }
-- 
2.35.3

