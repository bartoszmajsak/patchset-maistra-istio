From ca77d06a203998e4778ed36fd705c40b08ae846c Mon Sep 17 00:00:00 2001
From: Xiaopeng Han <hanxiaop8@outlook.com>
Date: Sat, 7 May 2022 00:17:21 +0800
Subject: add headersToDownstreamOnAllow (#37677)

---
 pilot/pkg/security/authz/builder/builder_test.go         | 5 +++--
 pilot/pkg/security/authz/builder/extauthz.go             | 9 ++++++---
 .../builder/testdata/http/custom-http-provider-out2.yaml | 8 ++++++++
 releasenotes/notes/37677.yaml                            | 8 ++++++++
 4 files changed, 25 insertions(+), 5 deletions(-)
 create mode 100644 releasenotes/notes/37677.yaml

diff --git a/pilot/pkg/security/authz/builder/builder_test.go b/pilot/pkg/security/authz/builder/builder_test.go
index b11dee8b2c..455cb05061 100644
--- a/pilot/pkg/security/authz/builder/builder_test.go
+++ b/pilot/pkg/security/authz/builder/builder_test.go
@@ -100,8 +100,9 @@
 							AllowPartialMessage: true,
 							PackAsBytes:         true,
 						},
-						HeadersToUpstreamOnAllow:  []string{"Authorization", "x-prefix-*", "*-suffix"},
-						HeadersToDownstreamOnDeny: []string{"Set-cookie", "x-prefix-*", "*-suffix"},
+						HeadersToUpstreamOnAllow:   []string{"Authorization", "x-prefix-*", "*-suffix"},
+						HeadersToDownstreamOnDeny:  []string{"Set-cookie", "x-prefix-*", "*-suffix"},
+						HeadersToDownstreamOnAllow: []string{"Set-cookie", "x-prefix-*", "*-suffix"},
 					},
 				},
 			},
diff --git a/pilot/pkg/security/authz/builder/extauthz.go b/pilot/pkg/security/authz/builder/extauthz.go
index 151a4b113b..058293af8b 100644
--- a/pilot/pkg/security/authz/builder/extauthz.go
+++ b/pilot/pkg/security/authz/builder/extauthz.go
@@ -178,6 +178,7 @@ func buildExtAuthzHTTP(push *model.PushContext,
 	checkWildcard("IncludeRequestHeadersInCheck", config.IncludeRequestHeadersInCheck)
 	checkWildcard("IncludeHeadersInCheck", config.IncludeHeadersInCheck)
 	checkWildcard("HeadersToDownstreamOnDeny", config.HeadersToDownstreamOnDeny)
+	checkWildcard("HeadersToDownstreamOnAllow", config.HeadersToDownstreamOnAllow)
 	checkWildcard("HeadersToUpstreamOnAllow", config.HeadersToUpstreamOnAllow)
 
 	if errs != nil {
@@ -269,10 +270,12 @@ func generateHTTPConfig(hostname, cluster string, status *envoytypev3.HttpStatus
 		}
 	}
 
-	if len(config.HeadersToUpstreamOnAllow) > 0 || len(config.HeadersToDownstreamOnDeny) > 0 {
+	if len(config.HeadersToUpstreamOnAllow) > 0 || len(config.HeadersToDownstreamOnDeny) > 0 ||
+		len(config.HeadersToDownstreamOnAllow) > 0 {
 		service.AuthorizationResponse = &extauthzhttp.AuthorizationResponse{
-			AllowedUpstreamHeaders: generateHeaders(config.HeadersToUpstreamOnAllow),
-			AllowedClientHeaders:   generateHeaders(config.HeadersToDownstreamOnDeny),
+			AllowedUpstreamHeaders:        generateHeaders(config.HeadersToUpstreamOnAllow),
+			AllowedClientHeaders:          generateHeaders(config.HeadersToDownstreamOnDeny),
+			AllowedClientHeadersOnSuccess: generateHeaders(config.HeadersToDownstreamOnAllow),
 		}
 	}
 	http := &extauthzhttp.ExtAuthz{
diff --git a/pilot/pkg/security/authz/builder/testdata/http/custom-http-provider-out2.yaml b/pilot/pkg/security/authz/builder/testdata/http/custom-http-provider-out2.yaml
index 24a351c85d..0a12b42622 100644
--- a/pilot/pkg/security/authz/builder/testdata/http/custom-http-provider-out2.yaml
+++ b/pilot/pkg/security/authz/builder/testdata/http/custom-http-provider-out2.yaml
@@ -33,6 +33,14 @@ typedConfig:
           prefix: x-prefix-
         - ignoreCase: true
           suffix: -suffix
+      allowedClientHeadersOnSuccess:
+        patterns:
+        - exact: Set-cookie
+          ignoreCase: true
+        - ignoreCase: true
+          prefix: x-prefix-
+        - ignoreCase: true
+          suffix: -suffix
       allowedUpstreamHeaders:
         patterns:
         - exact: Authorization
diff --git a/releasenotes/notes/37677.yaml b/releasenotes/notes/37677.yaml
new file mode 100644
index 0000000000..6537121687
--- /dev/null
+++ b/releasenotes/notes/37677.yaml
@@ -0,0 +1,8 @@
+apiVersion: release-notes/v2
+kind: feature
+area: security
+issue:
+  - https://github.com/istio/istio/issues/36950
+releaseNotes:
+  - |
+    **Added** `allowed_client_headers_on_success` feature for istio external authz.
-- 
2.35.3

