From 370e0305d3a75bc393a871e2718795570c3a5fa0 Mon Sep 17 00:00:00 2001
From: AndreaM12345 <ayma@us.ibm.com>
Date: Thu, 12 May 2022 10:59:35 -0500
Subject: update flaky testcases for envoy filter (#38862)

---
 .../analysis/analyzers/analyzers_test.go      |  7 +-
 .../envoy-filter-merge-operation.yaml         | 17 +----
 .../envoy-filter-replace-operation.yaml       | 71 ++-----------------
 3 files changed, 11 insertions(+), 84 deletions(-)

diff --git a/pkg/config/analysis/analyzers/analyzers_test.go b/pkg/config/analysis/analyzers/analyzers_test.go
index 88bf1f47ef..b7556874a7 100644
--- a/pkg/config/analysis/analyzers/analyzers_test.go
+++ b/pkg/config/analysis/analyzers/analyzers_test.go
@@ -680,9 +680,8 @@ type testCase struct {
 		analyzer:   &envoyfilter.EnvoyPatchAnalyzer{},
 		expected: []message{
 			{msg.EnvoyFilterUsesReplaceOperationIncorrectly, "EnvoyFilter bookinfo/test-replace-1"},
-			{msg.EnvoyFilterUsesRelativeOperation, "EnvoyFilter bookinfo/test-replace-2"},
-			{msg.EnvoyFilterUsesRelativeOperationWithProxyVersion, "EnvoyFilter bookinfo/test-replace-4"},
-			{msg.EnvoyFilterUsesRelativeOperation, "EnvoyFilter bookinfo/test-replace-4"},
+			{msg.EnvoyFilterUsesRelativeOperationWithProxyVersion, "EnvoyFilter bookinfo/test-replace-3"},
+			{msg.EnvoyFilterUsesRelativeOperation, "EnvoyFilter bookinfo/test-replace-3"},
 		},
 	},
 	{
@@ -712,7 +711,7 @@ type testCase struct {
 		expected: []message{
 			{msg.EnvoyFilterUsesRelativeOperation, "EnvoyFilter bookinfo/test-merge-1"},
 			{msg.EnvoyFilterUsesRelativeOperation, "EnvoyFilter bookinfo/test-merge-3"},
-			{msg.EnvoyFilterUsesRelativeOperationWithProxyVersion, "EnvoyFilter bookinfo/test-merge-4"},
+			{msg.EnvoyFilterUsesRelativeOperationWithProxyVersion, "EnvoyFilter bookinfo/test-merge-3"},
 		},
 	},
 }
diff --git a/pkg/config/analysis/analyzers/testdata/envoy-filter-merge-operation.yaml b/pkg/config/analysis/analyzers/testdata/envoy-filter-merge-operation.yaml
index fefddba776..6b5cd8183e 100644
--- a/pkg/config/analysis/analyzers/testdata/envoy-filter-merge-operation.yaml
+++ b/pkg/config/analysis/analyzers/testdata/envoy-filter-merge-operation.yaml
@@ -47,7 +47,7 @@ spec:
         filterChain:
           sni: app.example.com
           filter:
-            name: "envoy.filters.network.http_connection_manager"
+            name: "envoy.filters.network.http_connection_manager.InternalAddressConfig"
     patch:
       operation: MERGE
       value:
@@ -67,7 +67,7 @@ spec:
   workloadSelector:
     labels:
       istio: ingressgateway
-      app: merge3
+      appp: merge4
   configPatches:
   - applyTo: NETWORK_FILTER # http connection manager is a filter in Envoy
     match:
@@ -87,19 +87,6 @@ spec:
           xff_num_trusted_hops: 5
           common_http_protocol_options:
             idle_timeout: 30s
-
----
-apiVersion: networking.istio.io/v1alpha3
-kind: EnvoyFilter
-metadata:
-  name: test-merge-4
-  namespace: bookinfo
-spec:
-  workloadSelector:
-    labels:
-      istio: ingressgateway
-      appp: merge4
-  configPatches:
   - applyTo: NETWORK_FILTER # http connection manager is a filter in Envoy
     match:
       context: GATEWAY
diff --git a/pkg/config/analysis/analyzers/testdata/envoy-filter-replace-operation.yaml b/pkg/config/analysis/analyzers/testdata/envoy-filter-replace-operation.yaml
index ee8b3d857d..49866412ff 100644
--- a/pkg/config/analysis/analyzers/testdata/envoy-filter-replace-operation.yaml
+++ b/pkg/config/analysis/analyzers/testdata/envoy-filter-replace-operation.yaml
@@ -11,30 +11,6 @@ spec:
       app: reviews1
   priority: 10
   configPatches:
-  - applyTo: HTTP_FILTER
-    match:
-      context: SIDECAR_INBOUND
-    patch:
-      operation: REPLACE
-      value: # Lua filter specification
-       name: envoy.lua
-       typed_config:
-          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
-          inlineCode: |
-            function envoy_on_request(request_handle)
-              -- Make an HTTP call to an upstream host with the following headers, body, and timeout.
-              local headers, body = request_handle:httpCall(
-               "lua_cluster",
-               {
-                [":method"] = "POST",
-                [":path"] = "/acl",
-                [":authority"] = "internal.org.net"
-               },
-              "authorize call",
-              5000)
-            end
-  # The second patch adds the cluster that is referenced by the Lua code
-  # cds match is omitted as a new cluster is being added
   - applyTo: CLUSTER
     match:
       context: SIDECAR_OUTBOUND
@@ -55,7 +31,6 @@ spec:
                     protocol: TCP
                     address: "internal.org.net"
                     port_value: 8888
-
 ---
 apiVersion: networking.istio.io/v1alpha3
 kind: EnvoyFilter
@@ -66,6 +41,7 @@ spec:
   workloadSelector:
     labels:
       app: reviews2
+  priority: 10
   configPatches:
     # The first patch adds the Lua filter to the listener/http connection manager
   - applyTo: HTTP_FILTER
@@ -81,7 +57,7 @@ spec:
     patch:
       operation: REPLACE
       value: # Lua filter specification
-       name: envoy2.lua
+       name: envoy.lua
        typed_config:
           "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
           inlineCode: |
@@ -97,30 +73,8 @@ spec:
               "authorize call",
               5000)
             end
-  # The second patch adds the cluster that is referenced by the Lua code
-  # cds match is omitted as a new cluster is being added
-  - applyTo: CLUSTER
-    match:
-      context: SIDECAR_OUTBOUND
-    patch:
-      operation: ADD
-      value: # cluster specification
-        name: "lua_cluster2"
-        type: STRICT_DNS
-        connect_timeout: 0.5s
-        lb_policy: ROUND_ROBIN
-        load_assignment:
-          cluster_name: lua_cluster
-          endpoints:
-          - lb_endpoints:
-            - endpoint:
-                address:
-                  socket_address:
-                    protocol: TCP
-                    address: "internal.org.net"
-                    port_value: 8888
 
----
+---           
 apiVersion: networking.istio.io/v1alpha3
 kind: EnvoyFilter
 metadata:
@@ -129,13 +83,12 @@ metadata:
 spec:
   workloadSelector:
     labels:
-      app: reviews3
-  priority: 10
+      app: reviews4
   configPatches:
     # The first patch adds the Lua filter to the listener/http connection manager
   - applyTo: HTTP_FILTER
     match:
-      context: SIDECAR_INBOUND
+      context: SIDECAR_OUTBOUND
       proxy:
         proxyVersion: '^1\.11.*'
       listener:
@@ -164,18 +117,6 @@ spec:
               "authorize call",
               5000)
             end
-
----            
-apiVersion: networking.istio.io/v1alpha3
-kind: EnvoyFilter
-metadata:
-  name: test-replace-4
-  namespace: bookinfo
-spec:
-  workloadSelector:
-    labels:
-      app: reviews4
-  configPatches:
   - applyTo: HTTP_FILTER
     match:
       context: SIDECAR_INBOUND
@@ -198,7 +139,7 @@ spec:
               "authorize call",
               5000)
             end
-  # The second patch adds the cluster that is referenced by the lua code
+  # The third patch adds the cluster that is referenced by the lua code
   # cds match is omitted as a new cluster is being added
   - applyTo: NETWORK_FILTER
     match:
-- 
2.35.3

