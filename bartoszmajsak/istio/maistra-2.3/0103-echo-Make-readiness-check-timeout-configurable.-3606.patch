From acbe753915fe8510785e703172ceda46a10ec9ab Mon Sep 17 00:00:00 2001
From: Pengyuan Bian <bianpengyuan@google.com>
Date: Mon, 15 Nov 2021 08:14:25 -0800
Subject: [echo] Make readiness check timeout configurable. (#36065)

---
 pkg/test/framework/components/echo/common/config.go |  3 +--
 pkg/test/framework/components/echo/flags.go         | 12 ++++++++++--
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/pkg/test/framework/components/echo/common/config.go b/pkg/test/framework/components/echo/common/config.go
index b2f7f1ed6c..06b2662927 100644
--- a/pkg/test/framework/components/echo/common/config.go
+++ b/pkg/test/framework/components/echo/common/config.go
@@ -17,7 +17,6 @@
 import (
 	"fmt"
 	"strings"
-	"time"
 
 	"istio.io/istio/pkg/config/constants"
 	"istio.io/istio/pkg/config/protocol"
@@ -134,7 +133,7 @@ func FillInDefaults(ctx resource.Context, c *echo.Config) (err error) {
 	// If readiness probe is not specified by a test, wait a long time
 	// Waiting forever would cause the test to timeout and lose logs
 	if c.ReadinessTimeout == 0 {
-		c.ReadinessTimeout = time.Minute * 10
+		c.ReadinessTimeout = echo.DefaultReadinessTimeout()
 	}
 
 	return nil
diff --git a/pkg/test/framework/components/echo/flags.go b/pkg/test/framework/components/echo/flags.go
index d2ba6dd9bf..bb9b90e955 100644
--- a/pkg/test/framework/components/echo/flags.go
+++ b/pkg/test/framework/components/echo/flags.go
@@ -22,8 +22,9 @@
 )
 
 var (
-	callTimeout = 20 * time.Second
-	callDelay   = 10 * time.Millisecond
+	callTimeout      = 20 * time.Second
+	callDelay        = 10 * time.Millisecond
+	readinessTimeout = 10 * time.Minute
 )
 
 // init registers the command-line flags that we can exposed for "go test".
@@ -32,9 +33,16 @@ func init() {
 		"Specifies the default total timeout used when retrying calls to the Echo service")
 	flag.DurationVar(&callDelay, "istio.test.echo.callDelay", callDelay,
 		"Specifies the default delay between successive retry attempts when calling the Echo service")
+	flag.DurationVar(&readinessTimeout, "istio.test.echo.readinessTimeout", readinessTimeout,
+		"Specifies the default timeout for echo readiness check")
 }
 
 // DefaultCallRetryOptions returns the default call retry options as specified in command-line flags.
 func DefaultCallRetryOptions() []retry.Option {
 	return []retry.Option{retry.Timeout(callTimeout), retry.BackoffDelay(callDelay)}
 }
+
+// DefaultReadinessTimeout returns the default echo readiness check timeout.
+func DefaultReadinessTimeout() time.Duration {
+	return readinessTimeout
+}
-- 
2.35.3

