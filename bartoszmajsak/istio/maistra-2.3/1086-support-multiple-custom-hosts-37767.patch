From 140362f169ddd36eb3782790d4af6646f5056d6f Mon Sep 17 00:00:00 2001
From: shirleyyLi <77613248+shirleyyLi@users.noreply.github.com>
Date: Thu, 21 Apr 2022 15:10:14 +0800
Subject: support multiple custom hosts (#37767)

* support multiple custom hosts

* update IstiodServiceCustomHost help message
---
 pilot/pkg/bootstrap/server.go | 20 ++++++++++++++------
 pilot/pkg/features/pilot.go   |  7 ++++---
 2 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/pilot/pkg/bootstrap/server.go b/pilot/pkg/bootstrap/server.go
index e81a2dfba0..fada586ac4 100644
--- a/pilot/pkg/bootstrap/server.go
+++ b/pilot/pkg/bootstrap/server.go
@@ -954,9 +954,12 @@ func (s *Server) initIstiodCerts(args *PilotArgs, host string) error {
 	// Append custom hostname if there is any
 	customHost := features.IstiodServiceCustomHost
 	s.dnsNames = []string{host}
-	if customHost != "" && customHost != host {
-		log.Infof("Adding custom hostname %s", customHost)
-		s.dnsNames = append(s.dnsNames, customHost)
+	cHosts := strings.Split(customHost, ",")
+	for _, cHost := range cHosts {
+		if cHost != "" && cHost != host {
+			log.Infof("Adding custom hostname %s", cHost)
+			s.dnsNames = append(s.dnsNames, cHost)
+		}
 	}
 
 	// The first is the recommended one, also used by Apiserver for webhooks.
@@ -970,10 +973,15 @@ func (s *Server) initIstiodCerts(args *PilotArgs, host string) error {
 
 	for _, altName := range knownHosts {
 		name := fmt.Sprintf("%v.%v.svc", altName, args.Namespace)
-		if name == host || name == customHost {
-			continue
+		exist := false
+		for _, cHost := range cHosts {
+			if name == host || name == cHost {
+				exist = true
+			}
+		}
+		if !exist {
+			s.dnsNames = append(s.dnsNames, name)
 		}
-		s.dnsNames = append(s.dnsNames, name)
 	}
 
 	if hasCustomTLSCerts(args.ServerOptions.TLSOptions) {
diff --git a/pilot/pkg/features/pilot.go b/pilot/pkg/features/pilot.go
index 83aec9f23f..372799c482 100644
--- a/pilot/pkg/features/pilot.go
+++ b/pilot/pkg/features/pilot.go
@@ -343,10 +343,11 @@
 		" Pilot will use to keep configuration status up to date.  Smaller numbers will result in higher status latency, "+
 		"but larger numbers may impact CPU in high scale environments.").Get()
 
-	// IstiodServiceCustomHost allow user to bring a custom address for istiod server
-	// for examples: istiod.mycompany.com
+	// IstiodServiceCustomHost allow user to bring a custom address or multiple custom addresses for istiod server
+	// for examples: 1. istiod.mycompany.com  2. istiod.mycompany.com,istiod-canary.mycompany.com
 	IstiodServiceCustomHost = env.RegisterStringVar("ISTIOD_CUSTOM_HOST", "",
-		"Custom host name of istiod that istiod signs the server cert.").Get()
+		"Custom host name of istiod that istiod signs the server cert. "+
+			"Multiple custom host names are supported, and multiple values are separated by commas.").Get()
 
 	PilotCertProvider = env.RegisterStringVar("PILOT_CERT_PROVIDER", constants.CertProviderIstiod,
 		"The provider of Pilot DNS certificate.").Get()
-- 
2.35.3

