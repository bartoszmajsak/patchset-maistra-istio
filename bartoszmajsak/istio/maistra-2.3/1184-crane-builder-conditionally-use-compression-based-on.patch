From 2cf68461d8430e8015cda90e8ee358f5c03a0eeb Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Thu, 5 May 2022 06:43:00 -0700
Subject: crane builder: conditionally use compression based on upstream
 (#38734)

---
 tools/docker-builder/builder/crane.go | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/tools/docker-builder/builder/crane.go b/tools/docker-builder/builder/crane.go
index 44b020c489..f6392bb005 100644
--- a/tools/docker-builder/builder/crane.go
+++ b/tools/docker-builder/builder/crane.go
@@ -20,6 +20,7 @@
 	"fmt"
 	"io"
 	"io/ioutil"
+	"strings"
 	"sync"
 	"time"
 
@@ -184,9 +185,18 @@ func Build(args Args, dests []string) error {
 		return err
 	}
 	sz := ByteCount(int64(buf.Len()))
+
+	// Over localhost, compression CPU can be the bottleneck. With remotes, compressing usually saves a lot of time.
+	compression := gzip.NoCompression
+	for _, d := range dests {
+		if !strings.HasPrefix(d, "localhost") {
+			compression = gzip.BestSpeed
+			break
+		}
+	}
 	l, err := tarball.LayerFromOpener(func() (io.ReadCloser, error) {
 		return ioutil.NopCloser(bytes.NewReader(buf.Bytes())), nil
-	}, tarball.WithCompressionLevel(gzip.NoCompression))
+	}, tarball.WithCompressionLevel(compression))
 	if err != nil {
 		return err
 	}
-- 
2.35.3

