From 9484889bbefefe1c06d99fe38fad6ee47f35bd6b Mon Sep 17 00:00:00 2001
From: Morven Cao <lcao@redhat.com>
Date: Mon, 21 Mar 2022 11:30:00 +0800
Subject: fix env map order in helm values. (#37982)

---
 operator/pkg/translate/translate_value.go     |  27 +-
 .../pkg/translate/translate_value_test.go     | 253 ++++++++++++++++++
 2 files changed, 271 insertions(+), 9 deletions(-)

diff --git a/operator/pkg/translate/translate_value.go b/operator/pkg/translate/translate_value.go
index 9433c35938..c056d7cf05 100644
--- a/operator/pkg/translate/translate_value.go
+++ b/operator/pkg/translate/translate_value.go
@@ -16,6 +16,7 @@
 
 import (
 	"fmt"
+	"sort"
 	"strings"
 
 	"sigs.k8s.io/yaml"
@@ -513,22 +514,30 @@ func translateEnv(outPath string, value interface{}, cpSpecTree map[string]inter
 	if !found || strings.TrimSpace(string(envValStr)) == "{}" {
 		scope.Debugf("path doesn't have value in k8s setting with output path %s, override with helm Value.yaml tree", outPath)
 		outEnv := make([]map[string]interface{}, len(envMap))
-		cnt := 0
-		for k, v := range envMap {
-			outEnv[cnt] = make(map[string]interface{})
-			outEnv[cnt]["name"] = k
-			outEnv[cnt]["value"] = fmt.Sprintf("%v", v)
-			cnt++
+		keys := make([]string, 0, len(envMap))
+		for k := range envMap {
+			keys = append(keys, k)
+		}
+		sort.Strings(keys)
+		for i, k := range keys {
+			outEnv[i] = make(map[string]interface{})
+			outEnv[i]["name"] = k
+			outEnv[i]["value"] = fmt.Sprintf("%v", envMap[k])
 		}
 		if err := tpath.WriteNode(cpSpecTree, util.ToYAMLPath(outPath), outEnv); err != nil {
 			return err
 		}
 	} else {
 		scope.Debugf("path has value in k8s setting with output path %s, merge it with helm Value.yaml tree", outPath)
-		outEnv := make(map[string]interface{})
-		for k, v := range envMap {
+		keys := make([]string, 0, len(envMap))
+		for k := range envMap {
+			keys = append(keys, k)
+		}
+		sort.Strings(keys)
+		for _, k := range keys {
+			outEnv := make(map[string]interface{})
 			outEnv["name"] = k
-			outEnv["value"] = fmt.Sprintf("%v", v)
+			outEnv["value"] = fmt.Sprintf("%v", envMap[k])
 			if err := tpath.MergeNode(cpSpecTree, util.ToYAMLPath(outPath), outEnv); err != nil {
 				return err
 			}
diff --git a/operator/pkg/translate/translate_value_test.go b/operator/pkg/translate/translate_value_test.go
index cdac5e4972..8c887f40cf 100644
--- a/operator/pkg/translate/translate_value_test.go
+++ b/operator/pkg/translate/translate_value_test.go
@@ -576,6 +576,259 @@ func TestValueToK8s(t *testing.T) {
       traceSampling: 1.0
       image: pilot
       env: {}
+`,
+		},
+		{
+			desc: "pilot no env k8s setting with multiple env variables in values",
+			inIOPSpec: `
+spec:
+  components:
+    pilot:
+      k8s:
+        nodeSelector:
+          master: "true"
+  values:
+    pilot:
+      enabled: true
+      rollingMaxSurge: 100%
+      rollingMaxUnavailable: 25%
+      resources:
+        requests:
+          cpu: 1000m
+          memory: 1G
+      replicaCount: 1
+      nodeSelector:
+        kubernetes.io/os: linux
+      tolerations:
+      - key: dedicated
+        operator: Exists
+        effect: NoSchedule
+      - key: CriticalAddonsOnly
+        operator: Exists
+      autoscaleEnabled: true
+      autoscaleMax: 3
+      autoscaleMin: 1
+      cpu:
+        targetAverageUtilization: 80
+      traceSampling: 1.0
+      image: pilot
+      env:
+        PILOT_ENABLE_ISTIO_TAGS: false
+        PILOT_ENABLE_LEGACY_ISTIO_MUTUAL_CREDENTIAL_NAME: false
+        PROXY_XDS_DEBUG_VIA_AGENT: false
+    global:
+      hub: docker.io/istio
+      tag: 1.2.3
+      istioNamespace: istio-system
+      proxy:
+        readinessInitialDelaySeconds: 2
+`,
+			want: `
+spec:
+  components:
+    pilot:
+      k8s:
+        env:
+        - name: PILOT_ENABLE_ISTIO_TAGS
+          value: "false"
+        - name: PILOT_ENABLE_LEGACY_ISTIO_MUTUAL_CREDENTIAL_NAME
+          value: "false"
+        - name: PROXY_XDS_DEBUG_VIA_AGENT
+          value: "false"
+        hpaSpec:
+          minReplicas: 1
+          maxReplicas: 3
+          scaleTargetRef:
+            apiVersion: apps/v1
+            kind: Deployment
+            name: istiod
+          metrics:
+          - type: Resource
+            resource:
+              name: cpu
+              targetAverageUtilization: 80
+        nodeSelector:
+          master: "true"
+          kubernetes.io/os: linux
+        replicaCount: 1
+        resources:
+          requests:
+            cpu: 1000m
+            memory: 1G
+        strategy:
+          rollingUpdate:
+            maxSurge: 100%
+            maxUnavailable: 25%
+        tolerations:
+        - effect: NoSchedule
+          key: dedicated
+          operator: Exists
+        - key: CriticalAddonsOnly
+          operator: Exists
+  values:
+    global:
+      hub: docker.io/istio
+      tag: 1.2.3
+      istioNamespace: istio-system
+      proxy:
+        readinessInitialDelaySeconds: 2
+    pilot:
+      enabled: true
+      rollingMaxSurge: 100%
+      rollingMaxUnavailable: 25%
+      resources:
+        requests:
+          cpu: 1000m
+          memory: 1G
+      replicaCount: 1
+      nodeSelector:
+        kubernetes.io/os: linux
+      tolerations:
+      - key: dedicated
+        operator: Exists
+        effect: NoSchedule
+      - key: CriticalAddonsOnly
+        operator: Exists
+      autoscaleEnabled: true
+      autoscaleMax: 3
+      autoscaleMin: 1
+      cpu:
+        targetAverageUtilization: 80
+      traceSampling: 1.0
+      image: pilot
+      env:
+        PILOT_ENABLE_ISTIO_TAGS: false
+        PILOT_ENABLE_LEGACY_ISTIO_MUTUAL_CREDENTIAL_NAME: false
+        PROXY_XDS_DEBUG_VIA_AGENT: false
+`,
+		},
+		{
+			desc: "pilot k8s setting with multiple env variables in values",
+			inIOPSpec: `
+spec:
+  components:
+    pilot:
+      k8s:
+        nodeSelector:
+          master: "true"
+        env:
+        - name: SPIFFE_BUNDLE_ENDPOINTS
+          value: "SPIFFE_BUNDLE_ENDPOINT"
+  values:
+    pilot:
+      enabled: true
+      rollingMaxSurge: 100%
+      rollingMaxUnavailable: 25%
+      resources:
+        requests:
+          cpu: 1000m
+          memory: 1G
+      replicaCount: 1
+      nodeSelector:
+        kubernetes.io/os: linux
+      tolerations:
+      - key: dedicated
+        operator: Exists
+        effect: NoSchedule
+      - key: CriticalAddonsOnly
+        operator: Exists
+      autoscaleEnabled: true
+      autoscaleMax: 3
+      autoscaleMin: 1
+      cpu:
+        targetAverageUtilization: 80
+      traceSampling: 1.0
+      image: pilot
+      env:
+        PILOT_ENABLE_ISTIO_TAGS: false
+        PILOT_ENABLE_LEGACY_ISTIO_MUTUAL_CREDENTIAL_NAME: false
+        PROXY_XDS_DEBUG_VIA_AGENT: false
+    global:
+      hub: docker.io/istio
+      tag: 1.2.3
+      istioNamespace: istio-system
+      proxy:
+        readinessInitialDelaySeconds: 2
+`,
+			want: `
+spec:
+  components:
+    pilot:
+      k8s:
+        env:
+        - name: SPIFFE_BUNDLE_ENDPOINTS
+          value: "SPIFFE_BUNDLE_ENDPOINT"
+        - name: PILOT_ENABLE_ISTIO_TAGS
+          value: "false"
+        - name: PILOT_ENABLE_LEGACY_ISTIO_MUTUAL_CREDENTIAL_NAME
+          value: "false"
+        - name: PROXY_XDS_DEBUG_VIA_AGENT
+          value: "false"
+        hpaSpec:
+          minReplicas: 1
+          maxReplicas: 3
+          scaleTargetRef:
+            apiVersion: apps/v1
+            kind: Deployment
+            name: istiod
+          metrics:
+          - type: Resource
+            resource:
+              name: cpu
+              targetAverageUtilization: 80
+        nodeSelector:
+          master: "true"
+          kubernetes.io/os: linux
+        replicaCount: 1
+        resources:
+          requests:
+            cpu: 1000m
+            memory: 1G
+        strategy:
+          rollingUpdate:
+            maxSurge: 100%
+            maxUnavailable: 25%
+        tolerations:
+        - effect: NoSchedule
+          key: dedicated
+          operator: Exists
+        - key: CriticalAddonsOnly
+          operator: Exists
+  values:
+    global:
+      hub: docker.io/istio
+      tag: 1.2.3
+      istioNamespace: istio-system
+      proxy:
+        readinessInitialDelaySeconds: 2
+    pilot:
+      enabled: true
+      rollingMaxSurge: 100%
+      rollingMaxUnavailable: 25%
+      resources:
+        requests:
+          cpu: 1000m
+          memory: 1G
+      replicaCount: 1
+      nodeSelector:
+        kubernetes.io/os: linux
+      tolerations:
+      - key: dedicated
+        operator: Exists
+        effect: NoSchedule
+      - key: CriticalAddonsOnly
+        operator: Exists
+      autoscaleEnabled: true
+      autoscaleMax: 3
+      autoscaleMin: 1
+      cpu:
+        targetAverageUtilization: 80
+      traceSampling: 1.0
+      image: pilot
+      env:
+        PILOT_ENABLE_ISTIO_TAGS: false
+        PILOT_ENABLE_LEGACY_ISTIO_MUTUAL_CREDENTIAL_NAME: false
+        PROXY_XDS_DEBUG_VIA_AGENT: false
 `,
 		},
 		{
-- 
2.35.3

