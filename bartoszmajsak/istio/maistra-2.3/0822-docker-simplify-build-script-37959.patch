From c1337f586601562953804293b388563cdddc166b Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Wed, 16 Mar 2022 08:32:33 -0700
Subject: docker: simplify build script (#37959)

Re-use common logic for setting up environment
---
 tools/docker | 26 +++++++++-----------------
 1 file changed, 9 insertions(+), 17 deletions(-)

diff --git a/tools/docker b/tools/docker
index 2033d9ebd1..f79a3c44d0 100755
--- a/tools/docker
+++ b/tools/docker
@@ -18,30 +18,22 @@ WD=$(dirname "$0")
 WD=$(cd "$WD"; pwd)
 ROOT=$(dirname "$WD")
 
-set -eu
-
-# LOCAL_OUT is set when runing in a Makefile and set to current architecture (not host)
-if [[ ! -z "${LOCAL_OUT+.}" ]]; then
-  OS_ARCH=${LOCAL_OUT##*/}
-  LOCAL_TARGET_OS=${OS_ARCH%_*}
-  LOCAL_TARGET_ARCH=${OS_ARCH##*_}
-else
-  LOCAL_TARGET_OS=${TARGET_OS:-linux}
-  LOCAL_TARGET_ARCH=${TARGET_ARCH:-amd64}
-fi
-
 cd "${ROOT}"
 
+set -eu
+
+# Setup env vars
+export $(./common/scripts/setup_env.sh envfile | xargs)
 export REPO_ROOT="${ROOT}"
 
-if [[ -f out/${LOCAL_TARGET_OS}_${LOCAL_TARGET_ARCH}/docker-builder ]]; then
+if [[ -f ${TARGET_OUT}/docker-builder ]]; then
   CURRENT_BUILD="$(./common/scripts/report_build_info.sh | grep buildGitRevision | cut -d= -f2)"
-  PREBUILT="$(out/${LOCAL_TARGET_OS}_${LOCAL_TARGET_ARCH}/docker-builder --version)"
+  PREBUILT="$(${TARGET_OUT}/docker-builder --version)"
   CODE_CHG="$(git diff ./tools/docker-builder)"
   if [[ "${CURRENT_BUILD}" != "${PREBUILT}" ]] || [[ -n "${CODE_CHG}" ]]; then
-    GOOS=${LOCAL_TARGET_OS} GOARCH=${LOCAL_TARGET_ARCH} ./common/scripts/gobuild.sh out/${LOCAL_TARGET_OS}_${LOCAL_TARGET_ARCH}/docker-builder ./tools/docker-builder
+    GOOS=${TARGET_OS} GOARCH=${TARGET_ARCH} ./common/scripts/gobuild.sh ${TARGET_OUT}/docker-builder ./tools/docker-builder
   fi
 else
-  GOOS=${LOCAL_TARGET_OS} GOARCH=${LOCAL_TARGET_ARCH} ./common/scripts/gobuild.sh out/${LOCAL_TARGET_OS}_${LOCAL_TARGET_ARCH}/docker-builder ./tools/docker-builder
+  GOOS=${TARGET_OS} GOARCH=${TARGET_ARCH} ./common/scripts/gobuild.sh ${TARGET_OUT}/docker-builder ./tools/docker-builder
 fi
-out/${LOCAL_TARGET_OS}_${LOCAL_TARGET_ARCH}/docker-builder "$@"
+${TARGET_OUT}/docker-builder "$@"
-- 
2.35.3

