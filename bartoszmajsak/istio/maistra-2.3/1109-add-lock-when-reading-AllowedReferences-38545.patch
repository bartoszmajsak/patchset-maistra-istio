From afeef1be97a497e7ddf5f9e7555ae7bc8bef3959 Mon Sep 17 00:00:00 2001
From: dwq <41563853+dddddai@users.noreply.github.com>
Date: Mon, 25 Apr 2022 23:39:47 +0800
Subject: add lock when reading `AllowedReferences` (#38545)

---
 pilot/pkg/config/kube/gateway/controller.go | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/pilot/pkg/config/kube/gateway/controller.go b/pilot/pkg/config/kube/gateway/controller.go
index 85caf1847a..4ea7d5cfcc 100644
--- a/pilot/pkg/config/kube/gateway/controller.go
+++ b/pilot/pkg/config/kube/gateway/controller.go
@@ -298,7 +298,9 @@ func (c *Controller) SecretAllowed(resourceName string, namespace string) bool {
 	}
 	from := Reference{Kind: gvk.KubernetesGateway, Namespace: k8s.Namespace(namespace)}
 	to := Reference{Kind: gvk.Secret, Namespace: k8s.Namespace(p.Namespace)}
+	c.stateMu.RLock()
 	allow := c.state.AllowedReferences[from][to]
+	c.stateMu.RUnlock()
 	if allow == nil {
 		return false
 	}
-- 
2.35.3

