From f266bb2f8cd58797ecd823cfe543989e2f51cb08 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Tue, 30 Nov 2021 18:45:10 -0800
Subject: Add find root cert fuzzer to tests (#36309)

---
 security/pkg/pki/util/verify_cert.go                        | 6 ++++++
 tests/fuzz/oss_fuzz_build.sh                                | 2 +-
 tests/fuzz/pki_fuzzer.go                                    | 2 +-
 tests/fuzz/regression_test.go                               | 1 +
 .../6118602084843520                                        | 0
 5 files changed, 9 insertions(+), 2 deletions(-)
 create mode 100644 tests/fuzz/testdata/FuzzFindRootCertFromCertificateChainBytes/6118602084843520

diff --git a/security/pkg/pki/util/verify_cert.go b/security/pkg/pki/util/verify_cert.go
index 4da981c430..902eb6522f 100644
--- a/security/pkg/pki/util/verify_cert.go
+++ b/security/pkg/pki/util/verify_cert.go
@@ -174,6 +174,9 @@ func FindRootCertFromCertificateChainBytes(certBytes []byte) ([]byte, error) {
 		if len(certBytes) == 0 {
 			break
 		}
+		if block == nil {
+			return nil, fmt.Errorf("error decoding certificate")
+		}
 		_, err := x509.ParseCertificate(block.Bytes)
 		if err != nil {
 			return nil, fmt.Errorf("error parsing TLS certificate: %s", err.Error())
@@ -181,6 +184,9 @@ func FindRootCertFromCertificateChainBytes(certBytes []byte) ([]byte, error) {
 		cert = certBytes
 	}
 	rootBlock, _ := pem.Decode(cert)
+	if rootBlock == nil {
+		return nil, fmt.Errorf("error decoding root certificate")
+	}
 	rootCert, err := x509.ParseCertificate(rootBlock.Bytes)
 	if err != nil {
 		return nil, fmt.Errorf("error parsing root certificate: %s", err.Error())
diff --git a/tests/fuzz/oss_fuzz_build.sh b/tests/fuzz/oss_fuzz_build.sh
index 898da003a5..512696b08b 100755
--- a/tests/fuzz/oss_fuzz_build.sh
+++ b/tests/fuzz/oss_fuzz_build.sh
@@ -57,7 +57,7 @@ compile_go_fuzzer istio.io/istio/tests/fuzz FuzzParsePemEncodedCertificateChain
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzUpdateVerifiedKeyCertBundleFromFile fuzz_update_verified_cert_bundle_from_file
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzJwtUtil fuzz_jwt_util
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzVerifyCertificate fuzz_verify_certificate
-compile_go_fuzzer istio.io/istio/tests/fuzz FindRootCertFromCertificateChainBytesFuzz fuzz_find_root_cert_from_certificate_chain_bytes
+compile_go_fuzzer istio.io/istio/tests/fuzz FuzzFindRootCertFromCertificateChainBytes fuzz_find_root_cert_from_certificate_chain_bytes
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzAggregateController fuzz_aggregate_controller
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzKubeCRD fuzz_kube_crd
 compile_go_fuzzer istio.io/istio/tests/fuzz FuzzReconcileStatuses fuzz_reconcile_statuses
diff --git a/tests/fuzz/pki_fuzzer.go b/tests/fuzz/pki_fuzzer.go
index 8090780f8d..9a77405278 100644
--- a/tests/fuzz/pki_fuzzer.go
+++ b/tests/fuzz/pki_fuzzer.go
@@ -51,7 +51,7 @@ func FuzzVerifyCertificate(data []byte) int {
 
 // FindRootCertFromCertificateChainBytesFuzz implements a fuzzer
 // that tests util.FindRootCertFromCertificateChainBytes
-func FindRootCertFromCertificateChainBytesFuzz(data []byte) int {
+func FuzzFindRootCertFromCertificateChainBytes(data []byte) int {
 	_, _ = util.FindRootCertFromCertificateChainBytes(data)
 	return 1
 }
diff --git a/tests/fuzz/regression_test.go b/tests/fuzz/regression_test.go
index 94bdcbcbee..3839193a31 100644
--- a/tests/fuzz/regression_test.go
+++ b/tests/fuzz/regression_test.go
@@ -162,6 +162,7 @@ func TestFuzzers(t *testing.T) {
 		{"FuzzParsePemEncodedCertificateChain", FuzzParsePemEncodedCertificateChain},
 		{"FuzzUpdateVerifiedKeyCertBundleFromFile", FuzzUpdateVerifiedKeyCertBundleFromFile},
 		{"FuzzJwtUtil", FuzzJwtUtil},
+		{"FuzzFindRootCertFromCertificateChainBytes", FuzzFindRootCertFromCertificateChainBytes},
 	}
 	for _, tt := range cases {
 		if testedFuzzers.Contains(tt.name) {
diff --git a/tests/fuzz/testdata/FuzzFindRootCertFromCertificateChainBytes/6118602084843520 b/tests/fuzz/testdata/FuzzFindRootCertFromCertificateChainBytes/6118602084843520
new file mode 100644
index 0000000000..e69de29bb2
-- 
2.35.3

