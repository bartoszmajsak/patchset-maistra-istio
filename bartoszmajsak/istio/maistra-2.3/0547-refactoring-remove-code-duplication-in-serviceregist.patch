From 129fbba14e4039143181777e5938130086c0c354 Mon Sep 17 00:00:00 2001
From: Yaroslav Skopets <yaroslav@tetrate.io>
Date: Fri, 11 Feb 2022 18:34:52 +0100
Subject: refactoring: remove code duplication in
 `serviceregistry/serviceentry` (#37295)

Signed-off-by: Yaroslav Skopets <yaroslav@tetrate.io>
---
 pilot/pkg/serviceregistry/serviceentry/store.go | 15 ++-------------
 1 file changed, 2 insertions(+), 13 deletions(-)

diff --git a/pilot/pkg/serviceregistry/serviceentry/store.go b/pilot/pkg/serviceregistry/serviceentry/store.go
index 8a81e99813..2f60fb551d 100644
--- a/pilot/pkg/serviceregistry/serviceentry/store.go
+++ b/pilot/pkg/serviceregistry/serviceentry/store.go
@@ -71,21 +71,10 @@ func (s *serviceInstancesStore) addInstances(key configKey, instances []*model.S
 
 func (s *serviceInstancesStore) updateInstances(key configKey, instances []*model.ServiceInstance) {
 	// first delete
-	for _, i := range instances {
-		delete(s.instances[makeInstanceKey(i)], key)
-		delete(s.ip2instance, i.Endpoint.Address)
-	}
+	s.deleteInstances(key, instances)
 
 	// second add
-	for _, instance := range instances {
-		ikey := makeInstanceKey(instance)
-		if _, f := s.instances[ikey]; !f {
-			s.instances[ikey] = map[configKey][]*model.ServiceInstance{}
-		}
-		s.instances[ikey][key] = append(s.instances[ikey][key], instance)
-		s.ip2instance[instance.Endpoint.Address] = append(s.ip2instance[instance.Endpoint.Address], instance)
-
-	}
+	s.addInstances(key, instances)
 }
 
 func (s *serviceInstancesStore) getServiceEntryInstances(key types.NamespacedName) map[configKey][]*model.ServiceInstance {
-- 
2.35.3

