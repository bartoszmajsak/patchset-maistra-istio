From 0cf477a1f3c3dc86f3c4f02544b5b9826dec3496 Mon Sep 17 00:00:00 2001
From: Zhonghu Xu <xuzhonghu@huawei.com>
Date: Tue, 23 Nov 2021 01:14:57 +0800
Subject: allocate capacity in advance (#36187)

---
 pilot/pkg/model/push_context.go | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/pilot/pkg/model/push_context.go b/pilot/pkg/model/push_context.go
index e3ff76e566..ab6623f2ba 100644
--- a/pilot/pkg/model/push_context.go
+++ b/pilot/pkg/model/push_context.go
@@ -830,7 +830,10 @@ func (ps *PushContext) IsServiceVisible(service *Service, namespace string) bool
 // This replaces store.VirtualServices. Used only by the gateways
 // Sidecars use the egressListener.VirtualServices().
 func (ps *PushContext) VirtualServicesForGateway(proxy *Proxy, gateway string) []config.Config {
-	res := ps.virtualServiceIndex.privateByNamespaceAndGateway[proxy.ConfigNamespace][gateway]
+	res := make([]config.Config, 0, len(ps.virtualServiceIndex.privateByNamespaceAndGateway[proxy.ConfigNamespace][gateway])+
+		len(ps.virtualServiceIndex.exportedToNamespaceByGateway[proxy.ConfigNamespace][gateway])+
+		len(ps.virtualServiceIndex.publicByGateway[gateway]))
+	res = append(res, ps.virtualServiceIndex.privateByNamespaceAndGateway[proxy.ConfigNamespace][gateway]...)
 	res = append(res, ps.virtualServiceIndex.exportedToNamespaceByGateway[proxy.ConfigNamespace][gateway]...)
 	res = append(res, ps.virtualServiceIndex.publicByGateway[gateway]...)
 	return res
-- 
2.35.3

