From a0dec4fed8f48906f67230a7dcb2d019bd40a8eb Mon Sep 17 00:00:00 2001
From: Nathan Mittler <nmittler@gmail.com>
Date: Fri, 11 Feb 2022 13:47:00 -0800
Subject: Deprecate some test skip options for multicluster (#37300)

---
 pkg/test/framework/suite.go                                   | 4 ++++
 tests/integration/helm/main_test.go                           | 1 +
 tests/integration/helm/upgrade/main_test.go                   | 1 +
 tests/integration/operator/main_test.go                       | 1 +
 tests/integration/pilot/cni/cniversionskew_test.go            | 1 +
 tests/integration/pilot/endpointslice/endpointslice_test.go   | 1 +
 tests/integration/pilot/mcs/autoexport/autoexport_test.go     | 1 +
 tests/integration/pilot/revisioncmd/main_test.go              | 1 +
 tests/integration/pilot/revisions/revisions_test.go           | 1 +
 tests/integration/security/chiron/main_test.go                | 1 +
 tests/integration/security/external_ca/main_test.go           | 1 +
 tests/integration/security/file_mounted_certs/main_test.go    | 1 +
 .../security/filebased_tls_origination/main_test.go           | 1 +
 tests/integration/security/mtlsk8sca/main_test.go             | 1 +
 tests/integration/security/sds_egress/main_test.go            | 1 +
 tests/integration/security/sds_ingress/quic/ingress_test.go   | 1 +
 tests/integration/security/sds_ingress_k8sca/main_test.go     | 1 +
 .../telemetry/outboundtrafficpolicy/traffic_test.go           | 1 +
 tests/integration/telemetry/policy/envoy_ratelimit_test.go    | 1 +
 tests/integration/telemetry/stackdriver/vm/main_test.go       | 1 +
 20 files changed, 23 insertions(+)

diff --git a/pkg/test/framework/suite.go b/pkg/test/framework/suite.go
index eee662ecf0..b0786f73e7 100644
--- a/pkg/test/framework/suite.go
+++ b/pkg/test/framework/suite.go
@@ -95,8 +95,12 @@ type Suite interface {
 	// Otherwise it stops test execution.
 	RequireMaxClusters(maxClusters int) Suite
 	// RequireSingleCluster is a utility method that requires that there be exactly 1 cluster in the environment.
+	//
+	// Deprecated: All new tests should support multiple clusters.
 	RequireSingleCluster() Suite
 	// RequireMultiPrimary ensures that each cluster is running a control plane.
+	//
+	// Deprecated: All new tests should work for any control plane topology.
 	RequireMultiPrimary() Suite
 	// RequireMinVersion validates the environment meets a minimum version
 	RequireMinVersion(minorVersion uint) Suite
diff --git a/tests/integration/helm/main_test.go b/tests/integration/helm/main_test.go
index 1d89824a8c..27684a4841 100644
--- a/tests/integration/helm/main_test.go
+++ b/tests/integration/helm/main_test.go
@@ -24,6 +24,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireSingleCluster().
diff --git a/tests/integration/helm/upgrade/main_test.go b/tests/integration/helm/upgrade/main_test.go
index 79dfe496db..e4ce1ce704 100644
--- a/tests/integration/helm/upgrade/main_test.go
+++ b/tests/integration/helm/upgrade/main_test.go
@@ -24,6 +24,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		// Kubernetes 1.22 drops support for a number of legacy resources, so we cannot install the old versions
diff --git a/tests/integration/operator/main_test.go b/tests/integration/operator/main_test.go
index e103a7963e..8ebe5d7aa8 100644
--- a/tests/integration/operator/main_test.go
+++ b/tests/integration/operator/main_test.go
@@ -24,6 +24,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireSingleCluster().
diff --git a/tests/integration/pilot/cni/cniversionskew_test.go b/tests/integration/pilot/cni/cniversionskew_test.go
index f5875d4e0f..d61c237280 100644
--- a/tests/integration/pilot/cni/cniversionskew_test.go
+++ b/tests/integration/pilot/cni/cniversionskew_test.go
@@ -92,6 +92,7 @@ func TestCNIVersionSkew(t *testing.T) {
 }
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		Label(label.Postsubmit).
diff --git a/tests/integration/pilot/endpointslice/endpointslice_test.go b/tests/integration/pilot/endpointslice/endpointslice_test.go
index 53cae1be33..ce03096e58 100644
--- a/tests/integration/pilot/endpointslice/endpointslice_test.go
+++ b/tests/integration/pilot/endpointslice/endpointslice_test.go
@@ -38,6 +38,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireMultiPrimary().
diff --git a/tests/integration/pilot/mcs/autoexport/autoexport_test.go b/tests/integration/pilot/mcs/autoexport/autoexport_test.go
index 6fd5eb2ef0..27444d8bda 100644
--- a/tests/integration/pilot/mcs/autoexport/autoexport_test.go
+++ b/tests/integration/pilot/mcs/autoexport/autoexport_test.go
@@ -42,6 +42,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		Label(label.CustomSetup).
diff --git a/tests/integration/pilot/revisioncmd/main_test.go b/tests/integration/pilot/revisioncmd/main_test.go
index 84cfe3a641..fade61c2a6 100644
--- a/tests/integration/pilot/revisioncmd/main_test.go
+++ b/tests/integration/pilot/revisioncmd/main_test.go
@@ -27,6 +27,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		// Requires custom CP installations. Consider merging into pilot/revisions
diff --git a/tests/integration/pilot/revisions/revisions_test.go b/tests/integration/pilot/revisions/revisions_test.go
index 836d2741f4..47660975dd 100644
--- a/tests/integration/pilot/revisions/revisions_test.go
+++ b/tests/integration/pilot/revisions/revisions_test.go
@@ -37,6 +37,7 @@
 // If a test requires a custom install it should go into its own package, otherwise it should go
 // here to reuse a single install across tests.
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireMultiPrimary().
diff --git a/tests/integration/security/chiron/main_test.go b/tests/integration/security/chiron/main_test.go
index 6edd9554af..f776808476 100644
--- a/tests/integration/security/chiron/main_test.go
+++ b/tests/integration/security/chiron/main_test.go
@@ -31,6 +31,7 @@
 func TestMain(m *testing.M) {
 	// Integration test for provisioning DNS certificates.
 	// TODO (lei-tang): investigate whether this test can be moved to integration/security.
+	// nolint: staticcheck
 	framework.NewSuite(m).
 		Label(label.CustomSetup).
 		// https://github.com/istio/istio/issues/22161. 1.22 drops support for legacy-unknown signer
diff --git a/tests/integration/security/external_ca/main_test.go b/tests/integration/security/external_ca/main_test.go
index 40281b03dd..226e553843 100644
--- a/tests/integration/security/external_ca/main_test.go
+++ b/tests/integration/security/external_ca/main_test.go
@@ -77,6 +77,7 @@ func SetupApps(ctx resource.Context, apps *EchoDeployments) error {
 func TestMain(m *testing.M) {
 	// Integration test for testing interoperability with external CA's that are integrated with K8s CSR API
 	// Refer to https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/
+	// nolint: staticcheck
 	framework.NewSuite(m).
 		Label(label.CustomSetup).
 		RequireMinVersion(19).
diff --git a/tests/integration/security/file_mounted_certs/main_test.go b/tests/integration/security/file_mounted_certs/main_test.go
index c0e5cdac2e..9cc0f9e5eb 100644
--- a/tests/integration/security/file_mounted_certs/main_test.go
+++ b/tests/integration/security/file_mounted_certs/main_test.go
@@ -55,6 +55,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		Label(label.CustomSetup).
diff --git a/tests/integration/security/filebased_tls_origination/main_test.go b/tests/integration/security/filebased_tls_origination/main_test.go
index eccd23857f..6ca7c283c8 100644
--- a/tests/integration/security/filebased_tls_origination/main_test.go
+++ b/tests/integration/security/filebased_tls_origination/main_test.go
@@ -30,6 +30,7 @@
 var inst istio.Instance
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		Label(label.CustomSetup).
diff --git a/tests/integration/security/mtlsk8sca/main_test.go b/tests/integration/security/mtlsk8sca/main_test.go
index 691d22862b..038923c152 100644
--- a/tests/integration/security/mtlsk8sca/main_test.go
+++ b/tests/integration/security/mtlsk8sca/main_test.go
@@ -33,6 +33,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireSingleCluster().
diff --git a/tests/integration/security/sds_egress/main_test.go b/tests/integration/security/sds_egress/main_test.go
index 54776f06bb..e0ea653258 100644
--- a/tests/integration/security/sds_egress/main_test.go
+++ b/tests/integration/security/sds_egress/main_test.go
@@ -33,6 +33,7 @@
 )
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireSingleCluster().
diff --git a/tests/integration/security/sds_ingress/quic/ingress_test.go b/tests/integration/security/sds_ingress/quic/ingress_test.go
index 8f21e24f99..6a43436a5c 100644
--- a/tests/integration/security/sds_ingress/quic/ingress_test.go
+++ b/tests/integration/security/sds_ingress/quic/ingress_test.go
@@ -33,6 +33,7 @@
 
 func TestMain(m *testing.M) {
 	// Integration test for the ingress SDS Gateway flow.
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		// Need support for MixedProtocolLBService
diff --git a/tests/integration/security/sds_ingress_k8sca/main_test.go b/tests/integration/security/sds_ingress_k8sca/main_test.go
index 8e0eff051e..ca93834b33 100644
--- a/tests/integration/security/sds_ingress_k8sca/main_test.go
+++ b/tests/integration/security/sds_ingress_k8sca/main_test.go
@@ -34,6 +34,7 @@
 func TestMain(m *testing.M) {
 	// Integration test for the ingress SDS multiple Gateway flow when
 	// the control plane certificate provider is k8s CA.
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireSingleCluster().
diff --git a/tests/integration/telemetry/outboundtrafficpolicy/traffic_test.go b/tests/integration/telemetry/outboundtrafficpolicy/traffic_test.go
index 4c6d2967c5..8968507bba 100644
--- a/tests/integration/telemetry/outboundtrafficpolicy/traffic_test.go
+++ b/tests/integration/telemetry/outboundtrafficpolicy/traffic_test.go
@@ -31,6 +31,7 @@
 
 func TestMain(m *testing.M) {
 	var ist istio.Instance
+	// nolint: staticcheck
 	framework.NewSuite(m).
 		RequireSingleCluster().
 		Label(label.CustomSetup).
diff --git a/tests/integration/telemetry/policy/envoy_ratelimit_test.go b/tests/integration/telemetry/policy/envoy_ratelimit_test.go
index 5b5b6062bb..a7077658a2 100644
--- a/tests/integration/telemetry/policy/envoy_ratelimit_test.go
+++ b/tests/integration/telemetry/policy/envoy_ratelimit_test.go
@@ -94,6 +94,7 @@ func TestLocalRateLimitingServiceAccount(t *testing.T) {
 }
 
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		RequireSingleCluster().
diff --git a/tests/integration/telemetry/stackdriver/vm/main_test.go b/tests/integration/telemetry/stackdriver/vm/main_test.go
index 6dd615907e..1152431a2d 100644
--- a/tests/integration/telemetry/stackdriver/vm/main_test.go
+++ b/tests/integration/telemetry/stackdriver/vm/main_test.go
@@ -114,6 +114,7 @@
 // - tests/integration/pilot/vm
 // - tests/integration/telemetry/stackdriver
 func TestMain(m *testing.M) {
+	// nolint: staticcheck
 	framework.
 		NewSuite(m).
 		// https://github.com/istio/istio/issues/35923. Since IPv6 has no external connectivity, we are "not on GCP"
-- 
2.35.3

