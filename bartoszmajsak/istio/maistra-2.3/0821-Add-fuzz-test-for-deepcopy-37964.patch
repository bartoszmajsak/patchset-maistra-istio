From 17fef9094acca0c7828172ebf12cc7d62c90a7f8 Mon Sep 17 00:00:00 2001
From: Zhonghu Xu <xuzhonghu@huawei.com>
Date: Wed, 16 Mar 2022 19:38:33 +0800
Subject: Add fuzz test for deepcopy (#37964)

---
 pilot/pkg/model/addressmap.go   |  6 +++++-
 pilot/pkg/model/service.go      | 12 ++++++++----
 pilot/pkg/model/service_test.go | 17 +++++++++++++++++
 3 files changed, 30 insertions(+), 5 deletions(-)

diff --git a/pilot/pkg/model/addressmap.go b/pilot/pkg/model/addressmap.go
index 608a6b973c..63f091bea4 100644
--- a/pilot/pkg/model/addressmap.go
+++ b/pilot/pkg/model/addressmap.go
@@ -62,7 +62,11 @@ func (m *AddressMap) GetAddresses() map[cluster.ID][]string {
 
 	out := make(map[cluster.ID][]string)
 	for k, v := range m.Addresses {
-		out[k] = append([]string{}, v...)
+		if v == nil {
+			out[k] = nil
+		} else {
+			out[k] = append([]string{}, v...)
+		}
 	}
 	return out
 }
diff --git a/pilot/pkg/model/service.go b/pilot/pkg/model/service.go
index 4a046d20af..16b4382f55 100644
--- a/pilot/pkg/model/service.go
+++ b/pilot/pkg/model/service.go
@@ -832,10 +832,14 @@ func (s *Service) DeepCopy() *Service {
 	if s.Ports != nil {
 		out.Ports = make(PortList, len(s.Ports))
 		for i, port := range s.Ports {
-			out.Ports[i] = &Port{
-				Name:     port.Name,
-				Port:     port.Port,
-				Protocol: port.Protocol,
+			if port != nil {
+				out.Ports[i] = &Port{
+					Name:     port.Name,
+					Port:     port.Port,
+					Protocol: port.Protocol,
+				}
+			} else {
+				out.Ports[i] = nil
 			}
 		}
 	}
diff --git a/pilot/pkg/model/service_test.go b/pilot/pkg/model/service_test.go
index f2bcdadc44..ec90024ae0 100644
--- a/pilot/pkg/model/service_test.go
+++ b/pilot/pkg/model/service_test.go
@@ -15,8 +15,13 @@
 package model
 
 import (
+	"reflect"
 	"testing"
 
+	"github.com/google/go-cmp/cmp"
+	"github.com/google/go-cmp/cmp/cmpopts"
+	fuzz "github.com/google/gofuzz"
+
 	"istio.io/istio/pkg/cluster"
 	"istio.io/istio/pkg/config/host"
 	"istio.io/istio/pkg/config/labels"
@@ -293,3 +298,15 @@ func BenchmarkServiceDeepCopy(b *testing.B) {
 		_ = svc1.DeepCopy()
 	}
 }
+
+func TestFuzzServiceDeepCopy(t *testing.T) {
+	fuzzer := fuzz.New()
+	originalSvc := &Service{}
+	fuzzer.Fuzz(originalSvc)
+	copied := originalSvc.DeepCopy()
+	if !reflect.DeepEqual(originalSvc, copied) {
+		cmp.AllowUnexported()
+		diff := cmp.Diff(originalSvc, copied, cmp.AllowUnexported(), cmpopts.IgnoreFields(AddressMap{}, "mutex"))
+		t.Errorf("unexpected diff %v", diff)
+	}
+}
-- 
2.35.3

