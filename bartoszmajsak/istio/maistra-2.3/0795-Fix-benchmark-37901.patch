From dac4c97a792a6fc362165b6385429413d90793f1 Mon Sep 17 00:00:00 2001
From: Zhonghu Xu <xuzhonghu@huawei.com>
Date: Tue, 15 Mar 2022 06:42:39 +0800
Subject: Fix benchmark (#37901)

---
 .../serviceentry/servicediscovery_test.go                | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/pilot/pkg/serviceregistry/serviceentry/servicediscovery_test.go b/pilot/pkg/serviceregistry/serviceentry/servicediscovery_test.go
index abf3d55d57..a136677ebe 100644
--- a/pilot/pkg/serviceregistry/serviceentry/servicediscovery_test.go
+++ b/pilot/pkg/serviceregistry/serviceentry/servicediscovery_test.go
@@ -1556,6 +1556,9 @@ func TestWorkloadEntryOnlyMode(t *testing.T) {
 
 func BenchmarkServiceEntryHandler(b *testing.B) {
 	_, sd := initServiceDiscoveryWithoutEvents(b)
+	stopCh := make(chan struct{})
+	go sd.Run(stopCh)
+	defer close(stopCh)
 	for i := 0; i < b.N; i++ {
 		sd.serviceEntryHandler(config.Config{}, *httpDNS, model.EventAdd)
 		sd.serviceEntryHandler(config.Config{}, *httpDNSRR, model.EventAdd)
@@ -1571,6 +1574,9 @@ func BenchmarkServiceEntryHandler(b *testing.B) {
 
 func BenchmarkWorkloadInstanceHandler(b *testing.B) {
 	store, sd := initServiceDiscoveryWithoutEvents(b)
+	stopCh := make(chan struct{})
+	go sd.Run(stopCh)
+	defer close(stopCh)
 	// Add just the ServiceEntry with selector. We should see no instances
 	createConfigs([]*config.Config{selector, dnsSelector}, store, b)
 
@@ -1640,6 +1646,9 @@ func BenchmarkWorkloadEntryHandler(b *testing.B) {
 		})
 
 	store, sd := initServiceDiscoveryWithoutEvents(b)
+	stopCh := make(chan struct{})
+	go sd.Run(stopCh)
+	defer close(stopCh)
 	// Add just the ServiceEntry with selector. We should see no instances
 	createConfigs([]*config.Config{selector}, store, b)
 
-- 
2.35.3

