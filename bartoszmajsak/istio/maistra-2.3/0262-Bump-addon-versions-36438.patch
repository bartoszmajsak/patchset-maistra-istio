From a3549e2a7cb14040c4b02140cc010d226ee3aeb1 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Wed, 15 Dec 2021 03:35:23 -0800
Subject: Bump addon versions (#36438)

* Bump addon versions

* Adopt to https://github.com/prometheus-community/helm-charts/commit/df8add6a684501ca655c5162890f7e15aa7afc72
---
 manifests/addons/gen.sh                       |  6 +-
 samples/addons/grafana.yaml                   | 20 ++---
 samples/addons/kiali.yaml                     | 89 +++++++++++--------
 samples/addons/prometheus.yaml                | 54 ++++++-----
 .../telemetry/stats/prometheus/stats.go       |  2 +-
 5 files changed, 101 insertions(+), 70 deletions(-)

diff --git a/manifests/addons/gen.sh b/manifests/addons/gen.sh
index 8c0dd20962..5e103e97a9 100755
--- a/manifests/addons/gen.sh
+++ b/manifests/addons/gen.sh
@@ -30,7 +30,7 @@ TMP=$(mktemp -d)
 {
 helm3 template kiali-server \
   --namespace istio-system \
-  --version 1.42.0 \
+  --version 1.44.0 \
   --include-crds \
   --set nameOverride=kiali \
   --set fullnameOverride=kiali \
@@ -42,7 +42,7 @@ helm3 template kiali-server \
 # Set up prometheus
 helm3 template prometheus prometheus \
   --namespace istio-system \
-  --version 14.6.1 \
+  --version 15.0.1 \
   --repo https://prometheus-community.github.io/helm-charts \
   -f "${WD}/values-prometheus.yaml" \
   > "${ADDONS}/prometheus.yaml"
@@ -55,7 +55,7 @@ function compressDashboard() {
 {
   helm3 template grafana grafana \
     --namespace istio-system \
-    --version 6.16.6 \
+    --version 6.18.2 \
     --repo https://grafana.github.io/helm-charts \
     -f "${WD}/values-grafana.yaml"
 
diff --git a/samples/addons/grafana.yaml b/samples/addons/grafana.yaml
index 7d3fa9c27f..f3a03dfaf0 100644
--- a/samples/addons/grafana.yaml
+++ b/samples/addons/grafana.yaml
@@ -4,10 +4,10 @@ apiVersion: v1
 kind: ServiceAccount
 metadata:
   labels:
-    helm.sh/chart: grafana-6.16.6
+    helm.sh/chart: grafana-6.18.2
     app.kubernetes.io/name: grafana
     app.kubernetes.io/instance: grafana
-    app.kubernetes.io/version: "8.1.2"
+    app.kubernetes.io/version: "8.3.1"
     app.kubernetes.io/managed-by: Helm
   name: grafana
   namespace: istio-system
@@ -19,10 +19,10 @@ metadata:
   name: grafana
   namespace: istio-system
   labels:
-    helm.sh/chart: grafana-6.16.6
+    helm.sh/chart: grafana-6.18.2
     app.kubernetes.io/name: grafana
     app.kubernetes.io/instance: grafana
-    app.kubernetes.io/version: "8.1.2"
+    app.kubernetes.io/version: "8.3.1"
     app.kubernetes.io/managed-by: Helm
 data:
   grafana.ini: |
@@ -75,10 +75,10 @@ metadata:
   name: grafana
   namespace: istio-system
   labels:
-    helm.sh/chart: grafana-6.16.6
+    helm.sh/chart: grafana-6.18.2
     app.kubernetes.io/name: grafana
     app.kubernetes.io/instance: grafana
-    app.kubernetes.io/version: "8.1.2"
+    app.kubernetes.io/version: "8.3.1"
     app.kubernetes.io/managed-by: Helm
 spec:
   type: ClusterIP
@@ -99,10 +99,10 @@ metadata:
   name: grafana
   namespace: istio-system
   labels:
-    helm.sh/chart: grafana-6.16.6
+    helm.sh/chart: grafana-6.18.2
     app.kubernetes.io/name: grafana
     app.kubernetes.io/instance: grafana
-    app.kubernetes.io/version: "8.1.2"
+    app.kubernetes.io/version: "8.3.1"
     app.kubernetes.io/managed-by: Helm
 spec:
   replicas: 1
@@ -121,7 +121,7 @@ spec:
         app: grafana
         sidecar.istio.io/inject: "false"
       annotations:
-        checksum/config: 0db0166dec9b75eb6486494512ab843bc085e0806457bc09e92597a418a115ae
+        checksum/config: b09dc3addb625f8b5744b94f7ab624a3b02fdfd16aad7e4294a5fbf3608cb129
         checksum/dashboards-json-config: 01ba4719c80b6fe911b091a7c05124b64eeece964e09c058ef8f9805daca546b
         checksum/sc-dashboard-provider-config: 01ba4719c80b6fe911b091a7c05124b64eeece964e09c058ef8f9805daca546b
     spec:
@@ -135,7 +135,7 @@ spec:
       enableServiceLinks: true
       containers:
         - name: grafana
-          image: "grafana/grafana:8.1.2"
+          image: "grafana/grafana:8.3.1"
           imagePullPolicy: IfNotPresent
           volumeMounts:
             - name: config
diff --git a/samples/addons/kiali.yaml b/samples/addons/kiali.yaml
index bbe7c44280..ac906a6fce 100644
--- a/samples/addons/kiali.yaml
+++ b/samples/addons/kiali.yaml
@@ -6,12 +6,12 @@ metadata:
   name: kiali
   namespace: istio-system
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 ...
@@ -23,12 +23,12 @@ metadata:
   name: kiali
   namespace: istio-system
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 data:
@@ -46,6 +46,7 @@ data:
         node: {}
         pod: {}
         pod_anti: {}
+      custom_secrets: []
       host_aliases: []
       hpa:
         api_version: autoscaling/v2beta2
@@ -55,6 +56,11 @@ data:
       image_pull_policy: Always
       image_pull_secrets: []
       image_version: v1.42
+      ingress:
+        additional_labels: {}
+        class_name: nginx
+        override_yaml:
+          metadata: {}
       ingress_enabled: false
       instance_name: kiali
       logger:
@@ -64,23 +70,28 @@ data:
         time_field_format: 2006-01-02T15:04:05Z07:00
       namespace: istio-system
       node_selector: {}
-      override_ingress_yaml:
-        metadata: {}
       pod_annotations: {}
       pod_labels:
         sidecar.istio.io/inject: "false"
       priority_class_name: ""
       replicas: 1
-      resources: {}
+      resources:
+        limits:
+          memory: 1Gi
+        requests:
+          cpu: 10m
+          memory: 64Mi
       secret_name: kiali
       service_annotations: {}
       service_type: ""
       tolerations: []
-      version_label: v1.42.0
+      version_label: v1.44.0
       view_only_mode: false
     external_services:
       custom_dashboards:
         enabled: true
+      istio:
+        root_namespace: istio-system
     identity:
       cert_file: ""
       private_key_file: ""
@@ -108,12 +119,12 @@ kind: ClusterRole
 metadata:
   name: kiali-viewer
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 rules:
@@ -205,12 +216,12 @@ kind: ClusterRole
 metadata:
   name: kiali
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 rules:
@@ -312,12 +323,12 @@ kind: ClusterRoleBinding
 metadata:
   name: kiali
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 roleRef:
@@ -337,12 +348,12 @@ metadata:
   name: kiali-controlplane
   namespace: istio-system
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 rules:
@@ -370,12 +381,12 @@ metadata:
   name: kiali-controlplane
   namespace: istio-system
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 roleRef:
@@ -395,12 +406,12 @@ metadata:
   name: kiali
   namespace: istio-system
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
   annotations:
@@ -424,12 +435,12 @@ metadata:
   name: kiali
   namespace: istio-system
   labels:
-    helm.sh/chart: kiali-server-1.42.0
+    helm.sh/chart: kiali-server-1.44.0
     app: kiali
     app.kubernetes.io/name: kiali
     app.kubernetes.io/instance: kiali
-    version: "v1.42.0"
-    app.kubernetes.io/version: "v1.42.0"
+    version: "v1.44.0"
+    app.kubernetes.io/version: "v1.44.0"
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/part-of: "kiali"
 spec:
@@ -447,17 +458,17 @@ spec:
     metadata:
       name: kiali
       labels:
-        helm.sh/chart: kiali-server-1.42.0
+        helm.sh/chart: kiali-server-1.44.0
         app: kiali
         app.kubernetes.io/name: kiali
         app.kubernetes.io/instance: kiali
-        version: "v1.42.0"
-        app.kubernetes.io/version: "v1.42.0"
+        version: "v1.44.0"
+        app.kubernetes.io/version: "v1.44.0"
         app.kubernetes.io/managed-by: Helm
         app.kubernetes.io/part-of: "kiali"
         sidecar.istio.io/inject: "false"
       annotations:
-        checksum/config: b31bec684f9bd4f948204b8c379ba871227a4193ddf6066efa3dc4cb19d3ae13
+        checksum/config: c3772da766b94abe8269b6eaed2ecb03d1c1b6d5243f3b21f892de4590f2e360
         prometheus.io/scrape: "true"
         prometheus.io/port: "9090"
         kiali.io/dashboards: go,kiali
@@ -505,7 +516,7 @@ spec:
         - name: LOG_FORMAT
           value: "text"
         - name: LOG_TIME_FIELD_FORMAT
-          value: "2006-01-02T15:04:05Z07:00" 
+          value: "2006-01-02T15:04:05Z07:00"
         - name: LOG_SAMPLER_RATE
           value: "1"
         volumeMounts:
@@ -517,6 +528,12 @@ spec:
           mountPath: "/kiali-secret"
         - name: kiali-cabundle
           mountPath: "/kiali-cabundle"
+        resources:
+          limits:
+            memory: 1Gi
+          requests:
+            cpu: 10m
+            memory: 64Mi
       volumes:
       - name: kiali-configuration
         configMap:
diff --git a/samples/addons/prometheus.yaml b/samples/addons/prometheus.yaml
index c3158d38a6..283cc0ee11 100644
--- a/samples/addons/prometheus.yaml
+++ b/samples/addons/prometheus.yaml
@@ -7,7 +7,7 @@ metadata:
     component: "server"
     app: prometheus
     release: prometheus
-    chart: prometheus-14.6.1
+    chart: prometheus-15.0.1
     heritage: Helm
   name: prometheus
   namespace: istio-system
@@ -22,7 +22,7 @@ metadata:
     component: "server"
     app: prometheus
     release: prometheus
-    chart: prometheus-14.6.1
+    chart: prometheus-15.0.1
     heritage: Helm
   name: prometheus
   namespace: istio-system
@@ -122,20 +122,23 @@ data:
         - __address__
         - __meta_kubernetes_service_annotation_prometheus_io_port
         target_label: __address__
+      - action: labelmap
+        regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)
+        replacement: __param_$1
       - action: labelmap
         regex: __meta_kubernetes_service_label_(.+)
       - action: replace
         source_labels:
         - __meta_kubernetes_namespace
-        target_label: kubernetes_namespace
+        target_label: namespace
       - action: replace
         source_labels:
         - __meta_kubernetes_service_name
-        target_label: kubernetes_name
+        target_label: service
       - action: replace
         source_labels:
         - __meta_kubernetes_pod_node_name
-        target_label: kubernetes_node
+        target_label: node
     - job_name: kubernetes-service-endpoints-slow
       kubernetes_sd_configs:
       - role: endpoints
@@ -161,20 +164,23 @@ data:
         - __address__
         - __meta_kubernetes_service_annotation_prometheus_io_port
         target_label: __address__
+      - action: labelmap
+        regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)
+        replacement: __param_$1
       - action: labelmap
         regex: __meta_kubernetes_service_label_(.+)
       - action: replace
         source_labels:
         - __meta_kubernetes_namespace
-        target_label: kubernetes_namespace
+        target_label: namespace
       - action: replace
         source_labels:
         - __meta_kubernetes_service_name
-        target_label: kubernetes_name
+        target_label: service
       - action: replace
         source_labels:
         - __meta_kubernetes_pod_node_name
-        target_label: kubernetes_node
+        target_label: node
       scrape_interval: 5m
       scrape_timeout: 30s
     - honor_labels: true
@@ -210,10 +216,10 @@ data:
         regex: __meta_kubernetes_service_label_(.+)
       - source_labels:
         - __meta_kubernetes_namespace
-        target_label: kubernetes_namespace
+        target_label: namespace
       - source_labels:
         - __meta_kubernetes_service_name
-        target_label: kubernetes_name
+        target_label: service
     - job_name: kubernetes-pods
       kubernetes_sd_configs:
       - role: pod
@@ -239,16 +245,19 @@ data:
         - __address__
         - __meta_kubernetes_pod_annotation_prometheus_io_port
         target_label: __address__
+      - action: labelmap
+        regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)
+        replacement: __param_$1
       - action: labelmap
         regex: __meta_kubernetes_pod_label_(.+)
       - action: replace
         source_labels:
         - __meta_kubernetes_namespace
-        target_label: kubernetes_namespace
+        target_label: namespace
       - action: replace
         source_labels:
         - __meta_kubernetes_pod_name
-        target_label: kubernetes_pod_name
+        target_label: pod
       - action: drop
         regex: Pending|Succeeded|Failed|Completed
         source_labels:
@@ -278,16 +287,19 @@ data:
         - __address__
         - __meta_kubernetes_pod_annotation_prometheus_io_port
         target_label: __address__
+      - action: labelmap
+        regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)
+        replacement: __param_$1
       - action: labelmap
         regex: __meta_kubernetes_pod_label_(.+)
       - action: replace
         source_labels:
         - __meta_kubernetes_namespace
-        target_label: kubernetes_namespace
+        target_label: namespace
       - action: replace
         source_labels:
         - __meta_kubernetes_pod_name
-        target_label: kubernetes_pod_name
+        target_label: pod
       - action: drop
         regex: Pending|Succeeded|Failed|Completed
         source_labels:
@@ -307,7 +319,7 @@ metadata:
     component: "server"
     app: prometheus
     release: prometheus
-    chart: prometheus-14.6.1
+    chart: prometheus-15.0.1
     heritage: Helm
   name: prometheus
 rules:
@@ -349,7 +361,7 @@ metadata:
     component: "server"
     app: prometheus
     release: prometheus
-    chart: prometheus-14.6.1
+    chart: prometheus-15.0.1
     heritage: Helm
   name: prometheus
 subjects:
@@ -369,7 +381,7 @@ metadata:
     component: "server"
     app: prometheus
     release: prometheus
-    chart: prometheus-14.6.1
+    chart: prometheus-15.0.1
     heritage: Helm
   name: prometheus
   namespace: istio-system
@@ -394,7 +406,7 @@ metadata:
     component: "server"
     app: prometheus
     release: prometheus
-    chart: prometheus-14.6.1
+    chart: prometheus-15.0.1
     heritage: Helm
   name: prometheus
   namespace: istio-system
@@ -411,7 +423,7 @@ spec:
         component: "server"
         app: prometheus
         release: prometheus
-        chart: prometheus-14.6.1
+        chart: prometheus-15.0.1
         heritage: Helm
         
         sidecar.istio.io/inject: "false"
@@ -433,7 +445,7 @@ spec:
               readOnly: true
 
         - name: prometheus-server
-          image: "prom/prometheus:v2.26.0"
+          image: "prom/prometheus:v2.31.1"
           imagePullPolicy: "IfNotPresent"
           args:
             - --storage.tsdb.retention.time=15d
@@ -448,6 +460,7 @@ spec:
             httpGet:
               path: /-/ready
               port: 9090
+              scheme: HTTP
             initialDelaySeconds: 0
             periodSeconds: 5
             timeoutSeconds: 4
@@ -457,6 +470,7 @@ spec:
             httpGet:
               path: /-/healthy
               port: 9090
+              scheme: HTTP
             initialDelaySeconds: 30
             periodSeconds: 15
             timeoutSeconds: 10
diff --git a/tests/integration/telemetry/stats/prometheus/stats.go b/tests/integration/telemetry/stats/prometheus/stats.go
index 42fb59c3b3..c8a0a3f76a 100644
--- a/tests/integration/telemetry/stats/prometheus/stats.go
+++ b/tests/integration/telemetry/stats/prometheus/stats.go
@@ -364,7 +364,7 @@ func BuildQueryCommon(labels map[string]string, ns string) (sourceQuery, destina
 	}
 	sourceQuery += "}"
 	destinationQuery += "}"
-	appQuery += `istio_echo_http_requests_total{kubernetes_namespace="` + ns + `"}`
+	appQuery += `istio_echo_http_requests_total{namespace="` + ns + `"}`
 	return
 }
 
-- 
2.35.3

