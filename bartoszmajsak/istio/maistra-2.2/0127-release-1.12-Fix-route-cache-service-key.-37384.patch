From 56db160368768dacb6ec0950b6e50cc449b65c20 Mon Sep 17 00:00:00 2001
From: Istio Automation <istio-testing-bot@google.com>
Date: Wed, 16 Feb 2022 13:43:05 -0800
Subject: [release-1.12] Fix route cache service key. (#37384)

* Fix route cache service key.

* fix

* update.

Co-authored-by: Pengyuan Bian <bianpengyuan@google.com>
---
 pilot/pkg/networking/core/v1alpha3/httproute.go | 3 ++-
 releasenotes/notes/37356.yaml                   | 9 +++++++++
 2 files changed, 11 insertions(+), 1 deletion(-)
 create mode 100644 releasenotes/notes/37356.yaml

diff --git a/pilot/pkg/networking/core/v1alpha3/httproute.go b/pilot/pkg/networking/core/v1alpha3/httproute.go
index dfd03dbdbc..9a9f2f38cb 100644
--- a/pilot/pkg/networking/core/v1alpha3/httproute.go
+++ b/pilot/pkg/networking/core/v1alpha3/httproute.go
@@ -262,6 +262,7 @@ func BuildSidecarOutboundVirtualHosts(node *model.Proxy, push *model.PushContext
 				Resolution:     svc.Resolution,
 				Ports:          []*model.Port{svcPort},
 				Attributes: model.ServiceAttributes{
+					Namespace:       svc.Attributes.Namespace,
 					ServiceRegistry: svc.Attributes.ServiceRegistry,
 				},
 			}
@@ -306,7 +307,7 @@ func BuildSidecarOutboundVirtualHosts(node *model.Proxy, push *model.PushContext
 	virtualHostWrappers := istio_route.BuildSidecarVirtualHostWrapper(routeCache, node, push, servicesByName, virtualServices, listenerPort)
 
 	resource, exist := xdsCache.Get(routeCache)
-	if exist {
+	if exist && !features.EnableUnsafeAssertions {
 		return nil, resource, routeCache
 	}
 
diff --git a/releasenotes/notes/37356.yaml b/releasenotes/notes/37356.yaml
new file mode 100644
index 0000000000..cb016e2e57
--- /dev/null
+++ b/releasenotes/notes/37356.yaml
@@ -0,0 +1,9 @@
+apiVersion: release-notes/v2
+kind: bug-fix
+area: traffic-management
+issue:
+  - https://github.com/istio/istio/pull/37356
+releaseNotes:
+  - |
+    **Fixed** an issue where service update does not trigger route update.
+
-- 
2.35.3

